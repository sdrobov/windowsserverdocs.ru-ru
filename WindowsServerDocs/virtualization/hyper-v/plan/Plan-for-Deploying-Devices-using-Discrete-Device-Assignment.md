---
title: Планирование развертывания устройств с помощью дискретного назначения устройств
description: Узнайте, как работает ДДА в Windows Server
ms.prod: windows-server
ms.technology: hyper-v
ms.topic: article
author: chrishuybregts
ms.author: chrihu
ms.date: 08/21/2019
ms.openlocfilehash: 9cc9614524c424398df550351aa2abfa7d173d43
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80856097"
---
# <a name="plan-for-deploying-devices-using-discrete-device-assignment"></a>Планирование развертывания устройств с помощью дискретного назначения устройств
>Область применения: Microsoft Hyper-V Server 2016, Windows Server 2016, Microsoft Hyper-V Server 2019, Windows Server 2019

Отдельное назначение устройств обеспечивает прямой доступ к физическому оборудованию PCIe из виртуальной машины.  В этом разделе обсуждаются типы устройств, которые могут использовать дискретное назначение устройств, требования к системе узла, ограничения, накладываемые на виртуальные машины, а также влияние отдельных назначений устройств на безопасность.

Для начального выпуска назначения отдельных устройств мы работаем над двумя классами устройств, которые формально поддерживаются корпорацией Майкрософт: графическими адаптерами и устройствами хранения NVMe.  Другие устройства, скорее всего, работают и производители оборудования могут предлагать поддержку этих устройств.  Для этих устройств вы можете обратиться к этим поставщикам оборудования за поддержкой.

Дополнительные сведения о других методах виртуализации GPU см. [в разделе Планирование ускорения GPU в Windows Server](plan-for-gpu-acceleration-in-windows-server.md). Если вы готовы испытать дискретное назначение устройств, вы можете перейти к [развертыванию графических устройств с помощью дискретного назначения устройств](../deploy/Deploying-graphics-devices-using-dda.md) или [путем развертывания устройств хранения с помощью дискретного назначения устройств](../deploy/Deploying-storage-devices-using-dda.md) , чтобы приступить к работе.

## <a name="supported-virtual-machines-and-guest-operating-systems"></a>Поддерживаемые виртуальные машины и гостевые операционные системы
Для виртуальных машин поколения 1 или 2 поддерживается отдельное назначение устройств.  Кроме того, в число поддерживаемых гостей входят Windows 10, Windows Server 2019, Windows Server 2016, Windows Server 2012 R2 с применением [KB 3133690](https://support.microsoft.com/kb/3133690) и различные дистрибутивы [ОС Linux.](../supported-linux-and-freebsd-virtual-machines-for-hyper-v-on-windows.md)

## <a name="system-requirements"></a>Требования к системе
Помимо [системных требований для Windows Server](../../../get-started/System-Requirements--and-Installation.md) и [требований к системе для Hyper-V, для](../System-requirements-for-Hyper-V-on-Windows.md)назначения дискретного устройства требуется оборудование класса сервера, которое может предоставить управление операционной системой для настройки структуры PCIe (встроенного управления PCI Express). Кроме того, в случае сложности с корнем PCIe необходимо поддерживать "службы контроля доступа" (ACS), что позволяет Hyper-V принудительно выполнять весь трафик PCIe через ММУ ввода-вывода.

Эти возможности обычно не предоставляются непосредственно в BIOS сервера и часто скрываются за другими параметрами.  Например, для поддержки SR-IOV требуются те же возможности, что и в BIOS. возможно, потребуется установить флажок "включить SR-IOV".  Если вы не можете определить правильный параметр в BIOS, обратитесь к поставщику системы.

Чтобы обеспечить оборудование, которое может использовать оборудование для дискретного назначения устройств, наши инженеры составили [сценарий профиля компьютера](#machine-profile-script) , который можно запустить на узле с поддержкой Hyper-V, чтобы проверить, правильно ли настроен сервер и какие устройства поддерживают отдельное назначение устройств.

## <a name="device-requirements"></a>Требования к устройствам
Не каждое устройство PCIe можно использовать с назначением дискретного устройства.  Например, старые устройства, использующие прерывания PCI прежних версий (Инткс), не поддерживаются. В записи [блога](https://blogs.technet.microsoft.com/virtualization/2015/11/20/discrete-device-assignment-machines-and-devices/) Жаке ошин больше подробностей. Тем не менее, для потребителя, на котором выполняется [сценарий профиля компьютера](#machine-profile-script) , отображаются устройства, которые могут использоваться для назначения отдельных устройств.

Для получения дополнительных сведений изготовители устройств могут обратиться к своему представителям корпорации Майкрософт.

## <a name="device-driver"></a>Драйвер устройства
Как отдельное назначение устройств передает все устройство PCIe в гостевую виртуальную машину, драйвер узла не требуется устанавливать до монтирования устройства в виртуальной машине.  Единственное требование на узле состоит в том, что можно определить [путь расположения PCIe](#pcie-location-path) устройства.  Драйвер устройства можно также установить, если это помогает идентифицировать устройство.  Например, GPU, не имеющий установленного на узле драйвера устройства, может отображаться как устройство отрисовки Microsoft Basic.  Если установлен драйвер устройства, то, скорее всего, будет отображаться его производитель и модель.

После подключения устройства в гостевой системе драйвер изготовителя устройства теперь может быть установлен как нормальный на гостевой виртуальной машине.  

## <a name="virtual-machine-limitations"></a>Ограничения виртуальной машины
Из-за особенностей реализации дискретного назначения устройств некоторые функции виртуальной машины ограничены, пока подключено устройство.  Следующие функции недоступны.
- Сохранение и восстановление виртуальной машины
- Динамическая миграция виртуальной машины
- Использование динамической памяти
- Добавление виртуальной машины в высокодоступный кластер (HA)

## <a name="security"></a>Безопасность
Отдельное назначение устройства передает все устройство в виртуальную машину.  Это означает, что все возможности этого устройства доступны из операционной системы на виртуальной машине. Некоторые возможности, например обновление встроенного по, могут негативно сказаться на стабильности системы. Таким образом, при отключении устройства от узла администратору предоставляются многочисленные предупреждения. Мы настоятельно рекомендуем использовать дискретное назначение устройств только в том случае, если клиенты виртуальных машин являются доверенными.  

Если администратор хочет использовать устройство с недоверенным клиентом, мы предоставили изготовителям устройств возможность создания драйвера для устранения рисков устройств, который можно установить на узле.  Обратитесь к изготовителю устройства за сведениями о том, предоставляют ли они драйвер для защиты устройств.

Если вы хотите обойти проверку безопасности для устройства, не имеющего драйвера для защиты устройств, необходимо передать параметр `-Force` в командлет `Dismount-VMHostAssignableDevice`.  Чтобы понять, как это сделать, вы изменили профиль безопасности этой системы, и это рекомендуется делать только во время создания прототипов или доверенных сред.

## <a name="pcie-location-path"></a>Путь к расположению PCIe
Для отключения и подключения устройства к узлу требуется путь к расположению PCIe.  Пример пути к расположению выглядит следующим образом: `"PCIROOT(20)#PCI(0300)#PCI(0000)#PCI(0800)#PCI(0000)"`.   [Сценарий профиля компьютера](#machine-profile-script) также будет возвращать путь к расположению устройства PCIe.

### <a name="getting-the-location-path-by-using-device-manager"></a>Получение пути к расположению с помощью Device Manager
![Диспетчер устройств](../deploy/media/dda-devicemanager.png)
- Откройте Device Manager и выберите устройство.  
- Щелкните устройство правой кнопкой мыши и выберите "Свойства".
- Перейдите на вкладку сведения и в раскрывающемся списке свойств выберите "пути расположения".  
- Щелкните правой кнопкой мыши запись, которая начинается с "ПЦИРУТ", и выберите "Копировать".  Теперь у вас есть путь к расположению для этого устройства.

## <a name="mmio-space"></a>Пространство MMIO
Некоторым устройствам, особенно GPU, требуется выделить дополнительное пространство MMIO для виртуальной машины, чтобы память этого устройства была доступна. По умолчанию каждая виртуальная машина запускается с 128 МБ свободного пространства MMIO и 512 МБ высокого уровня MMIO, выделенной для него. Однако для устройства может потребоваться больше пространства MMIO, или же может быть передано несколько устройств, так что Объединенные требования превышают эти значения.  Изменение пространства MMIO осуществляется прямо вперед и может выполняться в PowerShell с помощью следующих команд:

```PowerShell
Set-VM -LowMemoryMappedIoSpace 3Gb -VMName $vm
Set-VM -HighMemoryMappedIoSpace 33280Mb -VMName $vm
```

Самый простой способ определить, сколько пространства MMIO нужно выделить, — использовать [сценарий профиля компьютера](#machine-profile-script). Чтобы скачать и запустить сценарий профиля компьютера, выполните следующие команды в консоли PowerShell:

```PowerShell
curl -o SurveyDDA.ps1 https://raw.githubusercontent.com/MicrosoftDocs/Virtualization-Documentation/live/hyperv-tools/DiscreteDeviceAssignment/SurveyDDA.ps1
.\SurveyDDA.ps1
```

Для устройств, которые могут быть назначены, скрипт будет отображать требования к MMIO для данного устройства, как в примере ниже:

```PowerShell
NVIDIA GRID K520
Express Endpoint -- more secure.
    ...
    And it requires at least: 176 MB of MMIO gap space
...
```

Небольшое пространство MMIO используется только в 32-разрядных операционных системах и устройствах, использующих 32-разрядные адреса. В большинстве случаев установка максимального пространства MMIO виртуальной машины будет достаточно, так как 32-разрядные конфигурации не очень распространены.

> [!IMPORTANT]
> При назначении пространства MMIO виртуальной машине пользователю необходимо убедиться, что в поле MMIO указано значение сумма запрошенного пространства MMIO для всех требуемых назначенных устройств, а также дополнительный буфер, если есть другие виртуальные устройства, для которых требуется несколько МБ пространства MMIO. Используйте значения MMIO по умолчанию, описанные выше, в качестве буфера для нижнего и верхнего значений MMIO (128 МБ и 512 МБ соответственно).

Если пользователю необходимо назначить один GPU K520, как в приведенном выше примере, необходимо задать для пространства MMIO виртуальной машины значение, выводимое сценарием профиля компьютера, плюс буфер — 176 МБ + 512 МБ. Если пользователю было назначено три GPU K520, они должны задать для пространства MMIO значение в три раза 176 Мб плюс буфер или 528 МБ + 512 МБ.

Более подробные сведения о пространстве MMIO см. в разделе [дискретное назначение устройств — GPU](https://techcommunity.microsoft.com/t5/Virtualization/Discrete-Device-Assignment-GPUs/ba-p/382266) в блоге течкоммунити.

## <a name="machine-profile-script"></a>Сценарий профиля компьютера
Чтобы упростить определение правильности настройки сервера и доступность устройств, доступных для передачи с помощью дискретного назначения устройств, один из наших инженеров объединяет следующий сценарий PowerShell: [сурвэйдда. ps1.](https://github.com/Microsoft/Virtualization-Documentation/blob/live/hyperv-tools/DiscreteDeviceAssignment/SurveyDDA.ps1)

Перед использованием скрипта убедитесь, что установлена роль Hyper-V, и запустите сценарий из командного окна PowerShell с правами администратора.

Если система неправильно настроена для поддержки дискретного назначения устройств, средство отобразит сообщение об ошибке, в котором будет указано, что именно не так. Если средство обнаружит, что система настроена правильно, будет выполнена перечисление всех устройств, которые она может найти на шине PCIe.

Для каждого обнаруженного устройства средство отобразит, можно ли использовать его с отдельным назначением устройств. Если устройство определяется как совместимое с назначением дискретного устройства, сценарий предоставит причину.  Если устройство успешно идентифицировано как совместимое, будет отображаться путь к расположению устройства.  Кроме того, если для этого устройства требуется [пространство MMIO](#mmio-space), оно также будет отображаться.

![Сурвэйдда. ps1](./images/hyper-v-surveydda-ps1.png)
