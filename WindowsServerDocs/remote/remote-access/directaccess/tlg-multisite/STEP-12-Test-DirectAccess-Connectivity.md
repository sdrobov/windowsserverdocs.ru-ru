---
title: Шаг 12. Тестирование подключения DirectAccess
description: 'Этот раздел является частью руководства по лаборатории тестирования: демонстрация многосайтового развертывания DirectAccess для Windows Server 2016'
manager: brianlic
ms.prod: windows-server
ms.technology: networking-da
ms.topic: article
ms.assetid: 65ac1c23-3a47-4e58-888d-9dde7fba1586
ms.author: lizross
author: eross-msft
ms.openlocfilehash: 85aff4ae9e117359f8827abb15dce47728a30da4
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80857287"
---
# <a name="step-12-test-directaccess-connectivity"></a>Шаг 12. Тестирование подключения DirectAccess

>Область применения: Windows Server (Semi-Annual Channel), Windows Server 2016

Прежде чем можно будет проверить возможность подключения с клиентских компьютеров, расположенных в Интернете или Хоменет сетях, необходимо убедиться, что они имеют правильные параметры групповой политики.  
  
- Проверка наличия правильной групповой политики у клиентов  
  
- Тестирование подключения DirectAccess из Интернета через EDGE1  
  
- Перемещение КЛИЕНТ2 в группу безопасности Win7_Clients_Site2  
  
- Проверка подключения DirectAccess из Интернета через 2-EDGE1  
  
## <a name="prerequisites"></a>Предварительные требования  
Подключите оба клиентских компьютера к корпоративной сети, а затем перезапустите оба клиентских компьютера.  
  
## <a name="verify-clients-have-the-correct-group-policy"></a><a name="policy"></a>Проверка наличия у клиентов правильной групповой политики  
  
1.  На компьютере КЛИЕНТ1 нажмите **кнопку Пуск**, введите **PowerShell. exe**, щелкните правой кнопкой мыши **PowerShell**, выберите пункт **Дополнительно**, а затем — **Запуск от имени администратора**. Если появится диалог **Контроль учетных записей**, подтвердите, что действие, которое оно отображает то, что нужно, затем щелкните **Да**.  
  
2.  В окне Windows PowerShell введите **ipconfig** и нажмите клавишу ВВОД.  
  
    Убедитесь, что IPv4-адрес адаптера корпоративной сети начинается с 10.0.0.  
  
3.  В окне Windows PowerShell введите **Get-днсклиентнрптполици** и нажмите клавишу ВВОД. Отобразятся записи таблицы политики разрешения имен для DirectAccess.  
  
    -   . corp.contoso.com. Эти параметры указывают, что все подключения к corp.contoso.com должны быть разрешены одним из DNS-серверов DirectAccess с IPv6-адресом 2001: db8:1:: 2 или 2001: db8:2:: 20.  
  
    -   nls.corp.contoso.com. Эти параметры указывают на исключение имени nls.corp.contoso.com.  
  
4.  Оставьте окно Windows PowerShell открытым для следующей процедуры.  
  
5.  На КЛИЕНТ2 нажмите кнопку **Пуск**, выберите пункт **все программы**, **затем стандартные**, щелкните **Windows PowerShell**, щелкните правой кнопкой мыши **Windows PowerShell**и выберите команду **Запуск от имени администратора**. Если появится диалог **Контроль учетных записей**, подтвердите, что действие, которое оно отображает то, что нужно, затем щелкните **Да**.  
  
6.  В окне Windows PowerShell введите **ipconfig** и нажмите клавишу ВВОД.  
  
    Убедитесь, что IPv4-адрес адаптера корпоративной сети начинается с 10.0.0.  
  
7.  В окне Windows PowerShell введите **команду netsh Namespace показывать политику** и нажмите клавишу ВВОД.  
  
    В выходных данных должно быть два раздела:  
  
    -   . corp.contoso.com. Эти параметры указывают, что все подключения к corp.contoso.com должны быть разрешены DNS-сервером DirectAccess с адресом IPv6 2001: db8:1:: 2.  
  
    -   nls.corp.contoso.com. Эти параметры указывают на исключение имени nls.corp.contoso.com.  
  
8.  Оставьте окно Windows PowerShell открытым для следующей процедуры.  
  
## <a name="test-directaccess-connectivity-from-the-internet-through-edge1"></a><a name="EDGE1"></a>Тестирование подключения DirectAccess из Интернета через EDGE1  
  
1. Отключите 2-EDGE1 от сети Интернет.  
  
2. Отсоедините компьютер КЛИЕНТ1 и КЛИЕНТ2 от коммутатора корпоративной сети и подключите их к Интернет – коммутатору. Подождите 30 секунд.  
  
3. На компьютере КЛИЕНТ1 в окне Windows PowerShell введите **ipconfig/all** и нажмите клавишу ВВОД.  
  
4. Изучите выходные данные команды ipconfig.  
  
   Теперь клиентский компьютер подключен к Интернету и имеет общедоступный IPv4-адрес. Когда клиент DirectAccess имеет общедоступный IPv4-адрес, он использует технологии туннелирования IPv6 Teredo или IP-HTTPS для туннелирования сообщений IPv6 по протоколу Интернета IPv4 между клиентом и сервером удаленного доступа DirectAccess. Обратите внимание, что Teredo является предпочтительной технологией перехода.  
  
5. В окне Windows PowerShell введите **ipconfig/flushdns** и нажмите клавишу ВВОД. При этом записи разрешения имен, которые могут существовать в кэше DNS клиента, будут удалены с момента подключения клиентского компьютера к корпоративной сети.  
  
6. Отключите интерфейс Teredo, чтобы клиентский компьютер использовал IP-HTTPS для подключения к корпоративной сети с помощью следующей команды:  
  
   ```  
   netsh interface teredo set state disable  
   ```  
  
7. Убедитесь, что вы подключены через EDGE1. Введите **netsh interface хттпстуннел отобразить интерфейсы** и нажмите клавишу ВВОД.  
  
   Выходные данные должны содержать URL-адрес: https://edge1.contoso.com:443/IPHTTPS.  
  
   > [!TIP]  
   > На компьютере КЛИЕНТ1 можно также выполнить следующую команду Windows PowerShell: **Get-нетифттпсконфигуратион**. В выходных данных показаны доступные URL-адреса сервера и текущий активный профиль.  
  
8. В окне Windows PowerShell введите **ping APP1** и нажмите клавишу ВВОД. Вы должны увидеть ответы от IPv6-адреса, назначенного APP1, который в данном случае — 2001: db8:1:: 3.  
  
9. В окне Windows PowerShell введите **ping 2-APP1** и нажмите клавишу ВВОД. Вы должны увидеть ответы от IPv6-адреса, назначенного 2 – APP1, который в данном случае — 2001: db8:2:: 3.  
  
10. В окне Windows PowerShell введите **ping** , а затем нажмите клавишу ВВОД. Вы должны увидеть ответы от NAT64-адреса, назначенного EDGE1, в корпорацию, в данном случае — демон**C9:9F4E: eb1b**: 7777:: A00:4. Обратите внимание, что значения полужирного шрифта будут отличаться в зависимости от способа создания адреса.  
  
    Возможность проверки связи с этим компьютером очень важна, поскольку успешное завершение означает, что вы смогли установить подключение с помощью NAT64/DNS64, так как в качестве этого ресурса используется только протокол IPv4.  
  
11. Откройте Internet Explorer, в адресной строке Internet Explorer введите **https://app1/** и нажмите клавишу ВВОД. Появится веб-сайт IIS на APP1 по умолчанию.  
  
12. В адресной строке Internet Explorer введите **https://2-app1/** и нажмите клавишу ВВОД. Вы увидите веб-сайт по умолчанию на 2 – APP1.  
  
13. В адресной строке Internet Explorer введите **https://app2/** и нажмите клавишу ВВОД. Появится веб-сайт IIS на APP2 по умолчанию.  
  
14. На **начальном** экране введите<strong>\\\2-App1\Files</strong>и нажмите клавишу ВВОД. Дважды щелкните текстовый файл примера.  
  
    Это показывает, что вы смогли подключиться к файловому серверу в домене corp2.corp.contoso.com при подключении через EDGE1.  
  
15. На **начальном** экране введите<strong>\\\App2\Files</strong>и нажмите клавишу ВВОД. Дважды щелкните файл "Новый текстовый документ".  
  
    Это показывает, что вы смогли подключиться к серверу только с IPv4 с помощью SMB для получения ресурса в домене ресурсов.  
  
16. На **начальном** экране введите**WF. msc**и нажмите клавишу ВВОД.  
  
17. В консоли **Брандмауэр Windows в режиме повышенной безопасности** Обратите внимание, что активен только **Общий профиль** . Для правильной работы DirectAccess необходимо включить брандмауэр Windows. Если брандмауэр Windows отключен, подключение DirectAccess не работает.  
  
18. В левой области консоли разверните узел **мониторинг** и щелкните узел **правила безопасности подключения** . Вы должны увидеть активные правила безопасности подключений: **Политика DirectAccess — клиенттокорп**, **Политика DirectAccess — ClientToDNS64NAT64PrefixExemption**, **Политика DirectAccess — Клиенттоинфра**и **Политика DirectAccess — клиенттонлаексемпт**. Прокрутите среднюю область вправо, чтобы отобразить **первый метод проверки подлинности** и столбцы **2 метода проверки подлинности** . Обратите внимание, что первое правило (Клиенттокорп) использует Kerberos V5 для установки туннеля интрасети, а третье правило (Клиенттоинфра) использует NTLMv2 для создания туннеля инфраструктуры.  
  
19. В левой области консоли разверните узел **ассоциации безопасности** и щелкните узел **основного режима** . Обратите внимание на взаимосвязи безопасности туннеля инфраструктуры, использующие NTLMv2 и сопоставление безопасности туннеля интрасети по протоколу Kerberos V5. Щелкните правой кнопкой мыши запись, которая показывает **пользователя (Kerberos V5)** в качестве **второго метода проверки подлинности** , и выберите пункт **Свойства**. На вкладке **Общие** Обратите внимание, что **второй локальный идентификатор проверки подлинности** — **CORP\User1**, что означает, что Пользователь1 мог успешно пройти проверку подлинности в домене Corp с помощью Kerberos.  
  
20. Повторите эту процедуру из шага 3 на КЛИЕНТ2.  
  
## <a name="move-client2-to-the-win7_clients_site2-security-group"></a><a name="secgroup"></a>Перемещение КЛИЕНТ2 в группу безопасности Win7_Clients_Site2  
  
1.  На компьютере DC1 нажмите кнопку **Пуск**, введите **DSA. msc**и нажмите клавишу ВВОД.  
  
2.  В консоли Active Directory пользователи и компьютеры откройте **Corp.contoso.com/Users** и дважды щелкните **Win7_Clients_Site1**.  
  
3.  В диалоговом окне **свойства Win7_Clients_Site1** перейдите на вкладку **члены** , щелкните **КЛИЕНТ2**, нажмите кнопку **Удалить**, выберите **Да**, а затем нажмите кнопку **ОК**.  
  
4.  Дважды щелкните **Win7_Clients_Site2**, а затем в диалоговом окне **Свойства Win7_Clients_Site2** перейдите на вкладку **члены** .  
  
5.  Нажмите кнопку **Добавить**и в диалоговом окне **Выбор пользователей, контактов, компьютеров или учетных записей служб** щелкните **типы объектов**, выберите **Компьютеры**, а затем нажмите кнопку **ОК**.  
  
6.  В поле **Введите имена объектов для выбора**введите **КЛИЕНТ2**и нажмите кнопку **ОК**.  
  
7.  Перезапустите компьютер КЛИЕНТ2 и войдите в систему, используя учетную запись Corp/User1.  
  
8.  На КЛИЕНТ2 откройте окно Windows PowerShell с повышенными привилегиями, введите **netsh Namespace показывать политику** и нажмите клавишу ВВОД.  
  
    В выходных данных должно быть два раздела:  
  
    -   . corp.contoso.com. Эти параметры указывают, что все подключения к corp.contoso.com должны быть разрешены DNS-сервером DirectAccess с адресом IPv6 2001: db8:2:: 20.  
  
    -   nls.corp.contoso.com. Эти параметры указывают на исключение имени nls.corp.contoso.com.  
  
## <a name="test-directaccess-connectivity-from-the-internet-through-2-edge1"></a><a name="DAConnect"></a>Проверка подключения DirectAccess из Интернета через 2-EDGE1  
  
1. Подключение 2 — EDGE1 к сети Интернет.  
  
2. Отключите EDGE1 от сети Интернет.  
  
3. На компьютере КЛИЕНТ1 откройте окно Windows PowerShell с повышенными привилегиями.  
  
4. В окне Windows PowerShell введите **ipconfig/flushdns** и нажмите клавишу ВВОД. При этом записи разрешения имен, которые могут существовать в кэше DNS клиента, будут удалены с момента подключения клиентского компьютера к корпоративной сети.  
  
5. Убедитесь, что вы подключены через 2-EDGE1. Введите **netsh interface хттпстуннел отобразить интерфейсы** и нажмите клавишу ВВОД.  
  
   Выходные данные должны содержать URL-адрес: https://2-edge1.contoso.com:443/IPHTTPS.  
  
   > [!TIP]  
   > На компьютере КЛИЕНТ1 можно также выполнить следующую команду: **Get-нетифттпсконфигуратион**. В выходных данных показаны доступные URL-адреса сервера и текущий активный профиль.  
  
   > [!NOTE]  
   > CLIENT1 автоматически изменяет сервер, через который он подключается к корпоративным ресурсам. Если выходные данные команды показывают подключение к EDGE1, подождите примерно пять минут и повторите попытку.  
  
6. В окне Windows PowerShell введите **ping APP1** и нажмите клавишу ВВОД. Вы должны увидеть ответы от IPv6-адреса, назначенного APP1, который в данном случае — 2001: db8:1:: 3.  
  
7. В окне Windows PowerShell введите **ping 2-APP1** и нажмите клавишу ВВОД. Вы должны увидеть ответы от IPv6-адреса, назначенного 2 – APP1, который в данном случае — 2001: db8:2:: 3.  
  
8. В окне Windows PowerShell введите **ping** , а затем нажмите клавишу ВВОД. Вы должны увидеть ответы от NAT64-адреса, назначенного EDGE1, в корпорацию, в данном случае — демон**C9:9F4E: eb1b**: 7777:: A00:4. Обратите внимание, что значения полужирного шрифта будут отличаться в зависимости от способа создания адреса.  
  
   Возможность проверки связи с этим компьютером очень важна, поскольку успешное завершение означает, что вы смогли установить подключение с помощью NAT64/DNS64, так как в качестве этого ресурса используется только протокол IPv4.  
  
9. Откройте Internet Explorer, в адресной строке Internet Explorer введите **https://app1/** и нажмите клавишу ВВОД. Появится веб-сайт IIS на APP1 по умолчанию.  
  
10. В адресной строке Internet Explorer введите **https://2-app1/** и нажмите клавишу ВВОД. Появится веб-сайт IIS на APP2 по умолчанию.  
  
11. В адресной строке Internet Explorer введите **https://app2/** и нажмите клавишу ВВОД. Вы увидите веб-сайт по умолчанию на APP3.  
  
12. На **начальном** экране введите<strong>\\\App1\Files</strong>и нажмите клавишу ВВОД. Дважды щелкните текстовый файл примера.  
  
    Это показывает, что вы смогли подключиться к файловому серверу в домене corp.contoso.com при подключении через 2-EDGE1.  
  
13. На **начальном** экране введите<strong>\\\App2\Files</strong>и нажмите клавишу ВВОД. Дважды щелкните файл "Новый текстовый документ".  
  
    Это показывает, что вы смогли подключиться к серверу только с IPv4 с помощью SMB для получения ресурса в домене ресурсов.  
  
14. Повторите эту процедуру на КЛИЕНТ2 из шага 3.  
  


