---
title: Настройка веб-служба регистрации сертификатов для продления на основе ключа сертификата на настраиваемом порту
description: ''
author: Deland-Han
ms.author: delhan
manager: dcscontentpm
ms.date: 11/12/2019
ms.topic: article
ms.prod: windows-server
ms.openlocfilehash: 3d3d08d6abe9daa571dd7365815c1fc61f926501
ms.sourcegitcommit: e5df3fd267352528eaab5546f817d64d648b297f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2019
ms.locfileid: "74163100"
---
# <a name="configuring-certificate-enrollment-web-service-for-certificate-key-based-renewal-on-a-custom-port"></a>Настройка веб-служба регистрации сертификатов для продления на основе ключа сертификата на настраиваемом порту

> Авторы: Житеш сакур, мира Мохидин, технические рекомендации с группой Windows.
Инженер службы поддержки Анкит тяги с группой Windows

## <a name="summary"></a>Сводка

Эта статья содержит пошаговые инструкции по реализации веб-служба политик регистрации сертификатов (CEP) и веб-служба регистрации сертификатов (CES) на настраиваемом порте, отличном от 443, для продления на основе ключей сертификатов, чтобы воспользоваться преимуществами автоматического возобновление функции CEP и CES.

В этой статье также объясняется, как работают методы CEP и CES и предоставляются рекомендации по установке.

> [!Note]
> Рабочий процесс, который входит в эту статью, относится к конкретному сценарию. Один и тот же рабочий процесс может не работать в другой ситуации. Однако принципы останутся прежними.
>
> Заявление об отказе: Эта настройка создается для конкретного требования, при котором не требуется использовать порт 443 для HTTPS-соединений по умолчанию для серверов CEP и CES. Хотя такая настройка возможна, она имеет ограниченную поддержку. Службы и поддержка для пользователей помогут вам в том, чтобы при соблюдении этого руководством тщательно использовать минимальное отклонение от предоставленной конфигурации веб-сервера.

## <a name="scenario"></a>Сценарий

В этом примере инструкции основаны на среде, использующей следующую конфигурацию:

- Лес Contoso.com, в котором есть инфраструктура открытых ключей (PKI) служб Active Directory Certificate Services (AD CS).

- Два экземпляра CEP/CES, настроенные на одном сервере, работающем под учетной записью службы. Один экземпляр использует имя пользователя и пароль для первоначальной регистрации. Другой использует проверку подлинности на основе сертификатов для продления на основе ключей в режиме только возобновления.

- Пользователь имеет компьютер с Рабочей группой или не присоединенным к домену, для которого он будет регистрировать сертификат компьютера, используя учетные данные пользователя и пароль.

- Подключение пользователя к CEP и CES по протоколу HTTPS происходит через пользовательский порт, например 49999. (Этот порт выбирается из динамического диапазона портов и не используется в качестве статического порта любой другой службой.)

- Когда время существования сертификата приближается к концу, компьютер использует обновление на основе ключей CES для продления сертификата по тому же каналу.

![развертывание](media/certificate-enrollment-certificate-key-based-renewal-1.png)

## <a name="configuration-instructions"></a>Инструкции по настройке

### <a name="overview"></a>Обзор 

1. Настройте шаблон для обновления на основе ключей.

2. В качестве необходимого компонента настройте сервер CEP и CES для проверки подлинности имени пользователя и пароля.   
   В этой среде мы будем называть экземпляр «CEPCES01».

3.  Настройте другой экземпляр CEP и CES с помощью PowerShell для проверки подлинности на основе сертификата на том же сервере. Экземпляр CES будет использовать учетную запись службы.

    В этой среде мы будем называть экземпляр «CEPCES02». Используемая учетная запись службы — "цепцессвк".

4.  Настройте параметры на стороне клиента.

### <a name="configuration"></a>Настройка

В этом разделе описаны шаги по настройке первоначальной регистрации.

> [!Note]
> Для работы CES можно также настроить любую учетную запись службы пользователя, MSA или GMSA.

В качестве необходимого компонента необходимо настроить CEP и CES на сервере, используя проверку имени пользователя и пароля.

#### <a name="configure-the-template-for-key-based-renewal"></a>Настройка шаблона для продления на основе ключей

Можно создать дубликат существующего шаблона компьютера и настроить следующие параметры шаблона:

1. На вкладке Имя субъекта шаблона сертификата убедитесь, что выбрано **предложение в запросе** и **использование сведений о субъекте из существующих сертификатов для параметров запросов на продление автоматической регистрации** .
   ![новых шаблонов](media/certificate-enrollment-certificate-key-based-renewal-2.png) 

2. Перейдите на вкладку " **требования к выдаче** " и установите флажок " **утверждение диспетчером сертификатов ЦС** ".
   Требования к выдаче ![](media/certificate-enrollment-certificate-key-based-renewal-3.png) 

3. Назначьте разрешение **Чтение** и **Регистрация** учетной записи службы **цепцессвк** для этого шаблона.

4. Опубликуйте новый шаблон в центре сертификации.

> [!Note]
> Убедитесь, что для параметров совместимости в шаблоне задано значение **Windows Server 2012 R2** , так как существует известная ошибка, при которой шаблоны не отображаются, если установлена совместимость с Windows Server 2016 или более поздней версии. Дополнительные информацию см. [в разделе не удалось выбрать шаблоны сертификатов, совместимые с центром сертификации Windows server 2016, из центра сертификации Windows server 2016 или более поздней версии или серверов CEP ](https://support.microsoft.com/en-in/help/4508802/cannot-select-certificate-templates-in-windows-server-2016).


#### <a name="configure-the-cepces01-instance"></a>Настройка экземпляра CEPCES01

##### <a name="step-1-install-the-instance"></a>Шаг 1. Установка экземпляра

Чтобы установить экземпляр CEPCES01, используйте один из следующих методов.

**Метод 1**

Пошаговые инструкции по включению CEP и CES для проверки подлинности имени пользователя и пароля см. в следующих статьях.

[Руководство по веб-служба политик регистрации сертификатов](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831625(v=ws.11))

[Руководство по веб-служба регистрации сертификатов](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831822(v=ws.11)#configure-a-ca-for-the-certificate-enrollment-web-service)

> [!Note]
> Убедитесь, что не установлен флажок "включить обновление на основе ключей", если вы настроили экземпляры CEP и CES с проверкой подлинности имени пользователя и пароля.

**Метод 2**

Для установки экземпляров CEP и CES можно использовать следующие командлеты PowerShell:

```PowerShell
Import-Module ServerManager
Add-WindowsFeature Adcs-Enroll-Web-Pol
Add-WindowsFeature Adcs-Enroll-Web-Svc
```

```PowerShell
Install-AdcsEnrollmentPolicyWebService -AuthenticationType Username -SSLCertThumbprint "sslCertThumbPrint"
```

Эта команда устанавливает веб-служба политик регистрации сертификатов (CEP), указывая, что для проверки подлинности используется имя пользователя и пароль. 

> [!Note]
> В этой команде \<**сслцертсумбпринт**\> — это отпечаток сертификата, который будет использоваться для привязки служб IIS.

```PowerShell
Install-AdcsEnrollmentWebService -ApplicationPoolIdentity -CAConfig "CA1.contoso.com\contoso-CA1-CA" -SSLCertThumbprint "sslCertThumbPrint" -AuthenticationType Username
```

Эта команда устанавливает веб-служба регистрации сертификатов (CES), чтобы использовать центр сертификации для имени компьютера **CA1.contoso.com** и общего имени ЦС **contoso-CA1-CA**. Удостоверение CES указывается в качестве удостоверения пула приложений по умолчанию. Тип проверки подлинности — **username**. Сслцертсумбпринт — это отпечаток сертификата, который будет использоваться для привязки служб IIS.

##### <a name="step-2-check-the-internet-information-services-iis-manager-console"></a>Шаг 2. Проверка консоли диспетчера службы IIS (IIS)

После успешной установки вы увидите, что в консоли диспетчера службы IIS (IIS) отображается следующее.
![диспетчера IIS](media/certificate-enrollment-certificate-key-based-renewal-4.png) 

В разделе **веб-сайт по умолчанию**выберите **ADPolicyProvider_CEP_UsernamePassword**, а затем откройте **Параметры приложения**. Запишите **идентификатор** и **URI**.

Можно добавить **понятное имя** для управления.

#### <a name="configure-the-cepces02-instance"></a>Настройка экземпляра CEPCES02

##### <a name="step-1-install-the-cep-and-ces-for-key-based-renewal-on-the-same-server"></a>Шаг 1. Установите CEP и CES для продления на том же сервере. 

Выполните следующую команду в PowerShell:

```PowerShell
Install-AdcsEnrollmentPolicyWebService -AuthenticationType Certificate -SSLCertThumbprint "sslCertThumbPrint" -KeyBasedRenewal
```

Эта команда устанавливает веб-служба политик регистрации сертификатов (CEP) и указывает, что для проверки подлинности используется сертификат. 

> [!Note]
> В этой команде \<Сслцертсумбпринт\> — это отпечаток сертификата, который будет использоваться для привязки служб IIS. 

Продление на основе ключей позволяет клиентам сертификатов обновлять свои сертификаты, используя ключ существующего сертификата для проверки подлинности. При использовании режима обновления на основе ключей служба возвращает только шаблоны сертификатов, настроенные для продления на основе ключей.

```PowerShell
Install-AdcsEnrollmentWebService -CAConfig "CA1.contoso.com\contoso-CA1-CA" -SSLCertThumbprint "sslCertThumbPrint" -AuthenticationType Certificate -ServiceAccountName "Contoso\cepcessvc" -ServiceAccountPassword (read-host "Set user password" -assecurestring) -RenewalOnly -AllowKeyBasedRenewal
```

Эта команда устанавливает веб-служба регистрации сертификатов (CES), чтобы использовать центр сертификации для имени компьютера **CA1.contoso.com** и общего имени ЦС **contoso-CA1-CA**. 

В этой команде удостоверение веб-служба регистрации сертификатов указывается в качестве учетной записи службы **цепцессвк** . Тип проверки подлинности — **Certificate**. **Сслцертсумбпринт** — это отпечаток сертификата, который будет использоваться для привязки служб IIS.

Командлет **реневалонли** позволяет выполнить команду CES в режиме только обновления. Командлет **алловкэйбаседреневал** также указывает, что CES будет принимать запросы продления на основе ключей для сервера регистрации. Это допустимые сертификаты клиента для проверки подлинности, которые не сопоставлены с субъектом безопасности напрямую.

> [!Note]
> Учетная запись службы должна входить в группу **иисусерс** на сервере.

##### <a name="step-2-check-the-iis-manager-console"></a>Шаг 2. Проверка консоли диспетчера IIS

После успешной установки вы увидите, что в консоли диспетчера IIS отображается следующее.
![диспетчера IIS](media/certificate-enrollment-certificate-key-based-renewal-5.png) 

Выберите **KeyBasedRenewal_ADPolicyProvider_CEP_Certificate** в разделе **веб-сайт по умолчанию** и откройте **Параметры приложения**. Запишите **идентификатор** и **URI**. Можно добавить **понятное имя** для управления.

> [!Note]
> Если экземпляр установлен на новом сервере, проверьте его идентификатор, чтобы убедиться, что он совпадает с ИДЕНТИФИКАТОРом, созданным в экземпляре CEPCES01. Можно скопировать и вставить значение напрямую, если оно отличается.

#### <a name="complete-certificate-enrollment-web-services-configuration"></a>Завершение настройки веб-служб регистрации сертификатов

Чтобы иметь возможность зарегистрировать сертификат от имени функций CEP и CES, необходимо настроить учетную запись компьютера рабочей группы в Active Directory а затем настроить ограниченное делегирование для учетной записи службы.

##### <a name="step-1-create-a-computer-account-of-the-workgroup-computer-in-active-directory"></a>Шаг 1. Создание учетной записи компьютера рабочей группы в Active Directory

Эта учетная запись будет использоваться для проверки подлинности при обновлении на основе ключа и параметра "опубликовать в Active Directory" в шаблоне сертификата.

> [!Note]
> Не нужно присоединяться к домену на клиентском компьютере. Эта учетная запись поступает в изображение при выполнении проверки подлинности на основе сертификатов в КБР для службы дсмаппер.

![Новый объект](media/certificate-enrollment-certificate-key-based-renewal-6.png) 
 
##### <a name="step-2-configure-the-service-account-for-constrained-delegation-s4u2self"></a>Шаг 2. Настройка учетной записи службы для ограниченного делегирования (S4U2Self)

Выполните следующую команду PowerShell, чтобы включить ограниченное делегирование (S4U2Self или любой протокол проверки подлинности):

```PowerShell
Get-ADUser -Identity cepcessvc | Set-ADAccountControl -TrustedToAuthForDelegation $True
Set-ADUser -Identity cepcessvc -Add @{'msDS-AllowedToDelegateTo'=@('HOST/CA1.contoso.com','RPCSS/CA1.contoso.com')}
```

> [!Note]
> В этой команде \<цепцессвк\> является учетной записью службы, а < CA1. contoso. com > — центром сертификации.

> [!Important]
> В этой конфигурации не включен флаг РЕНЕВАЛОНБЕХАЛОФ в ЦС, так как мы используем ограниченное делегирование для того же задания. Это позволяет избежать добавления разрешения для учетной записи службы в систему безопасности ЦС.

##### <a name="step-3-configure-a-custom-port-on-the-iis-web-server"></a>Шаг 3. Настройка пользовательского порта на веб-сервере IIS

1. В консоли диспетчера IIS выберите веб-сайт по умолчанию.

2. В области Действие выберите Изменить привязку сайта. 

3. Измените значение параметра порта по умолчанию с 443 на пользовательский порт. На снимке экрана примера показан параметр порта 49999.
   ![изменить порт](media/certificate-enrollment-certificate-key-based-renewal-7.png) 

##### <a name="step-4-edit-the-ca-enrollment-services-object-on-active-directory"></a>Шаг 4. изменение объекта служб регистрации ЦС на Active Directory

1. На контроллере домена откройте ADSIEdit. msc.

2. [Подключитесь к разделу конфигурации](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/ff730188(v=ws.10))и перейдите к объекту службы регистрации ЦС:
   
   CN = ЕНТКА, CN = службы регистрации, CN = открытые ключи Services, CN = Services, CN = Configuration, DC = contoso, DC = com

3. Щелкните правой кнопкой мыши и измените объект CA. Измените атрибут **мспки-регистрации-Servers** , используя пользовательский порт с URI сервера CEP и CES, которые были найдены в параметрах приложения. Пример

   ```
   140https://cepces.contoso.com:49999/ENTCA_CES_UsernamePassword/service.svc/CES0   
   181https://cepces.contoso.com:49999/ENTCA_CES_Certificate/service.svc/CES1
   ```
   
   ![Редактирование ADSI](media/certificate-enrollment-certificate-key-based-renewal-8.png) 

#### <a name="configure-the-client-computer"></a>Настройка клиентского компьютера

На клиентском компьютере настройте политики регистрации и политику автоматической регистрации. Для этого выполните следующие действия:

1. Выберите **пуск** > **выполнить**, а затем введите **gpedit. msc**.

2. Последовательно выберите **Конфигурация компьютера** > **Параметры Windows** > **Параметры безопасности**, а затем щелкните **политики открытого ключа**.

3. Включите **политику автоматической регистрации клиента служб сертификатов** для соответствия параметрам на следующем снимке экрана.
   ](media/certificate-enrollment-certificate-key-based-renewal-9.png) групповой политики ![сертификатов
 
4. Включите **политику регистрации сертификатов клиента служб сертификатов**.

   а) Нажмите кнопку **Добавить** , чтобы добавить политику регистрации и ввести идентификатор URI CEP с **UserNamePassword** , который мы редактировали в ADSI.
   
   б. В качестве **типа проверки подлинности**выберите **имя пользователя и пароль**.
   
   в. Задайте приоритет **10**, а затем проверьте сервер политики.
      ](media/certificate-enrollment-certificate-key-based-renewal-10.png) политики регистрации ![

   > [!Note]
   > Убедитесь, что номер порта добавлен в URI и разрешен в брандмауэре.

5. Зарегистрируйте первый сертификат для компьютера с помощью certlm. msc.
   ](media/certificate-enrollment-certificate-key-based-renewal-11.png) политики регистрации ![

   Выберите шаблон КБР и зарегистрируйте сертификат.
   ](media/certificate-enrollment-certificate-key-based-renewal-12.png) политики регистрации ![

6. Снова откройте **gpedit. msc** . Измените **политику регистрации сертификатов клиента служб сертификатов**, а затем добавьте политику регистрации продления на основе ключей.

   а) Нажмите кнопку **Добавить**, введите URI CEP с **сертификатом** , измененным в ADSI. 
   
   б. Задайте приоритет **1**, а затем проверьте сервер политики. Вам будет предложено выполнить аутентификацию и выбрать сертификат, который был зарегистрирован изначально.

   ![Политика регистрации](media/certificate-enrollment-certificate-key-based-renewal-13.png) 

> [!Note]
> Убедитесь, что значение приоритета политики регистрации продления на основе ключей ниже приоритета политики регистрации паролей для имени пользователя. Первая предпочтение присваивается наименьшему приоритету.

## <a name="testing-the-setup"></a>Тестирование установки

Чтобы обеспечить работоспособность автоматического продления, убедитесь, что обновление вручную выполняется путем продления сертификата с тем же ключом с помощью MMC. Кроме того, во время обновления вам будет предложено выбрать сертификат. Вы можете выбрать сертификат, который мы зарегистрировали ранее. Ожидается запрос.

Откройте личное хранилище сертификатов компьютера и добавьте представление "архивные сертификаты". Для этого добавьте оснастку учетной записи локального компьютера в MMC. exe, выделите **Сертификаты (локальный компьютер)** , щелкнув его, щелкните **Просмотр** на **вкладке действие** справа или в верхней части консоли MMC, щелкните **Просмотр параметров**, выберите **архивные сертификаты**, а затем нажмите кнопку **ОК**.

### <a name="method-1"></a>Метод 1 

Выполните следующую команду.

```PowerShell
certreq -machine -q -enroll -cert <thumbprint> renew
```

![.](media/certificate-enrollment-certificate-key-based-renewal-14.png)

### <a name="method-2"></a>Метод 2

Передайте время и дату на клиентском компьютере в момент продления шаблона сертификата.

Например, шаблон сертификата имеет срок действия в 2 дня и настроенный 8-часовой параметр обновления. Пример сертификата был выпущен в 4:00 утра. в течение 18 дней месяца срок действия истекает в 4:00 утра. на 20. Подсистема автоматической регистрации активируется при перезапуске и каждые 8 часов (приблизительно).

Таким образом, если вы перейдете время на 8:10 P.M. на 19-часовом уровне, так как для нашего продленного периода в шаблоне задано значение 8, выполнение команды certutil-Pulse (для активации подсистемы AE) регистрирует сертификат автоматически.

![.](media/certificate-enrollment-certificate-key-based-renewal-15.png)
 
После завершения теста верните параметр времени в исходное значение, а затем перезапустите клиентский компьютер.

> [!Note]
> На предыдущем снимке экрана приведен пример, демонстрирующий, что механизм автоматической регистрации работает должным образом, поскольку для даты ЦС по-прежнему устанавливается значение 18. Таким образом, он будет продолжать выдавать сертификаты. В реальной ситуации не произойдет такого большого количества продлений.

## <a name="references"></a>Ссылок

[Руководство по тестовой лаборатории. Демонстрация продления на основе ключей сертификатов](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj590165(v%3Dws.11))

[Веб-службы регистрации сертификатов](https://techcommunity.microsoft.com/t5/Ask-the-Directory-Services-Team/Certificate-Enrollment-Web-Services/ba-p/397385)

[Install-Адксенроллментполицивебсервице](https://docs.microsoft.com/powershell/module/adcsdeployment/install-adcsenrollmentpolicywebservice?view=win10-ps)

[Install-Адксенроллментвебсервице](https://docs.microsoft.com/powershell/module/adcsdeployment/install-adcsenrollmentwebservice?view=win10-ps)

См. также

[Форум по безопасности Windows Server](https://aka.ms/adcsforum)

[Часто задаваемые вопросы об инфраструктуре открытых ключей (PKI) Active Directory служб сертификации (AD CS)](https://aka.ms/adcsfaq)

[Справочные материалы и Библиотека документации по PKI Windows](https://social.technet.microsoft.com/wiki/contents/articles/987.windows-pki-documentation-reference-and-library.aspx)

[Блог PKI Windows](https://blogs.technet.com/b/pki/)

[Настройка ограниченного делегирования Kerberos (только S4U2Proxy или Kerberos) в пользовательской учетной записи службы для прокси-страниц регистрации в Интернете](https://support.microsoft.com/help/4494313/configuring-web-enrollment-proxy-for-s4u2proxy-constrained-delegation)