---
ms.assetid: e6fa9069-ec9c-4615-b266-957194b49e11
title: Обновление AD RMS до Windows Server 2016
author: msmbaldwin
ms.author: esaggese
ms.date: 05/30/2019
ms.prod: windows-server
ms.topic: article
ms.openlocfilehash: 88af85f8e670b9c23b503e0f79af2ce8f10d045e
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80854857"
---
# <a name="upgrading-ad-rms-to-windows-server-2016"></a>Обновление AD RMS до Windows Server 2016

## <a name="introduction"></a>Введение

Службы Active Directory Rights Management (AD RMS) — это служба Майкрософт, которая защищает конфиденциальные документы и сообщения электронной почты. В отличие от традиционных методов защиты, таких как брандмауэры и списки управления доступом, AD RMS шифрование и защита хранятся независимо от того, где находится файл или как он передается. 

В этом документе содержатся рекомендации по переходу с Windows Server 2012 R2 на SQL Server 2012 на Windows Server 2016 и SQL Server 2016. Этот же процесс можно использовать для перехода с более старых, но поддерживаемых версий AD RMS.
Обратите внимание, что службы Active Directory Rights Management больше не находится в режиме активной разработки, и для получения последних возможностей клиенты должны рассмотреть возможность перехода на [Azure Information Protection](https://azure.microsoft.com/services/information-protection/), которая предлагает более полный набор функций с более полной поддержкой устройств и приложений. 

Сведения о переходе на Azure Information Protection из AD RMS без повторной защиты содержимого см. [в документации по миграции Azure Information Protection](https://docs.microsoft.com/azure/information-protection/migrate-from-ad-rms-to-azure-rms).

## <a name="about-the-environment-used-in-this-guide"></a>Сведения о среде, используемой в этом руководством

AD FS является необязательным компонентом установки AD RMS. В этом руководством предполагается использование ADFS. Если ADFS не использовался в вашей среде для поддержки AD RMS пользователей, можно пропустить все шаги, которые ссылаются на ADFS.

В этом разделе SQL Server обновляется до SQL Server 2016, выполняя параллельную установку и перемещая базы данных через резервную копию. Кроме того, если вы можете обновить AD RMS и серверы баз данных ADFS до SQL Server 2016 на месте, можно перейти к следующему разделу в этом документе после того, как это сделано, не выполняя действия, описанные в этом разделе.  

## <a name="installation"></a>Установка

### <a name="configuring-sql-server-2016"></a>Настройка SQL Server 2016

В следующем разделе описаны задачи по реализации, относящиеся непосредственно к конфигурации SQL Server 2016. В этом руководством рассматривается использование диспетчер сервера и SQL Server Management Studio для выполнения этих задач.

Эти действия необходимо выполнить при установке SQL Server 2016. Установите SQL Server 2016 на подходящее оборудование согласно стандартным рекомендациям и политикам вашей организации. 

#### <a name="preparing-the-sql-server"></a>Подготовка SQL Server

В следующем разделе подробно описано, как подготовить SQL Server, чтобы его можно было обновить до SQL Server 2016 перед обновлением других служб на AD RMS платформе для использования Windows Server 2016.

##### <a name="adding-cname-for-sql-server-2016-to-dns"></a>Добавление CNAME для SQL Server 2016 в DNS

Эта запись используется для того, чтобы убедиться, что программа установки Windows Server 2016 будет получать соответствующие данные, так как она будет указывать на новый SQL Server 2016. **Примечание. Если уже используется запись CNAME для служб ADFS и AD RMS, можно перейти к дальнейшим действиям.**


**Добавление записи CNAME для SQL Server 2016 в DNS**

1.  Войдите на контроллер домена Windows Server 2012 R2 с учетными данными администратора домена.

2.  Откройте Диспетчер сервера.

3.  Щелкните **Сервис** и выберите **DNS** , чтобы открыть диспетчер DNS.

4.  В левой области навигации разверните контроллер домена и откройте **зоны прямого просмотра**.

5.  Откройте соответствующие ресурсы домена, щелкните правой кнопкой мыши на панели справа и выберите **создать псевдоним (CNAME)** , чтобы начать создание записи CNAME.

6.  Для имени псевдонима введите логическое имя, чтобы отличать его от других, которые могут присутствовать (например, СКЛАДРМС или СКЛАДФС)

7.  После ввода имени укажите полное доменное имя целевого узла, который будет новым сервером SQL Server 2016. символа. SQL2016.contoso.com)

8.  После того как все данные будут введены, нажмите кнопку **ОК**.

##### <a name="backup-the-ad-rms-and-adfs-databases"></a>Резервное копирование баз данных AD RMS и ADFS

Базы данных AD RMS и ADFS содержат важную информацию, необходимую для AD RMS, например открытый ключ сертификата лицензиара сервера, шаблоны политики прав, данные конфигурации ADFS и сведения о ведении журнала. Без этих баз данных клиенты не могут выдавать лицензии на использование защищенного содержимого, помимо других проблем.

Базы данных конфигурация AD RMS считается наиболее важным, так как она содержит сертификат лицензиара, шаблоны политики прав, ключи пользователей и сведения о конфигурации. Поэтому, несмотря на то, что необходимо выполнить резервное копирование всех баз данных AD RMS и ADFS, следует регулярно создавать резервную копию базы данных конфигурации.

В базе данных ведения журнала хранятся сведения о пользовательских запросах к кластеру AD RMS для сертификатов и использования лицензий. Стратегия резервного копирования этой базы данных должна основываться на политике компании, которая позволяет хранить информацию такого типа.

База данных служб каталогов не очень важна для AD RMS функциональности и, если последние данные потеряны, база данных будет повторно заполнена данными по мере того, как сервер AD RMS получает запросы на сертификаты и лицензии на использование. Вам не нужно регулярно создавать резервную копию этой базы данных, но необходимо иметь по крайней мере копию базы данных, так как она была изначально настроена после развертывания AD RMS.

**Резервное копирование AD RMS и (или) базы данных ADFS с помощью Microsoft SQL Server**

1.  Войдите на сервер базы данных Windows Server 2012 R2 AD RMS с SQL 2012.

2.  Нажмите кнопку **Пуск**, выберите пункт **все программы**, щелкните **Microsoft SQL Server**и выберите **SQL Server Management Studio**.

3.  В окне **Подключение к серверу** убедитесь, что сервер, на котором размещена AD RMS базы данных, находится в поле **имя сервера** и нажмите кнопку **подключить**.

4.  Разверните узел **базы данных**. Щелкните правой кнопкой мыши соответствующую базу данных (**DRM** и **ADFS**), наведите указатель на пункт **задачи**и выберите пункт **резервное копирование**.

5.  Повторите шаг 4 для оставшихся баз данных.

6.  Убедитесь, что резервная копия баз данных может быть доступна другим компьютерам в сети или с помощью устройства хранения, так как они понадобятся для выполнения последующих действий во время миграции.

Теперь копии базы данных можно хранить в безопасном месте. Не забывайте часто создавать резервные копии баз данных.

##### <a name="adding-domain-admin-sql-ad-rms-andor-adfs-service-account-to-sql-server-2016"></a>Добавление учетной записи администратора домена, SQL, AD RMS или службы ADFS в SQL Server 2016

Следующие шаги демонстрируют Добавление различных учетных записей служб в SQL Server 2016 для облегчения миграции данных из среды Windows Server 2012 R2. При попытке получить доступ к содержимому и обработке данных будут предоставлены соответствующие разрешения.

**Добавление учетной записи администратора домена, SQL, AD RMS или службы ADFS в SQL Server**

1.  Войдите на сервер, используя SQL Server 2016 в качестве учетной записи локального администратора.

2.  Нажмите кнопку **Пуск**, выберите пункт **все программы**, щелкните **Microsoft SQL Server**и выберите **SQL Server Management Studio**.

3.  В окне **Подключение к серверу** убедитесь, что сервер, на котором размещена AD RMS базы данных, находится в поле **имя сервера** , а затем для проверки подлинности откройте раскрывающееся меню и выберите **SQL Server проверка подлинности**.

4.  В поле **Login** (имя входа) введите имя учетной записи локального администратора (например, локаладмин), а затем укажите соответствующий пароль и нажмите кнопку **подключить**.

5.  Разверните узел **Безопасность** , щелкните правой кнопкой мыши элемент **имена входа** и выберите пункт **создать имя входа** в появившемся контекстном меню.

6.  После того как окно появится в учетной записи администратора домена в поле **имя входа** (например, Contoso\\ContosoAdmin)

7.  В левой области навигации выберите **роли сервера**.

8.  Затем установите флажок для **sysadmin** в роли сервера и нажмите кнопку **ОК**.

9.  Перезапустите **управление SQL Server**.

10. В окне **Подключение к серверу** убедитесь, что сервер, на котором размещена AD RMS базы данных, находится в поле **имя сервера** , а затем для проверки подлинности в раскрывающемся меню выберите **Проверка подлинности Windows** и нажмите кнопку **подключить**.

##### <a name="restoring-the-ad-rms-and-adfs-databases-to-sql-server-2016"></a>Восстановление баз данных AD RMS и ADFS до SQL Server 2016

Следующие шаги демонстрируют, как восстановить данные из предыдущего экземпляра SQL Server в новый экземпляр 2016. Это позволит новому SQL использовать соответствующие данные конфигурации из предыдущих AD RMS и баз данных ADFS.

**Восстановление данных из предыдущего SQL Server в новую SQL Server**

1.  Войдите на сервер, используя SQL Server 2016 с соответствующей учетной записью.

2.  В левой области навигации щелкните правой кнопкой мыши **базы данных** и выберите команду **восстановить базу данных** , чтобы начать процесс восстановления.

3.  В разделе **источник** выберите **устройство** и найдите расположение, в котором файлы базы данных хранились на предыдущих шагах.

4.  После выбора файлов нажмите кнопку **ОК**.

5.  Убедитесь, что добавлены все файлы базы данных, и завершите процесс, нажав кнопку **ОК**.

### <a name="configuring-windows-server-2016-active-directory-federation-services-ad-fs"></a>Настройка Windows Server 2016 службы федерации Active Directory (AD FS) (AD FS)

AD FS была развернута для предоставления доступа на основе единого входа для AD RMS в качестве приложения. Он также настроен с помощью расширения AD RMS для мобильных устройств (MDE), которое обеспечивает поддержку Mac и мобильных устройств для конечных пользователей.

В следующих разделах приводятся рекомендации по работе с задачами, которые могут потребоваться для развертывания AD FS.

#### <a name="adding-a-2016-ad-fs-server-to-the-farm"></a>Добавление сервера AD FS 2016 в ферму

Для поддержки развертывания AD RMS можно развернуть дополнительные серверы AD FS. Это действие можно выполнить в случае увеличения трафика к AD RMSным серверам или дополнительным приложениям, или если необходимо снять один из серверов, используемых в данный момент для AD FS.

**Добавление сервера AD FS 2016 в ферму**

1.  На Azure AD Connect сервере дважды щелкните значок **Azure AD Connect** , чтобы запустить мастер Azure AD Connect.

2.  На странице приветствия нажмите кнопку **настроить**.

3.  На странице Дополнительные задачи щелкните **развернуть дополнительный сервер федерации** , а затем нажмите кнопку **Далее**.

4.  На странице Подключение к Azure AD введите имя пользователя и пароль учетной записи с глобальными разрешениями администратора, а затем нажмите кнопку **Далее**.

5.  На странице учетные данные администратора домена введите имя пользователя и пароль учетной записи с разрешениями администратора домена и нажмите кнопку **Далее**.

6.  Нажмите кнопку **Обзор** и выберите файл сертификата, используемый при настройке фермы AD FS с помощью Azure AD Connect.

7.  Щелкните **Ввод пароля** , чтобы открыть диалоговое окно пароль сертификата.

8.  Введите пароль сертификата в поле пароль и нажмите кнопку **ОК**.

9.  Нажмите кнопку **Далее**.

10. На странице серверы AD FS введите имя или IP-адрес нового сервера AD FS и нажмите кнопку **Добавить**.

11. На странице все готово для настройки нажмите кнопку **установить**.

12. На странице Установка завершена нажмите кнопку **выход**.

#### <a name="raising-the-adfs-farm-behavior-level"></a>Повышение уровня поведения фермы ADFS

При развертывании сервера ADFs, который превышает текущий уровень среды, например, при наличии ADFS на Windows Server 2012 R2 и последующем добавлении ADFS Windows Server 2016, необходимо увеличить уровень поведения фермы. Это необходимо для того, чтобы в среде использовалась самая последняя информация и функции.

**Повышение уровня поведения фермы ADFS**

1.  Перейдите к службам ADFS для Windows Server 2016.

2.  Откройте сеанс PowerShell администратора.

3.  Введите следующую команду: **\$CRED = Get-Credential** .

4.  Появится окно с запросом учетных данных и введите учетные данные администратора домена.

5.  Затем введите следующую команду: **Invoke-адфсфармбехавиорлевелраисе-Credential \$CRED**

6.  Появится запрос, **хотите ли вы продолжить выполнение этой операции?** Затем введите **,** чтобы принять приглашение.

7.  После выполнения команды уровень поведения фермы будет настроен и готов.

#### <a name="enabling-mobile-device-extension-logging"></a>Включение ведения журнала расширений для мобильных устройств

Расширение мобильного устройства может регистрировать запросы, получаемые от устройств конечных пользователей. Ведение журнала по умолчанию отключено, поэтому рекомендуется только включить ведение журнала в сценарии устранения неполадок. Все запросы, от мобильных устройств и настольных компьютеров, для начальной загрузки или получения лицензии на использование, записываются в AD RMS базу данных журналов или учетную запись хранения Azure. Ведение журнала MDE создает две дополнительные таблицы для SQL Server, используемых AD RMS: таблица журнала отладки клиента и таблица журнала производительности клиента.

**Включение ведения журнала расширений для мобильных устройств**

1.  На AD RMS сервере откройте Windows PowerShell с правами администратора.

2.  Введите следующую команду и нажмите клавишу **Ввод**: **Import-Module адрмсадмин**

3.  Введите следующую команду и нажмите клавишу **Ввод**: **New-PSDrive-Name Адрмсклустер-PsProvider адрмсадмин-root https://localhost**

4.  Введите следующую команду и нажмите клавишу **Ввод**: **Set-ItemProperty-Path адрмсклустер:\\-Name ислоггинженаблед-value \$true**

Если вы используете ведение журнала MDE для устранения неполадок, рекомендуем отключить его после устранения проблемы.

**Отключение ведения журнала расширения мобильного устройства**

1.  На AD RMS сервере откройте Windows PowerShell с правами администратора.

2.  Введите следующую команду и нажмите клавишу **Ввод**: **Import-Module адрмсадмин**

3.  Введите следующую команду и нажмите клавишу **Ввод**: **New-PSDrive-Name Адрмсклустер-PsProvider адрмсадмин-root https://localhost**

4.  Введите следующую команду и нажмите клавишу **Ввод**: **Set-ItemProperty-Path адрмсклустер:\\-Name ислоггинженаблед-value \$false.**

### <a name="upgrading-ad-rms-to-windows-server-2016"></a>Обновление AD RMS до Windows Server 2016

В следующих разделах приведены рекомендации по добавлению AD RMS сервера под управлением Windows Server 2016 в текущий кластер Windows Server 2012 R2. Сервер будет добавлен в кластер, и данные будут реплицированы на него, чтобы предыдущий AD RMS сервер можно было использовать для освобождения ресурсов.

После добавления одного AD RMS сервера под управлением Windows Server 2016 в кластер AD RMS все узлы, основанные на более старых версиях Windows, станут неактивными. После этого можно отменить предоставление этих серверов (например, завершение работы, повторное назначение или переустановку с Windows Server 2016 для приподключения к кластеру AD RMS). 

В кластер можно развернуть дополнительные серверы AD RMS, чтобы обеспечить поддержку нагрузки на развертывание AD RMS. Вы также можете выбрать выполнение этого действия в случае увеличения трафика на AD RMS серверах.

В этом руководстве не рассматриваются шаги, необходимые для изменения механизмов балансировки нагрузки, которые могут использоваться в вашей среде, чтобы исключить устаревшие серверы и включить в кластер те, которые вы добавляете. 

#### <a name="adding-a-2016-ad-rms-server"></a>Добавление сервера AD RMS 2016

Если кластер AD RMS использует аппаратный модуль безопасности вместо централизованно управляемого ключа для сертификата лицензиара сервера, необходимо установить программное обеспечение и другие артефакты HSM (например, файлы ключей и конфигурагтион) на сервере перед установкой AD RMS. Также необходимо подключить HSM-модуль к серверу, физически или с помощью соответствующих конфигураций сети. Следуйте указаниям модуля HSM для выполнения этих действий. 

**Добавление сервера AD RMS 2016**

1.  Установите роль AD RMS в нужном развертывании Windows Server 2016.

2.  После завершения установки щелкните ссылку, чтобы **выполнить дополнительную настройку**.

3.  Выберите **присоединиться к существующему кластеру AD RMS** и нажмите кнопку **Далее**.

4.  На странице **Выбор базы данных конфигурации** введите запись CNAME, указанную в DNS для 2016 SQL Server (FQDN).

5.  Щелкните **список** во второй строке и выберите **дефаултинстанце** из раскрывающегося списка.

6.  В разделе **имя базы данных конфигурации**откройте раскрывающееся меню и выберите конфигурацию DRM. Затем нажмите кнопку **Далее**.

7.  На странице **сведения о базе данных** введите пароль ключа кластера в указанном поле. После этого нажмите кнопку **Далее**.

8.  На следующей странице мастера укажите учетную запись службы AD RMS и укажите пароль для нее и нажмите кнопку **Далее** после ее проверки.

9.  После отображения страницы **веб-сайт кластера** просто убедитесь, что выбран соответствующий веб-сайт, и нажмите кнопку **Далее**.

10. На странице **Выбор сертификата проверки подлинности сервера** выберите ИМПОРТИРОВАНный SSL-сертификат и нажмите кнопку **Далее**.

11. Нажмите кнопку **Установить**, чтобы начать установку.

12. После завершения настройки необходимо выйти и снова войти в систему, чтобы администрировать AD RMS.

13. После входа в систему откройте **Диспетчер сервера** выберите **инструменты** , а затем **Active Directory Rights Management**. Появится окно управления, в котором будет указано, что в кластере есть дополнительный сервер.

14. Если расширение AD RMS для мобильных устройств было установлено в исходном AD RMS кластере, необходимо также установить MDE на обновленных узлах кластера. Следуйте инструкциям в документации по MDE, чтобы добавить MDE в кластер AD RMS. На этом этапе можно изменить назначение всех уже существующих узлов или обновить их до Windows Server 2016 и повторно присоединить их к кластеру AD RMS, используя описанный выше процесс. 

### <a name="configuring-windows-server-2016-web-application-proxy-wap"></a>Настройка прокси веб-приложения Windows Server 2016 (WAP)

В следующих разделах приводятся рекомендации по работе с задачами, которые могут потребоваться для развертывания прокси-приложения. Это необязательный шаг, который не требуется при публикации AD RMS в Интернете с помощью других механизмов. 

#### <a name="adding-a-windows-server-2016-wap-server"></a>Добавление сервера WAP Windows Server 2016

Вы можете развернуть дополнительные серверы прокси веб-приложений для поддержки развертывания AD RMS. Это действие можно выполнить в случае увеличения трафика на AD RMS серверах или при необходимости снять один из серверов, используемых в данный момент для прокси веб-приложения.

**Добавление сервера прокси веб-приложения 2016**

1.  На сервере, который вы хотите настроить в качестве прокси-службы, перейдите в консоль диспетчер сервера и щелкните **Добавить роли и компоненты**.

2.  В **мастере добавления ролей и компонентов**нажмите кнопку **Далее** , чтобы перейти на экран выбора роли сервера.

3.  На экране Выбор ролей сервера выберите **Удаленный доступ**, а затем нажмите кнопку **Далее** , пока не вернетесь на экран Выбор ролей сервера.

4.  На экране Выбор ролей сервера выберите **прокси веб-приложения**, щелкните **Добавить компоненты**, а затем нажмите кнопку **Далее**.

5.  На экране подтверждение выбора установки нажмите кнопку **установить**.

6.  После завершения установки нажмите кнопку **Закрыть**.

7.  Теперь настало время настроить сервер. Для этого откройте консоль управления удаленным доступом на сервере прокси веб-приложения. Откройте меню **Пуск** , введите **рамгмтуи. exe**, а затем выберите приложение.

8.  В панели навигации, щелкните **Прокси-служба веб-приложения**.

9.  В консоли управления удаленным доступом нажмите кнопку **Запуск мастера настройки прокси-сервера**. В мастере нажмите кнопку **Далее**.

10. На экране сервера федерации введите полное доменное имя сервера AD FS (например, adfs.contoso.com), а затем введите учетные данные администратора на AD FS сервере.

11. На экране AD FS proxy Certificate (сертификат прокси-сервера) в списке сертификатов, установленных в настоящее время на прокси-сервере приложения, выберите сертификат, который будет использоваться прокси-службой для AD FS прокси, а затем нажмите кнопку **Далее**.

12. На экране подтверждения просмотрите параметры и нажмите кнопку **настроить**.

13. После завершения настройки нажмите кнопку **Закрыть**.

#### <a name="dns-configuration-for-2016-wap-server"></a>Конфигурация DNS для сервера WAP 2016

После установки прокси-сервера Windows Server 2016 необходимо внести некоторые изменения в DNS. Для этого потребуется использовать службу, например GoDaddy, для указания служб ADFS и AD RMS Services на 2016 WAP-сервера.

**Указание DNS на сервере WAP**

1.  Перейдите на веб-сайт поставщика (например, GoDaddy).

2.  Перейдите в раздел Управление доменами, а затем — Управление DNS.

3.  Укажите службы ADFS и AD RMS, а затем замените **точки на** части общедоступным IP-адресом сервера WAP 2016 и **Сохраните**.

4.  Для распространения изменений может потребоваться время, но после выполнения этой установки будет завершена.

#### <a name="enabling-debugging-logs"></a>Включение журналов отладки

Подробные сведения о ведении журнала доступны на веб-серверах прокси-приложений. Можно настроить расширенное ведение журнала отладки с помощью Просмотр событий. Кроме того, можно выбрать дополнительные параметры для размера журналов, чтобы гарантировать, что аналитика будет полезной для средства просмотра.

**Включение журналов отладки для прокси веб-приложения**

1.  Откройте консоль **Просмотр событий** на прокси-сервере приложения.

2.  Разверните узел **Майкрософт** .

3.  Разверните узел **Windows** .

4.  Откройте журналы **прокси веб-приложения** .

5.  После этого вы сможете открыть журналы **администрирования** .

6.  Откройте меню **действие** , расположенное в верхнем левом углу, и выберите **свойства**.

7.  На вкладке **Общие** выберите параметр **включить ведение журнала**.

8.  Наконец, вы можете настроить максимальный размер журнала и то, что происходит при достижении максимального размера журнала событий.

### <a name="configuring-high-availability-for-windows-server-2016-services"></a>Настройка высокого уровня доступности для служб Windows Server 2016

В следующих разделах приводятся рекомендации по работе с задачами, которые могут потребоваться для настройки среды Windows Server 2016 в условиях высокой доступности.

#### <a name="adding-a-2016-ad-rms-server-for-high-availability"></a>Добавление сервера 2016 AD RMS для обеспечения высокой доступности

Чтобы настроить высокий уровень доступности, можно развернуть дополнительные серверы AD RMS. Это действие можно выполнить в случае увеличения трафика к AD RMSным серверам.

**Добавление сервера 2016 AD RMS для обеспечения высокой доступности**

1.  Установите роль AD RMS в нужном развертывании Windows Server 2016.

2.  После завершения установки щелкните ссылку, чтобы **выполнить дополнительную настройку**.

3.  Выберите **присоединиться к существующему кластеру AD RMS** и нажмите кнопку **Далее**.

4.  На странице **Выбор базы данных конфигурации** введите запись CNAME, указанную в DNS для 2016 SQL Server (FQDN).

5.  Щелкните **список** во второй строке и выберите **дефаултинстанце** из раскрывающегося списка.

6.  В разделе **имя базы данных конфигурации**откройте раскрывающееся меню и выберите конфигурацию DRM. Затем нажмите кнопку **Далее**.

7.  На странице **сведения о базе данных** введите пароль ключа кластера в указанном поле. После этого нажмите кнопку **Далее**.

8.  На следующей странице мастера укажите учетную запись службы AD RMS и укажите пароль для нее и нажмите кнопку **Далее** после ее проверки.

9.  После отображения страницы **веб-сайт кластера** просто убедитесь, что выбран соответствующий веб-сайт, и нажмите кнопку **Далее**.

10. На странице **Выбор сертификата проверки подлинности сервера** выберите ИМПОРТИРОВАНный SSL-сертификат и нажмите кнопку **Далее**.

11. Нажмите кнопку **Установить**, чтобы начать установку.

12. После завершения настройки необходимо выйти и снова войти в систему, чтобы администрировать AD RMS.

13. После входа в систему откройте **Диспетчер сервера** выберите **инструменты** , а затем **Active Directory Rights Management**. Появится окно управления, в котором будет указано, что в кластере есть дополнительный сервер.

14. После подтверждения установки сервера настройте службу балансировки нагрузки, чтобы сбалансировать нагрузку между различными серверами AD RMS в кластере.

#### <a name="adding-a-windows-server-2016-ad-fs-server-for-high-availability"></a>Добавление сервера Windows Server 2016 AD FS Server для обеспечения высокой доступности

Чтобы настроить высокий уровень доступности, можно развернуть дополнительные серверы AD FS. Это действие можно выполнить в случае увеличения трафика к AD FSным серверам. **Примечание. После повышения уровня поведения фермы в SQL Server 2016 (ADFS Configv3) будет введена новая запись базы данных, а перед продолжением выполнения этих действий необходимо удалить старую базу данных конфигурации.**

**Добавление сервера AD FS Windows Server 2016 для обеспечения высокой доступности**

1.  Установите роль AD RMS в нужном развертывании Windows Server 2016.

2.  После завершения установки выберите ссылку для **настройки службы федерации на этом сервере**.

3.  В разделе приветствия мастера выберите вариант **добавления сервера федерации в ферму серверов федерации** и нажмите кнопку **Далее**.

4.  Укажите правильную учетную запись администратора и нажмите кнопку **Далее**.

5.  На странице **Указание фермы** выберите параметр **указать расположение базы данных для существующей фермы, используя SQL Server** затем введите запись CNAME для службы SQL в поле имя узла базы данных и нажмите кнопку **Далее**.

6.  В области **Укажите учетную запись службы** мастера введите учетные данные учетной записи службы AD FS и нажмите кнопку **Далее**.

7.  В окне **Параметры проверки**нажмите кнопку **Далее**.

8.  Нажмите кнопку **настроить** , когда кнопка станет доступной.

9.  После настройки перезапустите компьютер.

10. После подтверждения установки сервера необходимо сбалансировать нагрузку серверов AD FS.

#### <a name="adding-a-windows-server-2016-wap-server-for-high-availability"></a>Добавление сервера WAP Windows Server 2016 для обеспечения высокой доступности

Вы можете развернуть дополнительные серверы WAP, чтобы настроить высокий уровень доступности. Это действие можно выполнить в случае увеличения трафика к AD RMSным серверам.

**Добавление прокси-сервера Windows Server 2016 для обеспечения высокой доступности**

1.  На сервере, который вы хотите настроить в качестве прокси-службы, перейдите в консоль диспетчер сервера и щелкните **Добавить роли и компоненты**.

2.  В **мастере добавления ролей и компонентов**нажмите кнопку **Далее** , чтобы перейти на экран выбора роли сервера.

3.  На экране Выбор ролей сервера выберите **Удаленный доступ**, а затем нажмите кнопку **Далее** , пока не вернетесь на экран Выбор ролей сервера.

4.  На экране Выбор ролей сервера выберите **прокси веб-приложения**, щелкните **Добавить компоненты**, а затем нажмите кнопку **Далее**.

5.  На экране подтверждение выбора установки нажмите кнопку **установить**.

6.  После завершения установки нажмите кнопку **Закрыть**.

7.  Теперь настало время настроить сервер. Для этого откройте консоль управления удаленным доступом на сервере прокси веб-приложения. Откройте меню **Пуск** , введите **рамгмтуи. exe**, а затем выберите приложение.

8.  В панели навигации, щелкните **Прокси-служба веб-приложения**.

9.  В консоли управления удаленным доступом нажмите кнопку **Запуск мастера настройки прокси-сервера**. В мастере нажмите кнопку **Далее**.

10. На экране сервера федерации введите полное доменное имя сервера AD FS (например, adfs.contoso.com), а затем введите учетные данные администратора на AD FS сервере.

11. На экране AD FS proxy Certificate (сертификат прокси-сервера) в списке сертификатов, установленных в настоящее время на прокси-сервере приложения, выберите сертификат, который будет использоваться прокси-службой для AD FS прокси, а затем нажмите кнопку **Далее**.

12. На экране подтверждения просмотрите параметры и нажмите кнопку **настроить**.

13. После завершения настройки нажмите кнопку **Закрыть**.

14. После подтверждения установки сервера необходимо сбалансировать нагрузку серверов WAP в ДЕМИЛИТАРИЗОВАНной зоне.

#### <a name="adding-a-sql-server-2016-node-for-always-on-high-availability"></a>Добавление узла SQL Server 2016 для обеспечения высокой доступности Always On

Можно развернуть дополнительные серверы SQL Server для установки Always On высокой доступности. Это действие можно выполнить в случае увеличения трафика к AD RMSным серверам. **Примечание. Убедитесь, что на обоих серверах SQL открыт входящий порт 5022.**

**Добавление сервера SQL Server 2016 для обеспечения высокой доступности Always On**

1.  На сервере, который вы хотите настроить в качестве дополнительного сервера SQL Server 2016, перейдите в консоль диспетчер сервера и щелкните **Добавить роли и компоненты**.

2.  Нажмите кнопку **Далее** в диалоговом окне **Выбор компонентов** .

3.  Установите флажок **отказоустойчивая кластеризация** . **Примечание. Выполните этот шаг для исходного сервера SQL Server 2016, чтобы оба сервера SQL Server имели функцию отказоустойчивой кластеризации.**

4.  Нажмите кнопку **установить** , чтобы установить компонент отказоустойчивой кластеризации.

5.  Теперь откройте **Диспетчер сервера** и выберите **инструменты** , а затем **Диспетчер отказоустойчивости кластеров**.

6.  В левой области меню щелкните правой кнопкой мыши **Диспетчер отказоустойчивости кластеров** и выберите команду **создать кластер** .

7.  Откроется **Мастер создания кластера**.

8.  Найдите серверы SQL Server 2016, которые будут использоваться для Always On высокий уровень доступности и введите их в, а затем нажмите кнопку **Далее**.

9.  Вы получите предупреждение проверки. Выберите **Да** , чтобы проверить узлы кластера, а затем нажмите кнопку **Далее**.

10. На странице **Параметры тестирования** выберите параметр **выполнить все тесты** и нажмите кнопку **Далее.**

11. **Примечание. Ожидается, что мастер проверки кластеров возвращает несколько предупреждающих сообщений, особенно если вы не будете использовать общее хранилище. Кроме того, при обнаружении любых сообщений об ошибках перед созданием отказоустойчивого кластера Windows Server необходимо исправить их**.

12. В диалоговом окне **точка доступа для администрирования кластера** введите имя кластера и виртуальный IP-адрес для отказоустойчивого кластера Windows Server, а затем нажмите кнопку **Далее**.

13. Проверьте успешность настройки в **сводке** и нажмите кнопку **Готово**.

14. Вернитесь в **Диспетчер отказоустойчивости кластеров,** щелкните кластер правой кнопкой мыши и выберите пункт **Дополнительные действия** , а затем выберите **Настройка параметров кворума кластера** .

15. Нажмите кнопку **Далее** и выберите параметр **выбрать следящий сервер кворума** и нажмите **Далее** еще раз.

16. На странице **Выбор следящего сервера кворума** выберите параметр **настроить файловый ресурс-свидетель** . Затем нажмите кнопку **Далее**.

17. Нажмите кнопку **Обзор** и найдите путь к общей папке, которую необходимо использовать в диалоговом окне путь к общей папке. Нажмите кнопку **Далее**.

18. На странице Подтверждение нажмите кнопку **Далее**.

19. На странице Сводка нажмите кнопку **Готово**.

20. Теперь откройте меню " **Пуск** " и выполните поиск по **Диспетчер конфигурации SQL Server**.

21. Щелкните правой кнопкой мыши имя SQL Server и выберите **Свойства**.

22. В диалоговом окне Свойства перейдите на вкладку **высокий уровень доступности AlwaysOn** . Установите флажок **Enable группы доступности AlwaysOn** . Нажмите кнопку **ОК**. **Примечание. Сделайте это на обоих серверах SQL Server 2016.**

23. Затем перезапустите службу SQL Server.

24. Теперь откройте меню " **Пуск** " и выполните поиск **SQL Server Management Studio** и в левой области навигации щелкните правой кнопкой мыши **группы доступности** и выберите пункт **Мастер создания группы доступности** , а затем нажмите кнопку **Далее**.

25. На странице **Указание имени группы доступности** выберите имя группы (например, SQLAvailabilityGroup2016). Затем нажмите кнопку **Далее**.

26. В разделе **Выбор баз данных** укажите базы данных. Затем нажмите кнопку Далее. **Примечание. возможно, потребуется выполнить резервное копирование некоторых баз данных или перевести его в режим полного восстановления**.

27. На странице **Выбор реплик** нажмите кнопку **Добавить реплику** и выберите другие 2016 SQL Server.

28. После добавления другого сервера установите флажки и установите вторичный сервер в качестве вторичного для чтения.

29. Перейдите на вкладку **конечные точки** и выберите параметр **Обновить** . Кроме того, прокрутите экран и убедитесь, что одна и та же учетная запись службы находится на основном и на вторичном узлах.

30. Теперь перейдите на вкладку **Параметры резервного копирования** и выберите вариант **предпочитать вторичный** .

31. Перейдите на вкладку **прослушиватель** .

32. Укажите имя (например, Скллистенер) и убедитесь, что порт равен **1433** , и нажмите кнопку **Далее**.

33. На странице **Выбор начальной синхронизации данных** мастера выберите параметр **полная** и укажите сетевое расположение, доступное всем серверам SQL Server, а затем нажмите кнопку **Далее**.

34. Наконец, нажмите кнопку **Готово** , и процесс завершится.

### <a name="decommission-windows-server-2012-r2-nodes"></a>Списание узлов Windows Server 2012 R2

В следующих разделах приводятся рекомендации по работе с задачами, которые могут потребоваться для удаления серверов Windows Server 2012 R2 после успешного обновления кластера AD RMS до Windows Server 2016.

#### <a name="removing-a-windows-server-2012-r2-ad-rms-server"></a>Удаление сервера AD RMS Windows Server 2012 R2

После обновления можно удалить ненужные AD RMS серверы. Вы можете выполнить это действие, когда оно понадобится для списания AD RMS серверов.

**Удаление** **сервера AD RMS Windows Server 2012 R2**

1.  На AD RMS сервере Windows Server 2012 R2 в диспетчер сервера выберите **Управление** в меню справа в верхнем правом углу, а затем выберите **Удалить роли и компоненты**.

2.  Откроется **Мастер удаления ролей и компонентов** и на экране **перед началом** работы нажмите кнопку **Далее**.

3.  На экране **выбора сервера** нажмите кнопку **Далее**.

4.  На экране **роли сервера** удалите флажок рядом с **службы Active Directory Rights Management** и нажмите кнопку **Далее**.

5.  На экране **компонентов** нажмите кнопку **Далее**.

6.  На экране **подтверждения** нажмите кнопку **Удалить**.

7.  После завершения этой работы перезапустите сервер.

8.  Теперь можно завершить работу сервера и перераспределить ресурсы по мере необходимости.
