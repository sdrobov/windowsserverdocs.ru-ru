---
title: Подготовка к миграции изолированного сервера федерации AD FS
description: Сведения о подготовке к миграции изолированного сервера AD FS в Windows Server 2012.
author: billmath
ms.author: billmath
manager: femila
ms.date: 06/28/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 0c1fd2bc1026d9aee25c591cf5c91a1c59f66ee0
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59834495"
---
#  <a name="prepare-to-migrate-a-stand-alone-ad-fs-federation-server-or-a-single-node-ad-fs-farm"></a>Подготовка к миграции изолированного сервера федерации AD FS или фермы AD FS с одним узлом  
 
Для подготовки к миграции (в том же сервере) изолированного сервера AD FS 2.0 федерации или фермы AD FS с одним узлом на Windows Server 2012, вам необходимо экспортировать и резервное копирование данных конфигурации AD FS с этого сервера.  
  
Чтобы экспортировать данные конфигурации AD FS, выполните следующие действия.  
  
-   [Шаг 1.  Экспорт параметров службы](#step-1-export-service-settings)  
  
-   [Шаг 2.  Экспорт отношений доверия поставщика утверждений](#step-2-export-claims-provider-trusts)  
  
-   [Шаг 3.  Экспорт отношений доверия проверяющей стороны](#step-3-export-relying-party-trusts)  
  
-   [Шаг 4.  Резервное копирование хранилищ настраиваемых атрибутов](#step-4-back-up-custom-attribute-stores)  
  
-   [Шаг 5.  Резервное копирование пользовательских настроек веб-страницы](#step-5-back-up-webpage-customizations)  
  
## <a name="step-1-export-service-settings"></a>Шаг 1. Экспорт параметров службы  
 Для того чтобы экспортировать параметры службы, выполните следующие действия.  
  
### <a name="to-export-service-settings"></a>Экспорт параметров службы  
  
1.  Зафиксируйте имя субъекта сертификата и значение отпечатка сертификата SSL, используемого службой федерации. Чтобы найти SSL-сертификат, откройте консоль управления служб IIS, выберите на левой панели элемент **Веб-сайт по умолчанию** , щелкните элемент **Привязки…** на панели **Действие** , найдите и выберите HTTPS-привязки, нажмите **Изменить**, а затем — **Просмотр**.  
  
> [!NOTE]
>  Кроме того, можно экспортировать SSL-сертификат, используемый службой федерации, и его закрытый ключ в PFX-файл. Дополнительные сведения см. в разделе [Экспорт части закрытого ключа сертификата проверки подлинности сервера](Export-the-Private-Key-Portion-of-a-Server-Authentication-Certificate.md).  
>   
>  Экспорт SSL-сертификата не является обязательным, потому что этот сертификат хранится в хранилище личных сертификатов на локальном компьютере и сохраняется при обновлении ОС.  
  
2.  Зафиксируйте конфигурацию сертификатов взаимодействия служб AD FS, сертификатов расшифровки и подписи токенов.  Для просмотра всех используемых сертификатов откройте Windows PowerShell и выполните следующую команду для добавления командлетов AD FS в сеанс Windows PowerShell: `PSH:>add-pssnapin “Microsoft.adfs.powershell”`. Затем выполните следующую команду для создания списка всех сертификатов, используемых в файле `PSH:>Get-ADFSCertificate | Out-File “.\certificates.txt”`.  
  
> [!NOTE]
>  Кроме того, помимо самозаверяющих сертификатов можно экспортировать любые сертификаты подписи токена, шифрования токена или взаимодействия служб и ключи, которые не создаются внутри организации. С помощью Windows PowerShell можно просмотреть все сертификаты, используемые на сервере. Откройте Windows PowerShell и выполните следующую команду, чтобы добавить командлеты AD FS в сеанс Windows PowerShell: `PSH:>add-pssnapin “Microsoft.adfs.powershell`. Затем выполните следующую команду для просмотра всех сертификатов, используемых на сервере `PSH:>Get-ADFSCertificate`. Результат выполнения этой команды содержит значения StoreLocation и StoreName, указывающие на расположение хранилища каждого сертификата. Затем можно воспользоваться инструкциями в статье [Экспорт части сертификата аутентификации сервера с закрытым ключом](Export-the-Private-Key-Portion-of-a-Server-Authentication-Certificate.md), чтобы экспортировать каждый сертификат и его закрытый ключ в PFX-файл.  
>   
>  Экспорт этих сертификатов не является обязательным, потому что все внешние сертификаты во время обновления операционной системы сохраняются.  
  
3.  Экспортируйте такие свойства службы федерации AD FS 2.0, как имя службы федерации, отображаемое имя службы федерации и идентификатор службы федерации в файл.  
  
Откройте Windows PowerShell и выполните следующую команду, чтобы добавить командлеты AD FS в сеанс Windows PowerShell и экспортировать свойства службы федерации: `PSH:>add-pssnapin “Microsoft.adfs.powershell”`. Затем выполните следующую команду для экспорта свойств службы федерации: `PSH:> Get-ADFSProperties | Out-File “.\properties.txt”`.  
  
Выходной файл будет содержать следующие важные значения конфигурации:  
  
    
|**Имя свойства службы федерации, предоставленное Get-ADFSProperties**|**Имя свойства службы федерации в консоли управления AD FS**|
|------|------|
|HostName|Имя службы федерации|  
|Идентификатор|Идентификатор службы федерации|  
|DisplayName|Отображаемое имя службы федерации|  
  
4.  Создайте резервную копию файла конфигурации приложения. Вместе с другими параметрами этот файл содержит строку подключения к базе данных политик.  
  
Чтобы создать резервную копию файла конфигурации приложения, необходимо вручную скопировать файл `%programfiles%\Active Directory Federation Services 2.0\Microsoft.IdentityServer.Servicehost.exe.config` в надежное расположение на резервном сервере.  
  
> [!NOTE]
>  Запишите строку подключения к базе данных, которая находится в этом файле сразу после строки "policystore connectionstring="). Если эта строка подключения указывает на базу данных SQL Server, то это значение понадобится при восстановлении исходной конфигурации AD FS на сервере федерации.  
>   
>  Ниже приводится пример строки подключения к базе данных WID: `“Data Source=\\.\pipe\mssql$microsoft##ssee\sql\query;Initial Catalog=AdfsConfiguration;Integrated Security=True"`. Следующий пример — строка подключения к базе данных SQL Server: `"Data Source=databasehostname;Integrated Security=True"`.  
  
5.  Запишите удостоверение учетной записи службы федерации AD FS 2.0 и пароль этой учетной записи.  
  
Чтобы найти значение удостоверения, просмотрите столбец **Вход от имени****службы Windows AD FS 2.0** в консоли **Службы** . Запишите это значение.  
  
> [!NOTE]
>  Для автономной службы федерации используется встроенная учетная запись NETWORK SERVICE.  В этом случае пароль не нужен.  
  
6.  Экспортируйте список задействованных конечных точек AD FS в файл.  
  
Для этого откройте Windows PowerShell и выполните следующую команду, чтобы добавить командлеты AD FS в сеанс Windows PowerShell: `PSH:>add-pssnapin “Microsoft.adfs.powershell”`. Затем выполните следующую команду для экспорта списка активированных конечных точек AD FS в файл: `PSH:> Get-ADFSEndpoint | Out-File “.\endpoints.txt”`.  
  
7.  Экспортируйте все пользовательские описания утверждений в файл.  
  
Для этого откройте Windows PowerShell и выполните следующую команду, чтобы добавить командлеты AD FS в сеанс Windows PowerShell: `PSH:>add-pssnapin “Microsoft.adfs.powershell”`. Затем выполните следующую команду, чтобы экспортировать описания пользовательских утверждений в файл: `Get-ADFSClaimDescription | Out-File “.\claimtypes.txt”`.  
  
##  <a name="step-2-export-claims-provider-trusts"></a>Шаг 2. Экспорт отношений доверия с поставщиком утверждений  
 Для того чтобы экспортировать отношения доверия с поставщиком утверждений, выполните следующие действия.  
  
### <a name="to-export-claims-provider-trusts"></a>Экспорт отношений доверия с поставщиком утверждений  
  
1.  Можно воспользоваться Windows PowerShell для экспорта всех отношений с поставщиком утверждений. Откройте Windows PowerShell и выполните следующую команду, чтобы добавить командлеты AD FS в сеанс Windows PowerShell: `PSH:>add-pssnapin “Microsoft.adfs.powershell”`. Затем выполните следующую команду для экспорта всех отношений с поставщиками утверждений: `PSH:>Get-ADFSClaimsProviderTrust | Out-File “.\cptrusts.txt”`.  
  
## <a name="step-3-export-relying-party-trusts"></a>Шаг 3. Экспорт отношений доверия с проверяющей стороной  
 Чтобы экспортировать отношения доверия с проверяющей стороной, выполните следующие действия.  
  
### <a name="to-export-relying-party-trusts"></a>Экспорт отношений доверия с проверяющей стороной  
  
1.  Откройте Windows PowerShell и выполните следующую команду, чтобы добавить командлеты AD FS в сеанс Windows PowerShell и экспортировать все отношения доверия с проверяющей стороной: `PSH:>add-pssnapin “Microsoft.adfs.powershell”`. Затем выполните следующую команду для экспорта всех отношений доверия с проверяющей стороной:`PSH:>Get-ADFSRelyingPartyTrust | Out-File “.\rptrusts.txt”`.  
  
## <a name="step-4-back-up-custom-attribute-stores"></a>Шаг 4. Резервное копирование хранилищ настраиваемых атрибутов  
 Сведения об используемых в AD FS хранилищах настраиваемых атрибутов можно найти с помощью Windows PowerShell. Откройте Windows PowerShell и выполните следующую команду, чтобы добавить командлеты AD FS в сеанс Windows PowerShell: `PSH:>add-pssnapin “Microsoft.adfs.powershell”`. Затем выполните следующую команду, чтобы найти сведения о хранилищах настраиваемых атрибутов: `PSH:>Get-ADFSAttributeStore`. Действия по обновлению или переносу пользовательских хранилищ атрибутов могут быть разными.  
  
## <a name="step-5-back-up-webpage-customizations"></a>Шаг 5. Резервное копирование пользовательских настроек веб-страницы  
 Чтобы выполнить резервное копирование пользовательских настроек веб-страницы, копируйте веб-страницы AD FS и файл **web.config** из каталога, сопоставленного виртуальному пути **“/adfs/ls”** , в IIS. По умолчанию он находится в каталоге **%systemdrive%\inetpub\adfs\ls**.  

## <a name="next-steps"></a>Следующие шаги
 [Подготовка к миграции сервера AD FS 2.0 Federation](prepare-to-migrate-ad-fs-fed-server.md)   
 [Подготовка к миграции прокси-сервера AD FS 2.0 Federation](prepare-to-migrate-ad-fs-fed-proxy.md)   
 [Перенос сервера AD FS 2.0 Federation](migrate-the-ad-fs-fed-server.md)   
 [Перенос прокси-сервера AD FS 2.0 Federation](migrate-the-ad-fs-2-fed-server-proxy.md)   
 [Миграция 1.1 веб-агентов AD FS](migrate-the-ad-fs-web-agent.md)