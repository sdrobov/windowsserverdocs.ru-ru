---
ms.assetid: 777aab65-c9c7-4dc9-a807-9ab73fac87b8
title: Настройка защиты блокировки экстрасети AD FS
description: ''
author: billmath
ms.author: billmath
manager: mtilman
ms.date: 05/20/2019
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 9ef595cc98a95caca0f2043b011868e0573a5b19
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71407706"
---
# <a name="ad-fs-extranet-lockout-and-extranet-smart-lockout"></a>AD FS для блокировки экстрасети и Smart-блокировки экстрасети

## <a name="overview"></a>Обзор

Интеллектуальная блокировка экстрасети (ЕСЛ) обеспечивает защиту пользователей от вредоносных действий из-за блокировки учетной записи экстрасети.  

ЕСЛ позволяет AD FS различать попытки входа из знакомого расположения пользователя и попытки входа от того, что может быть злоумышленником. AD FS может блокировать злоумышленники, позволяя пользователям продолжать использовать свои учетные записи. Это предотвращает защиту от отказа в обслуживании и определенных классов атак типа «распыление паролей» для пользователя. ЕСЛ доступен для AD FS в Windows Server 2016 и встроен в AD FS в Windows Server 2019.

ЕСЛ доступен только для запросов проверки подлинности имени пользователя и пароля, которые проходят через экстрасеть с прокси веб-приложения или с помощью стороннего прокси-сервера. Любой сторонний прокси-сервер должен поддерживать протокол MS-АДФСПИП, который будет использоваться вместо прокси-службы веб приложения, например, с помощью [диспетчера политики доступа F5 BIG-IP](https://devcentral.f5.com/s/articles/ad-fs-proxy-replacement-on-f5-big-ip-30191). Обратитесь к документации стороннего прокси-сервера, чтобы определить, поддерживает ли прокси-сервер протокол MS-АДФСПИП.   

## <a name="additional-features-in-ad-fs-2019"></a>Дополнительные функции в AD FS 2019
Интеллектуальная блокировка экстрасети в AD FS 2019 добавляет следующие преимущества по сравнению с AD FS 2016:
- Установите независимые пороговые значения блокировки для привычных и незнакомых расположений, чтобы пользователи в известных местах могли получить больше места для ошибки, чем запросы из подозрительных расположений.
- Включите режим аудита для интеллектуальной блокировки, продолжая применять предыдущее поведение программной блокировки. Это позволяет узнать о пользователях, привычных для пользователей, и по-прежнему защищаться функцией блокировки экстрасети, доступной в AD FS 2012 R2.  

## <a name="how-it-works"></a>Принцип работы
### <a name="configuration-information"></a>Сведения о конфигурации
Если есл включен, создается новая таблица в базе данных артефактов, Адфсартифактсторе. Аккаунтактивити, и узел выбирается в AD FS ферме как Главная реплика "активность пользователей". В конфигурации WID этот узел всегда является основным узлом. В конфигурации SQL один узел выбирается как хозяин действий пользователя.  

Для просмотра узла, выбранного в качестве хозяина действий пользователя. Get-Адфсфарминформатион. Фармролес

Все вторичные узлы будут обращаться к главному узлу по каждому новому имени входа через порт 80 для получения последнего значения счетчика недопустимых паролей и новых значений расположения и обновления узла после обработки имени входа.

![настройка](media/configure-ad-fs-extranet-smart-lockout-protection/esl1.png)

 Если вторичный узел не может связаться с главным узлом, он записывает события ошибок в журнал AD FS администратора. Проверки подлинности будут продолжать обрабатываться, но AD FS будет записывать только обновленное состояние локально. AD FS повторит попытку связи с главным сервером каждые 10 минут и вернется к главному серверу после того, как станет доступен главный сервер.

### <a name="terminology"></a>Терминология
- **Фамилиарлокатион**: Во время запроса проверки подлинности есл проверяет все предоставленные IP-адреса. Эти IP-адреса будут представлять собой комбинацию сетевого IP, перенаправленного IP-адреса и необязательного IP-адреса пересылки x. Если запрос выполнен успешно, все IP-адреса добавляются в таблицу действия учетной записи как «знакомые IP-адреса». Если в запросе есть все IP-адреса, представленные в "знакомых IP-адресах", запрос будет рассматриваться как "знакомое" расположение.
- **Ункновнлокатион**: Если в существующем списке "Фамилиарлокатион" отсутствует хотя бы один IP-адрес, запрос будет рассматриваться как "неизвестное" расположение. Это необходимо для обработки сценариев прокси, таких как устаревшая проверка подлинности Exchange Online, при которой адреса Exchange Online обрабатывали успешные и неудачные запросы.  
- **badPwdCount**: Значение, представляющее число попыток отправки неверного пароля и неудачной проверки подлинности. Для каждого пользователя отдельные счетчики хранятся для привычных расположений и неизвестных расположений.
- **Ункновнлоккаут**: Логическое значение на пользователя, если пользователь заблокирован от доступа из неизвестных расположений. Это значение вычисляется на основе значений Бадпвдкаунтунфамилиар и ExtranetLockoutThreshold.
- **ExtranetLockoutThreshold**: Это значение определяет максимальное число неудачных попыток ввода пароля. По достижении порогового значения ADFS отклоняет запросы из экстрасети до тех пор, пока не будет пройдено окно наблюдения.
- **Екстранетобсерватионвиндов**: Это значение определяет продолжительность блокировки запросов username и Password из неизвестных расположений. После передачи этого окна ADFS начнет выполнять проверку подлинности имени пользователя и пароля из неизвестных расположений снова.
- **Екстранетлоккаутрекуирепдк**: При включении блокировки экстрасети требуется основной контроллер домена (PDC). Если этот параметр отключен, блокировка экстрасети будет переключаться на другой контроллер домена в случае недоступности PDC.  
- **Екстранетлоккаутмоде**: Управляет только тем, что в противном случае включен режим Smart-блокировки экстрасети.
    - **Адфссмартлоккаутлогонли**: Интеллектуальная блокировка экстрасети включена, но AD FS будет записывать только события администратора и аудита, но не будет отклонять запросы проверки подлинности. Этот режим изначально должен быть включен для заполнения Фамилиарлокатион до включения "Адфссмартлоккаутенфорце".
    - **Адфссмартлоккаутенфорце**: Полная поддержка блокирования неизвестных запросов проверки подлинности при достижении пороговых значений.

Поддерживаются адреса IPv4 и IPv6.

### <a name="anatomy-of-a-transaction"></a>Анатомия транзакции
- **Проверка перед проверкой подлинности**: Во время запроса проверки подлинности есл проверяет все предоставленные IP-адреса. Эти IP-адреса будут представлять собой комбинацию сетевого IP, перенаправленного IP-адреса и необязательного IP-адреса пересылки x. В журналах аудита эти IP-адреса указаны в <IpAddress> поле в порядке x – MS-forwardd-Client-IP, x-forwardd-for, x-MS-Proxy-Client-IP.

  Основываясь на этих IP-адресах, ADFS определяет, находится ли запрос из знакомого или неизвестного расположения, а затем проверяет, меньше ли соответствующий badPwdCount, чем установленное предельное значение, или если последняя **неудачная** попытка была выполнена дольше окна наблюдения. NOFRAMES. Если одно из этих условий истинно, ADFS допускает эту транзакцию для дальнейшей обработки и проверки учетных данных. Если оба условия имеют значение false, учетная запись уже находится в заблокированном состоянии до тех пор, пока не будет пройдено окно наблюдения. После успешного прохождения окна наблюдения пользователю будет разрешена одна попытка проверки подлинности. Обратите внимание, что в 2019 службы ADFS проверяют соответствующий пороговый предел в зависимости от того, соответствует ли IP-адрес известному расположению.
- **Успешный вход**: Если вход выполнен, то IP-адреса из запроса будут добавлены в привычный список адресов для пользователя.  
- **Ошибка входа**: Если при входе происходит сбой, badPwdCount увеличивается. Пользователь перейдет в состояние блокировки, если злоумышленник получит в системе более неправильные пароли, чем разрешено пороговым значением. (badPwdCount > ExtranetLockoutThreshold)  

![настройка](media/configure-ad-fs-extranet-smart-lockout-protection/esl2.png)

Значение "Ункновнлоккаут" будет равно true, если учетная запись заблокирована. Это означает, что badPwdCount пользователя превышает пороговое значение, т. е. кто-то попытался больше паролей, чем разрешено системой. В этом состоянии существует два способа входа в систему с помощью допустимого пользователя.
- Пользователь должен дождаться Обсерватионвиндов времени ожидания или
- Чтобы сбросить состояние блокировки, сбросьте badPwdCount обратно к нулю с помощью "Reset-Адфсаккаунтлоккаут".

Если перезагрузка не выполняется, учетной записи будет разрешена одна попыток ввода пароля для AD для каждого окна наблюдения. После этой попытки учетная запись вернется в заблокированное состояние, и окно наблюдения будет перезапущено. Значение badPwdCount будет сброшено автоматически только после успешного входа в систему с паролем.

### <a name="log-only-mode-versus-enforce-mode"></a>Режим "только журнал", а не режим "принудительно"
Таблица Аккаунтактивити заполняется как в режиме "только для журнала", так и в режиме "принудительно". Если режим "только журнал" пропускается и есл перемещается непосредственно в режим принудительного применения без рекомендуемого периода ожидания, известные IP-адреса пользователей не будут известны ADFS. В этом случае есл будет вести себя как "Адбадпассвордкаунтер", потенциально блокируя законный пользовательский трафик, если учетная запись пользователя находится под активной атакой методом подбора. Если режим "только журнал" обходится и пользователь переходит в заблокированное состояние с параметром "Ункновнлоккаут" = TRUE и пытается войти с помощью хорошего пароля из IP-адреса, который не находится в списке "знакомый", он не сможет войти в систему. В течение 3-7 дней рекомендуется использовать режим "только журнал", чтобы избежать этого сценария. Если учетные записи активно подвержены атакам, необходимо как минимум 24 часа в режиме "только журнал", чтобы предотвратить блокировку законных пользователей.  

## <a name="extranet-smart-lockout-configuration"></a>Конфигурация Smart-блокировки экстрасети  

### <a name="prerequisites-for-ad-fs-2016"></a>Необходимые компоненты для AD FS 2016

1. **Установка обновлений на всех узлах фермы**

   Во-первых, убедитесь, что все серверы Windows Server 2016 AD FS обновлены в соответствии с обновлениями Windows за июнь 2018 и что ферма AD FS 2016 работает на уровне поведения фермы 2016.
1. **Проверка разрешений**

   Интеллектуальная блокировка экстрасети требует включения удаленного управления Windows на каждом AD FS сервере.
3. **Обновление разрешений базы данных артефактов**

   Интеллектуальная блокировка экстрасети требует, чтобы учетная запись службы AD FS была иметь разрешения на создание новой таблицы в базе данных артефактов AD FS. Войдите на любой AD FS сервер в качестве администратора AD FS, а затем предоставьте это разрешение, выполнив следующие команды в окне командной строки PowerShell:

   ``` powershell
   PS C:\>$cred = Get-Credential
   PS C:\>Update-AdfsArtifactDatabasePermission -Credential $cred
   ```
   >[!NOTE]
   >Заполнитель $cred — это учетная запись с правами администратора AD FS. Он должен предоставить разрешения на запись для создания таблицы.

   Приведенные выше команды могут завершиться сбоем из-за отсутствия достаточных разрешений, так как AD FS ферма использует SQL Server, а указанные выше учетные данные не имеют разрешения администратора на сервере SQL Server. В этом случае можно вручную настроить разрешения базы данных в SQL Server базе данных, выполнив следующую команду при подключении к базе данных Адфсартифактсторе.
    ```  
    # when prompted with “Are you sure you want to perform this action?”, enter Y.

    [CmdletBinding(SupportsShouldProcess=$true,ConfirmImpact = 'High')]
    Param()

    $fileLocation = "$env:windir\ADFS\Microsoft.IdentityServer.Servicehost.exe.config"

    if (-not [System.IO.File]::Exists($fileLocation))
    {
    write-error "Unable to open ADFS configuration file."
    return
    }

    $doc = new-object Xml
    $doc.Load($fileLocation)
    $connString = $doc.configuration.'microsoft.identityServer.service'.policystore.connectionString
    $connString = $connString -replace "Initial Catalog=AdfsConfigurationV[0-9]*", "Initial Catalog=AdfsArtifactStore"

    if ($PSCmdlet.ShouldProcess($connString, "Executing SQL command sp_addrolemember 'db_owner', 'db_genevaservice' "))
    {
    $cli = new-object System.Data.SqlClient.SqlConnection
    $cli.ConnectionString = $connString
    $cli.Open()

    try
    {     

    $cmd = new-object System.Data.SqlClient.SqlCommand
    $cmd.CommandText = "sp_addrolemember 'db_owner', 'db_genevaservice'"
    $cmd.Connection = $cli
    $rowsAffected = $cmd.ExecuteNonQuery()  
    if ( -1 -eq $rowsAffected )
    {
    write-host "Success"
    }
    }
    finally
    {
    $cli.CLose()
    }
    }
    ```

### <a name="ensure-ad-fs-security-audit-logging-is-enabled"></a>Проверка включения ведения журнала аудита безопасности AD FS
Эта функция использует журналы аудита безопасности, поэтому необходимо включить аудит в AD FS, а также локальную политику на всех серверах AD FS.

### <a name="configuration-instructions"></a>Инструкции по настройке
Интеллектуальная блокировка экстрасети использует свойство ADFS **екстранетлоккаутенаблед**. Это свойство ранее использовалось для управления "мягкой блокировкой в экстрасети" на сервере 2012 R2. Если вы включили мягкую блокировку в экстрасети, для просмотра текущей конфигурации ` Get-AdfsProperties` свойств выполните команду.

### <a name="configuration-recommendations"></a>Рекомендации по настройке
При настройке Smart-блокировки экстрасети следуйте рекомендациям по установке пороговых значений:  

`ExtranetObservationWindow (new-timespan -Minutes 30)`

`ExtranetLockoutThreshold: – 2x AD Threshold Value`

Значение рекламы: 20, ExtranetLockoutThreshold: 10

Active Directory Блокировка работает независимо от Smart-блокировки экстрасети. Однако если Active Directory блокировка включена, ExtranetLockoutThreshold в AD FS < пороговое значение блокировки учетной записи в Active Directory

`ExtranetLockoutRequirePDC - $false`

При включении блокировки экстрасети требуется основной контроллер домена (PDC). Если отключить и настроить значение false, блокировка экстрасети будет переключаться на другой контроллер домена в случае недоступности PDC.

Чтобы установить это свойство, выполните следующую команду:

``` powershell
Set-AdfsProperties -EnableExtranetLockout $true -ExtranetLockoutThreshold 15 -ExtranetObservationWindow (new-timespan -Minutes 30) -ExtranetLockoutRequirePDC $false
```
### <a name="enable-log-only-mode"></a>Включить режим "только журнал"

В режиме «только журнал» AD FS заполняет пользователей знакомые сведения о расположении и записывает события аудита безопасности, но не блокирует запросы. Этот режим используется для проверки того, что выполняется интеллектуальная блокировка, и позволяет AD FS "Знакомство с привычными местами для пользователей" перед включением режима "принудительно". Как AD FS учиться, он сохраняет активность входа на пользователя (в режиме только журнала или принудительном режиме).
Установите режим блокировки, чтобы он заработал в журнал, выполнив следующую командлет.  

`Set-AdfsProperties -ExtranetLockoutMode AdfsSmartlockoutLogOnly`

Режим "только журнал" должен быть временным состоянием, чтобы система могла изучить поведение входа, прежде чем приступать к принудительному применению блокировки с помощью функции Smart-блокировки. Рекомендуемая продолжительность режима только для журнала составляет 3-7 дней. Если учетные записи активно подвержены атакам, то режим только для входа должен выполняться не менее 24 часов.

В AD FS 2016, если режим "Мягкая блокировка экстрасети" включен, прежде чем включить интеллектуальную блокировку экстрасети, в режиме "только для входа" будет отключено поведение "Мягкая блокировка экстрасети". AD FS интеллектуальная блокировка не будет блокировать пользователей в режиме "только журнал". Однако локальная служба AD может блокировать пользователя на основе конфигурации AD. Проверьте политики блокировки AD, чтобы узнать, как локальная служба AD может заблокировать пользователей.

В AD FS 2019 дополнительное преимущество заключается в том, чтобы включить режим "только журнал" для Smart-блокировки, продолжая принудительно использовать предыдущее поведение с мягкой блокировкой, используя приведенную ниже команду PowerShell.

`Set-AdfsProperties -ExtranetLockoutMode 3`

Чтобы новый режим вступил в силу, перезапустите службу AD FS на всех узлах фермы.

`Restart-service adfssrv`

После настройки режима можно включить Smart-блокировку с помощью параметра Енабликстранетлоккаут

`Set-AdfsProperties -EnableExtranetLockout $true`

### <a name="enable-enforce-mode"></a>Включить режим принудительного применения

После того, как вы будете знакомы с пороговым значением блокировки и окном наблюдения, есл можно переместить в режим "принудительно" с помощью следующего командлета КОМАНДНОМ PSH:

`Set-AdfsProperties -ExtranetLockoutMode AdfsSmartLockoutEnforce`

Чтобы новый режим вступил в силу, перезапустите службу AD FS на всех узлах фермы с помощью следующей команды.

`Restart-service adfssrv`

## <a name="manage-user-account-activity"></a>Управление действиями с учетной записью пользователя
AD FS предоставляет три командлета для управления данными о действиях с учетной записью. Эти командлеты автоматически подключаются к узлу в ферме, в которой находится главная роль.
>[!NOTE]
>Можно использовать достаточно администрирования (JEA) для делегирования AD FS командлеты для сброса блокировок учетных записей. Например, персонал службы поддержки может делегировать разрешения на использование есл командлеты. Сведения о делегировании разрешений для использования этих командлетов см. [в разделе Delegate AD FS PowerShell командлет доступ к пользователям без прав администратора](delegate-ad-fs-pshell-access.md) .

Это поведение можно переопределить, передав параметр-Server.

- Get-Адфсаккаунтактивити-UserPrincipalName

  Чтение текущего действия учетной записи для учетной записи пользователя. Командлет всегда автоматически подключается к главному узлу фермы с помощью конечной точки действия учетной записи. Поэтому все данные всегда должны быть одинаковыми.

`Get-ADFSAccountActivity user@contoso.com`

  Свойства
    - Бадпвдкаунтфамилиар: Увеличивается при успешном выполнении проверки подлинности из известного расположения.
    - Бадпвдкаунтункновн: Увеличивается при неудачной проверке подлинности из неизвестного расположения
    - Ластфаиледаусфамилиар: Если проверка подлинности завершилась неудачно из привычного расположения, Ластфаиледаусункновн задается время неудачной проверки подлинности.
    - Ластфаиледаусункновн: Если проверка подлинности завершилась неудачно из неизвестного расположения, Ластфаиледаусункновн задается время неудачной проверки подлинности.
    - Фамилиарлоккаут: Логическое значение, которое будет равно "true", если "Бадпвдкаунтфамилиар" > ExtranetLockoutThreshold
    - Ункновнлоккаут: Логическое значение, которое будет равно "true", если "Бадпвдкаунтункновн" > ExtranetLockoutThreshold  
    - Фамилиарипс: максимум 20 IP-адресов, которые знакомы пользователю. При превышении этого порога самый старый IP-адрес в списке будет удален.
-    Set-Адфсаккаунтактивити

     Добавляет новые знакомые расположения. Список известных IP-адресов может содержать не более 20 записей. при превышении этого значения самый старый IP-адрес в списке будет удален.

`Set-ADFSAccountActivity user@contoso.com -AdditionalFamiliarIps “1.2.3.4”`

- Reset-Адфсаккаунтлоккаут

  Сбрасывает счетчик блокировки для учетной записи пользователя для каждого привычного расположения (Бадпвдкаунтфамилиар) или неизвестного счетчика расположения (Бадпвдкаунтунфамилиар). При сбросе счетчика значение "Фамилиарлоккаут" или "Унфамилиарлоккаут" будет обновляться, так как счетчик сброса будет меньше порогового значения.  

`Reset-ADFSAccountLockout user@contoso.com -Location Familiar`
`Reset-ADFSAccountLockout user@contoso.com -Location Unknown`

## <a name="event-logging--user-activity-information-for-ad-fs-extranet-lockout"></a>Ведение журнала событий & сведения о действиях пользователей для блокировки AD FS экстрасети

### <a name="connect-health"></a>Подключение к работоспособности
Для наблюдения за действиями с учетными записями пользователей рекомендуется использовать Connect Health. Connect Health создает загружаемый отчет о рискованных IP-адресах и неудачных попытках ввода пароля. Каждый элемент в отчете о рискованных IP-адресах показывает агрегированные сведения о неудачных AD FS действиях входа, которые превышают заданное пороговое значение. Уведомления по электронной почте могут быть настроены на оповещение администраторам, как только это происходит с настраиваемыми параметрами электронной почты. Дополнительные сведения и инструкции по установке см. в [документации по Connect Health](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-health-adfs).

### <a name="ad-fs-extranet-smart-lockout-events"></a>AD FS события Smart-блокировки экстрасети.
Для записи событий Smart-блокировки экстрасети есл должны быть включены в режиме "только для входа" или "принудительно", а аудит безопасности ADFS включен.
AD FS будет записывать события блокировки экстрасети в журнал аудита безопасности:
- При блокировке пользователя (достигает порогового значения блокировки для неудачных попыток входа)
- Когда AD FS получает попытку входа для пользователя, который уже находится в состоянии блокировки

В режиме "только журнал" можно проверить журнал аудита безопасности на наличие событий блокировки. Для всех обнаруженных событий можно проверить пользовательское состояние с помощью командлета Get-Адфсаккаунтактивити, чтобы определить, произошла ли блокировка от знакомых или незнакомых IP-адресов, и дважды проверить список известных IP-адресов для этого пользователя.


|Идентификатор события|Описание|
|-----|-----|
|1203|Это событие записывается для каждой неправильной попытки ввода пароля. Как только badPwdCount достигнет значения, указанного в ExtranetLockoutThreshold, учетная запись будет заблокирована в ADFS в течение времени, указанного в Екстранетобсерватионвиндов.</br>Идентификатор действия:% 1</br>XML:% 2|
|1201|Это событие записывается каждый раз, когда пользователь блокируется. </br>Идентификатор действия:% 1</br>XML:% 2|
|557 (ADFS 2019)| Произошла ошибка при попытке связаться со службой RESTful хранилища учетных записей на узле% 1. Если это ферма WID, основной узел может находиться в автономном режиме. Если это ферма SQL, ADFS автоматически выберет новый узел, на котором будет размещена роль хозяина хранилища пользователей.|
|562 (ADFS 2019)|Произошла ошибка при коммункатинг с конечной точкой хранилища учетных записей на сервере% 1.</br>Сообщение об исключении:% 2|
|563 (ADFS 2019)|Произошла ошибка при вычислении состояния блокировки экстрасети. Из-за значения параметра% 1 Проверка подлинности будет разрешено для этого пользователя, и выдача маркера будет продолжена. Если это ферма WID, основной узел может находиться в автономном режиме. Если это ферма SQL, ADFS автоматически выберет новый узел, на котором будет размещена роль хозяина хранилища пользователей.</br>Имя сервера хранилища учетных записей:% 2</br>Идентификатор пользователя:% 3</br>Сообщение об исключении:% 4|
|512|Учетная запись для следующего пользователя заблокирована. Попытка входа разрешена из-за конфигурации системы.</br>Идентификатор действия:% 1 </br>Пользователь:% 2 </br>IP-адрес клиента:% 3 </br>Число недопустимых паролей:% 4  </br>Последняя неудачная попытки пароля:% 5|
|515|Следующая учетная запись пользователя находилась в заблокированном состоянии, а правильный пароль был только что указан. Эта учетная запись может быть скомпрометирована.</br>Дополнительные данные </br>Идентификатор действия:% 1 </br>Пользователь:% 2 </br>IP-адрес клиента:% 3 |
|516|Следующая учетная запись пользователя заблокирована из-за слишком большого числа неудачных попыток ввода пароля.</br>Идентификатор действия:% 1  </br>Пользователь:% 2  </br>IP-адрес клиента:% 3  </br>Число недопустимых паролей:% 4  </br>Последняя неудачная попытки пароля:% 5|

## <a name="esl-frequently-asked-questions"></a>ЕСЛ часто задаваемые вопросы

**Будет ли ферма ADFS, использующая интеллектуальный режим блокировки экстрасети в режиме принудительного выполнения, станет заблокирована злоумышленниками?** 

Ответ. Если для Smart-блокировки ADFS задан режим "принудительно", то учетная запись легального пользователя никогда не будет отображаться с помощью принудительного подбора или отказа в обслуживании. Единственный способ блокировки вредоносной учетной записи может препятствовать входу пользователя в систему, если у неверного субъекта есть пароль пользователя или он может отправить запросы с известного (знакомого) IP-адреса этого пользователя. 

**Что происходит, если есл включен и у неправильного субъекта есть пароль пользователя?** 

Ответ. Типичная цель атаки методом подбора заключается в том, чтобы угадать пароль и успешно войти в систему.  Если пользователь подписывается или направляется пароль, функция есл не блокирует доступ, так как вход будет удовлетворять критерию "успешно" для правильного пароля и нового IP-адреса. Неверный IP-адрес актеров будет выглядеть как «знакомый». Лучшим решением в этом случае является очистка действий пользователя в ADFS и требование многофакторной проверки подлинности для пользователей. Настоятельно рекомендуется установить защиту паролем AAD, которая гарантирует, что пароли не будут перебираться в систему.

**Если пользователь никогда не выполнил вход с IP-адреса и попытается ввести неправильный пароль несколько раз, он сможет войти в систему после того, как они будут правильно введены пароль?** 

Ответ. Если пользователь отправляет несколько недопустимых паролей (т. е. с неправильным вводом), а при следующей попытке получается правильный пароль, то пользователь сразу же сможет войти в систему.  Это приведет к очистке неправильного числа паролей и добавлению этого IP-адреса в список Фамилиарипс.  Однако если они попадают выше порогового значения неудачных попыток входа из неизвестного расположения, они будут переведены в состояние блокировки, и им потребуется подождать появления окна наблюдения и войти в систему с действительным паролем или запросить вмешательство администратора для сброса учетной записи.  
 
**Работает ли есл в интрасети?**

Ответ. Если клиенты подключаются непосредственно к серверам AD FS, а не через прокси-серверы, то поведение есл не будет применено.  

**Я вижу IP-адреса Майкрософт в поле клиентский IP-адрес. Блокирует ли есл атаки методом подбора ЕКСО с использованием прокси-сервера?**  

Ответ. ЕСЛ будет хорошо работать для предотвращения атак Exchange Online или других устаревших сценариев с методом подбора для проверки подлинности. Устаревшая проверка подлинности имеет идентификатор действия 00000000-0000-0000-0000-000000000000. В этих атаках плохой субъект использует преимущества обычной проверки подлинности Exchange Online (также известную как устаревшая проверка подлинности), чтобы IP-адрес клиента появился в качестве корпорации Майкрософт. Серверы Exchange Online в облачной прокси-службе продают проверку подлинности от имени клиента Outlook. В этих сценариях IP-адрес вредоносной подсети будет иметь значение x-MS-Forwarded-Client-IP, а IP-адреса Microsoft Exchange Online Server — в значении x-MS-Client-IP.
Интеллектуальная блокировка экстрасети проверяет сетевые IP-адреса, перенаправляемые IP-адреса, перенаправляемые по оси x и IP-адреса. Если запрос выполнен успешно, все IP-адреса добавляются в знакомый список. Если запрос поступает и любой из предоставленных IP-адресов не находится в привычном списке, запрос будет помечен как незнакомый. Знакомый пользователь сможет успешно войти, пока запросы из незнакомых расположений будут заблокированы.  

\* * ВОПРОС. Можно ли оценить размер Адфсартифактсторе перед включением есл?

Ответ. При включенном есл AD FS отслеживает действия учетной записи и известные расположения для пользователей в базе данных Адфсартифактсторе. Размер этой базы данных масштабируется относительно числа отслеживаемых пользователей и известных расположений. При планировании включения есл можно оценить размер базы данных Адфсартифактсторе, чтобы она увеличивалась с частотой до 1 ГБ на 100 000 пользователей. Если AD FS ферма использует внутреннюю базу данных Windows (WID), расположением по умолчанию для файлов базы данных является К:\виндовс\вид\дата\.. Чтобы предотвратить заполнение этого диска, перед включением есл убедитесь, что у вас есть как минимум 5 ГБ свободного хранилища. Помимо дискового пространства, следует запланировать общий объем памяти процесса для увеличения после включения есл до дополнительной 1 ГБ ОЗУ для заполнения пользователем 500 000 или менее.


## <a name="additional-references"></a>Дополнительная справка  
[Рекомендации по обеспечению безопасности службы федерации Active Directory (AD FS)](../../ad-fs/deployment/best-practices-securing-ad-fs.md)

[Set-AdfsProperties](https://technet.microsoft.com/itpro/powershell/windows/adfs/set-adfsproperties)

[Операции AD FS](../../ad-fs/AD-FS-2016-Operations.md)
