---
ms.assetid: 963a3d37-d5f1-4153-b8d5-2537038863cb
title: Рекомендации по безопасному планированию и развертыванию AD FS
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 55f68886bc5e782feb76b5005b15622881f42f6a
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86964466"
---
# <a name="best-practices-for-secure-planning-and-deployment-of-ad-fs"></a>Рекомендации по безопасному планированию и развертыванию AD FS


В этом разделе содержатся рекомендации по планированию и оценке безопасности при проектировании развертывания службы федерации Active Directory (AD FS) (AD FS). Этот раздел является отправной точкой для просмотра и оценки вопросов, влияющих на общую безопасность использования AD FS. Сведения в этом разделе дополняют и расширяют существующие рекомендации по планированию безопасности и другие передовые практики в области разработки.  
  
## <a name="core-security-best-practices-for-ad-fs"></a>Ключевые рекомендации по безопасности AD FS  
Следующие основные рекомендации являются общими для всех AD FS установок, в которых требуется повысить или расширить безопасность разработки или развертывания.  

-   **Защита AD FS как системы "уровень 0"** 

    AD FS — это, по сути, система проверки подлинности.  Таким образом, он должен рассматриваться как система уровня 0, как и другая система идентификации в сети.  [Документация Майкрософт](../../securing-privileged-access/securing-privileged-access-reference-material.md) содержит дополнительные сведения о модели административного уровня Active Directory. 


-   **Воспользуйтесь мастером конфигурации безопасности, чтобы применить рекомендации по безопасности AD FS к компьютерам серверов федерации и прокси-серверов федерации**  
  
    Мастер настройки безопасности (SCW) — это средство, которое предустановлено на всех компьютерах под управлением Windows Server 2008, Windows Server 2008 R2 и Windows Server 2012. Его можно использовать для применения рекомендаций безопасности с целью уменьшения поверхности атаки на сервер на основе устанавливаемых серверных ролей.  
  
    При установке AD FS программа установки создает файлы расширения роли, которые можно использовать вместе с мастером для создания политики безопасности, которая будет применяться к конкретной серверной роли AD FS (серверу федерации или прокси-серверу федерации), выбранной во время установки.  
  
    Каждый устанавливаемый файл расширения роли представляет тип роли и подроли, для которой настроен каждый компьютер. Следующие файлы расширения роли устанавливаются в каталог К:виндовсадфсскв:  
  
    -   Farm.xml  
  
    -   SQLFarm.xml  
  
    -   StandAlone.xml  
  
    -   Proxy.xml (Этот файл присутствует, только если компьютер настроен для работы в роли прокси-сервера федерации).  
  
    Для применения расширений роли AD FS в мастере конфигурации безопасности выполните следующие действия в указанной последовательности.  
  
    1.  Установите AD FS и выберите соответствующую серверную роль для компьютера. Дополнительные сведения см. в [статье Установка службы роли прокси-агент службы федерации](../../ad-fs/deployment/Install-the-Federation-Service-Proxy-Role-Service.md) в разделе руководств по развертыванию AD FS.  
  
    2.  Зарегистрируйте соответствующий файл расширения роли, используя средство командной строки Scwcmd. См. подробные сведения об использовании этого инструмента в роли, для которой настроен ваш компьютер, в следующей таблице.  
  
    3.  Убедитесь, что команда успешно завершена, изучив файл SCWRegister_log.xml, который находится в каталоге Виндовссекуритимссквлогс.  
  
    Эти действия необходимо выполнить на каждом компьютере сервера федерации или прокси-сервера федерации, к которому требуется применить политики безопасности мастера конфигурации безопасности AD FS.  
  
    В следующей таблице объясняется, как зарегистрировать соответствующее расширение роли мастера конфигурации безопасности в зависимости от серверной роли AD FS, выбранной на компьютере, где установлена служба AD FS.  
  
    |Серверная роль AD FS|Используемая база данных конфигурации AD FS|Введите в командной строке следующую команду:|  
    |---------------------|-------------------------------------|---------------------------------------------------|  
    |Изолированный сервер федерации|Внутренняя база данных Windows|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwStandAlone.xml"`|  
    |Объединенный в ферму сервер федерации|Внутренняя база данных Windows|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwFarm.xml"`|  
    |Объединенный в ферму сервер федерации|SQL Server|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwSQLFarm.xml"`|  
    |Прокси-сервер федерации|Н/Д|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwProxy.xml"`|  
  
    Дополнительные сведения о базах данных, которые можно использовать с AD FS, см. в разделе [Роль базы данных конфигурации AD FS](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md).  
  
-   **Обнаружение повторного воспроизведения маркеров используется в ситуациях, когда безопасность является очень важным вопросом, например при использовании киосков.**  
    Обнаружение воспроизведения маркеров — это функция AD FS, которая гарантирует, что будет обнаружена любая попытка воспроизведения запроса маркера, сделанного в служба федерации, и запрос отклоняется. Обнаружение воспроизведения токенов включено по умолчанию. Эта функция работает как для пассивного профиля WS-Federation, так и для профиля WebSSO (SAML). Один токен никогда не используется несколько раз.  
  
    При запуске службы федерации начинает создаваться кэш выполняемых запросов токена. Со временем, по мере добавления в кэш последующих запросов токена, способность службы федерации обнаруживать запросы на многократное воспроизведение токена совершенствуется. Если обнаружение воспроизведения токенов отключено, а затем принимается решение о необходимости снова включить эту функцию, помните, что служба федерации будет по-прежнему принимать токены в течение ранее заданного периода времени до тех пор, пока кэш воспроизведения не перестроит свое содержимое, на что требуется определенное время. Дополнительные сведения см. в разделе [Роль базы данных конфигурации AD FS](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md).  
  
-   **Используйте шифрование токенов, особенно при работе со вспомогательным разрешением артефактов SAML.**  
  
    Шифрование токенов настоятельно рекомендуется для повышения безопасности и защиты от потенциальных атак "злоумышленник в середине" (MITM), которые могут попытаться выполнить развертывание AD FS. Использование шифрования токенов может незначительно повлиять на пропускную способность, однако в большинстве случаев пользователи не заметят задержки. Во многих развертываниях преимущества такого подхода с точки зрения безопасности намного превышают неудобства от снижения производительности сервера.  
  
    Для включения шифрования токенов сначала настройте или добавьте сертификат шифрования для отношений доверия с проверяющей стороной. Настроить сертификат шифрования можно при создании отношений доверия с проверяющей стороной или позже. Чтобы добавить сертификат шифрования позже к существующему доверию проверяющей стороны, можно задать сертификат для использования на вкладке **Шифрование** в свойствах доверия при использовании оснастки AD FS. Чтобы указать сертификат для существующего доверия с помощью командлетов AD FS, используйте параметр Енкриптионцертификате командлетов **Set-клаимспровидертруст** или **Set-релингпартитруст** . Чтобы задать сертификат для служба федерации, который будет использоваться при расшифровке токенов, используйте командлет **Set-ADFSCertificate** и укажите " `Token-Encryption` " для параметра *цертификатетипе* . Включение и отключение шифрования для конкретных отношений доверия с проверяющей стороной осуществляется с помощью параметра *EncryptClaims* командлета **Set-RelyingPartyTrust**.  
  
-   **Использование расширенной защиты для проверки подлинности**  
  
    Для защиты развертываний можно задать и использовать функцию расширенной защиты для проверки подлинности с помощью AD FS. Этот параметр задает уровень расширенной защиты для проверки подлинности, поддерживаемой сервером федерации.  
  
    Расширенная защита аутентификации обеспечивает защиту от атак типа "злоумышленник в середине", когда злоумышленник перехватывает клиентские учетные данные и пересылает их на сервер. Защита от таких атак становится возможной благодаря токену привязки канала (CBT), который может требоваться или не требоваться сервером либо разрешаться им при установке связи с клиентами.  
  
    Для включения функции расширенной защиты воспользуйтесь параметром **ExtendedProtectionTokenCheck** командлета **Set-ADFSProperties**. В следующей таблице приводятся возможные значения этого параметра и уровень безопасности, обеспечиваемый этими значениями.  
  
    |Значение параметра|Уровень безопасности|Параметр защиты|  
    |-------------------|------------------|----------------------|  
    |Require|Сервер полностью защищен.|Расширенная защита активирована и требуется всегда.|  
    |Allow|Сервер частично защищен.|Расширенная защита активирована, если в соответствующих системах установлены исправления для поддержки этой функции|  
    |Отсутствуют|Сервер не защищен.|Расширенная защита не активирована.|  
  
-   **Если события фиксируются в журнале и отслеживаются, необходимо обеспечить сохранность конфиденциальной безопасности.**  
  
    По умолчанию AD FS не предоставляет или не следит за личными сведениями (PII) непосредственно в рамках служба федерации или обычных операций. Если ведение журнала событий и трассировка трассировки включены в AD FS, однако в зависимости от политики утверждений, для которой настроены некоторые типы утверждений, и связанные с ними значения могут содержать персональные данные, которые могут регистрироваться в журнале событий AD FS или трассировки.  
  
    Поэтому настоятельно рекомендуется принудительно применять контроль доступа к конфигурации AD FS и файлам журналов. Если эти сведения не должны быть видимы, необходимо отключить ведение журнала или отфильтровывать личные или конфиденциальные данные в журналах до того, как они будут предоставлены в общий доступ другим пользователям.  
  
    Следующие советы помогут избежать случайного предоставления содержимого файла журнала.  
  
    -   Убедитесь, что файлы журнала событий и трассировки AD FS защищены списками управления доступом (ACL), которые ограничивают доступ только доверенным администраторам, которым требуется доступ к ним.  
  
    -   Не копируйте и не архивируйте файлы журнала, используя файловые расширения или пути, доступные при обработке веб-запросов. Так, использование расширения имени XML-файла не является безопасным подходом. Список расширений, которые могут быть получены, можно найти в руководстве по администрированию Internet Information Services (IIS).  
  
    -   При пересмотре пути к файлу журнала не забудьте указать абсолютный путь к местоположению файла журнала, которое должно находиться за пределами общедоступного виртуального корневого каталога веб-узла. В противном случае он будет доступен третьим лицам через веб-браузер.  

-   **AD FS "Мягкая блокировка в экстрасети и AD FS защита Smart-блокировки экстрасети"**  
    
    В случае атаки в виде запросов проверки подлинности с недопустимыми (неправильными) паролями, которые проходят через прокси-приложение, AD FS блокировку экстрасети позволяет защитить пользователей от AD FS блокировки учетных записей. Помимо защиты пользователей от AD FS блокировка учетной записи AD FS блокировка экстрасети также обеспечивает защиту от атак методом подбора пароля.  
    
    При мягком блокировании экстрасети для AD FS в Windows Server 2012 R2 см. [AD FS защита с мягкими блокировками в экстрасети](../../ad-fs/operations/Configure-AD-FS-Extranet-Soft-Lockout-Protection.md).  

     Для Smart-блокировки экстрасети для AD FS в Windows Server 2016 см. [AD FS интеллектуальная защита блокировки экстрасети](../../ad-fs/operations/Configure-AD-FS-Extranet-Smart-Lockout-Protection.md).  
  
## <a name="sql-serverspecific-security-best-practices-for-ad-fs"></a>Рекомендации безопасности SQL Server для AD FS  
Следующие рекомендации по обеспечению безопасности относятся к использованию Microsoft SQL Server &reg; или внутренней базы данных Windows (WID), когда эти технологии используются для управления данными в AD FS проектирования и развертывания.  
  
> [!NOTE]  
> Эти рекомендации дополняют, но не заменяют инструкции по обеспечению безопасности SQL Server. Дополнительные сведения о планировании безопасной установки SQL Server см. [в статье вопросы безопасности при безопасной установке SQL](https://go.microsoft.com/fwlink/?LinkID=139831) ( https://go.microsoft.com/fwlink/?LinkID=139831) .  
  
-   **Всегда развертывайте SQL Server в физически безопасной сетевой среде, под защитой брандмауэра.**  
  
    Ни в коем случае не делайте установку SQL Server доступной непосредственно в Интернете. Только компьютеры, входящие в ваш центр обработки данных, должны иметь доступ к установке SQL Server, поддерживающей AD FS. Дополнительные сведения см. в разделе [Контрольный список рекомендаций по безопасности](https://go.microsoft.com/fwlink/?LinkID=189229) ( https://go.microsoft.com/fwlink/?LinkID=189229) .  
  
-   **Запускайте SQL Server с учетной записью службы, вместо того чтобы использовать встроенные учетные записи системных служб по умолчанию.**  
  
    По умолчанию SQL Server часто устанавливается и настраивается для использования одной из поддерживаемых встроенных системных учетных записей, таких как LocalSystem или NetworkService. Чтобы повысить безопасность установки SQL Server для AD FS, везде, где это возможно, можно использовать отдельную учетную запись службы для доступа к службе SQL Server и включить проверку подлинности Kerberos, зарегистрировав имя участника безопасности (SPN) этой учетной записи в развертывании Active Directory. Это обеспечивает взаимную аутентификацию клиента и сервера. Без регистрации имени участника безопасности для отдельной учетной записи службы SQL Server будет использовать аутентификацию NTLM для Windows, подразумевающую аутентификацию только клиента.  
  
-   **Контактная зона SQL Server должна быть минимальной.**  
  
    Активируйте только те конечные точки SQL Server, которые совершенно необходимы для работы. По умолчанию SQL Server предоставляет одну встроенную конечную точку TCP, удалить которую невозможно. Для AD FS следует включить эту конечную точку TCP для проверки подлинности Kerberos. Воспользуйтесь инструкцией запроса SELECT * FROM sys.tcp_endpoints в сеансе Transact-SQL (T-SQL), чтобы проанализировать существующие конечные точки TCP и узнать, добавлены ли дополнительные пользовательские TCP-порты в установку SQL. Дополнительные сведения о конфигурации конечной точки SQL Server см. в разделе [как настроить ядро СУБД для прослушивания нескольких TCP-портов](https://go.microsoft.com/fwlink/?LinkID=189231) ( https://go.microsoft.com/fwlink/?LinkID=189231) .  
  
-   **Избегайте использования аутентификации на базе SQL.**  
  
    Используйте в установке SQL Server только аутентификацию Windows, чтобы избежать необходимости передавать пароли в виде обычного текста по сети или сохранять их в параметрах конфигурации. Аутентификация SQL Server является устаревшим режимом аутентификации. Не рекомендуется сохранять учетные данные SQL для входа в систему (имена пользователей и пароли SQL) при использовании аутентификации SQL Server. Дополнительные сведения см. в разделе [режимы проверки подлинности](https://go.microsoft.com/fwlink/?LinkID=189232) ( https://go.microsoft.com/fwlink/?LinkID=189232) .  
  
-   **Внимательно проанализируйте необходимость обеспечения дополнительной безопасности каналов в установке SQL.**  
  
    Даже если реализована аутентификация Kerberos, интерфейс поставщика поддержки безопасности (SSPI) SQL не обеспечивает безопасность на уровне каналов. Однако для установок, в которых серверы безопасно размещены в защищенной брандмауэром сети, шифрование обмена данными SQL не является обязательным.  
  
    Несмотря на то, что шифрование является полезным средством обеспечения безопасности, его не следует применять ко всем данным или соединениям. При решении о внедрении шифрования необходимо проанализировать, как пользователи получают доступ к данным. Если пользователи получают доступ к данным через открытую сеть, то шифрование может потребоваться для повышения безопасности. Однако если весь доступ к данным SQL с помощью AD FS включает в себя безопасную конфигурацию интрасети, шифрование может не потребоваться. Использование шифрования включает политику управления паролями, ключами и сертификатами.  
  
    Если существует вероятность просмотра данных SQL или совершения с ними злоумышленных действий по сети, используйте протоколы безопасности IPsec или SSL для защиты подключений SQL. Однако это может негативно сказаться на SQL Server производительности, что может повлиять на производительность или ограничить AD FS в некоторых ситуациях. Например, AD FS производительность при выдаче маркера может снизиться, если уточняющие запросы из хранилища атрибутов на основе SQL являются критически важными для выдачи маркеров. Устранить угрозу злоумышленных действий с SQL можно, создав мощный периметр безопасности. Так, оптимальным решением для обеспечения безопасности установки SQL Server является гарантия недоступности установки интернет-пользователям и компьютерам. Установка должна быть доступна только пользователям и компьютерам в среде ЦОД соответствующей организации.  
  
    Дополнительные сведения см. [в разделе Шифрование соединений для SQL Server](https://go.microsoft.com/fwlink/?LinkID=189234) или [SQL Server шифрования](https://go.microsoft.com/fwlink/?LinkID=189233).  
  
-   **Настройте безопасный доступ с помощью хранимых процедур для выполнения всех поисков на основе SQL с AD FS данных, хранимых SQL.**  
  
    Для повышения качества обслуживания и изоляции данных можно создать хранимые процедуры для всех команд поиска хранилищ атрибутов. Можно создать роль базы данных, которой будут предоставлены разрешения на выполнение хранимых процедур. Назначьте этой роли базы данных удостоверение службы AD FS Windows. Служба AD FS Windows не должна иметь возможности выполнять другие инструкции SQL, кроме соответствующих хранимых процедур, используемых для поиска атрибутов. Блокирование доступа к базе данных SQL Server указанным способом снижает риск атаки в результате повышения уровня доступа.  
  
## <a name="see-also"></a>См. также
[Руководство по разработке служб федерации Active Directory в Windows Server 2012](AD-FS-Design-Guide-in-Windows-Server-2012.md)
