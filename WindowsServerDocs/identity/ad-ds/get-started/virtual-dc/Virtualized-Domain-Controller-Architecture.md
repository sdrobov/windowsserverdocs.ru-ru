---
ms.assetid: 341614c6-72c2-444f-8b92-d2663aab7070
title: Архитектура виртуализованных контроллеров доменов
description: ''
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: d69ccfd15004619f890c6f5c1cb630c62e16256b
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59889195"
---
# <a name="virtualized-domain-controller-architecture"></a>Архитектура виртуализованных контроллеров доменов

>Область применения. Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

В этом разделе описывается архитектуры клонирования и безопасного восстановления виртуализированного контроллера домена. В нем приведены процессы клонирования и безопасного восстановления с поясняющими блок-схемами, а также дано подробное описание каждого из этапов этих процессов.  
  
-   [Архитектура клонирования виртуализированного контроллера домена](../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_CloneArch)  
  
-   [Архитектура виртуализованных контроллеров доменов безопасного восстановления](../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch)  
  
## <a name="BKMK_CloneArch"></a>Архитектура клонирования виртуализированного контроллера домена  
  
### <a name="overview"></a>Обзор  
Клонирование виртуализированного контроллера домена основано на предоставлении идентификатора **ИД создания виртуальной машины** (VM-Generation ID) платформой низкоуровневой оболочки для обнаружения создания виртуальной машины. Доменные службы Active Directory изначально сохраняют значение этого идентификатора в своей базе данных (NTDS.DIT) во время повышения уровня контроллера домена. При загрузке виртуальной машины текущее значение ИД создания виртуальной машины, заданное в виртуальной машине, сравнивается со значением в базе данных. Если значения не совпадают, контроллер домена выполняет сброс InvocationID и отменяет свой пул относительных идентификаторов, чтобы предотвратить повторное использование номера последовательного обновления или создание дублирующихся субъектов безопасности. После этого контроллер домена выполняет поиск файла DCCloneConfig.xml в расположениях, указанных в шаге 3 процедуры [Cloning Detailed Processing](../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_CloneProcessDetails). Если он находит файл DCCloneConfig.xml, то считает себя развернутым в качестве клона и поэтому инициирует клонирование, чтобы подготовиться к работе в качестве дополнительного контроллера домена посредством повторного повышения уровня с использованием содержимого существующих NTDS.DIT и SYSVOL, скопированных с исходного носителя.  
  
В смешанной среде, где некоторые низкоуровневые оболочки поддерживают ИД создания виртуальной машины, а другие нет, носитель клона может быть случайно развернут в низкоуровневой оболочке, которая не поддерживает ИД создания виртуальной машины. Наличие файла DCCloneConfig.xml указывает на намерение администратора клонировать контроллер домена. Таким образом, если файл DCCloneConfig.xml найден во время загрузки, но с узла не предоставлен ИД создания виртуальной машины, контроллер домена клона загружается в режиме восстановления служб каталогов (DSRM), чтобы предотвратить негативное воздействие на остальную часть среды. Носитель клона затем можно переместить в низкоуровневую оболочку, которая поддерживает ИД создания виртуальной машины, после чего попытку клонирования можно повторить.  
  
Если носитель клона развертывается в низкоуровневой оболочке, поддерживающей ИД создания виртуальной машины, а файл DCCloneConfig.xml не предоставляется, то при обнаружении несовпадения ИД создания виртуальной машины между DIT и новой виртуальной машиной контроллер домена активирует меры безопасности, чтобы предотвратить повторное использование номера последовательного обновления и создание повторяющихся идентификаторов безопасности. Однако клонирование не инициируется, поэтому дополнительный контроллер домена продолжит работать с тем же удостоверением, что и исходный контроллер домена. Этот дополнительный контроллер домена следует как можно раньше удалить из сети, чтобы предотвратить возникновение несогласованностей в среде. Дополнительные сведения о том, как освободить этот дополнительный контроллер домена и обеспечить исходящую репликацию обновлений, см. в статье базы знаний Майкрософт [2742970](https://support.microsoft.com/kb/2742970).  
  
### <a name="BKMK_CloneProcessDetails"></a>Подробный процесс клонирования  
На следующей схеме показана архитектура для операции начального клонирования и для операции повторной попытки клонирования. Подробное описание этих процессов приведено ниже в данном разделе.  
  
**Операция начального клонирования**  
  
![Архитектура виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_InitialCloningProcess.png)  
  
**Операция повторной попытки клонирования**  
  
![Архитектура виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_CloningRetryProcess.png)  
  
Следующие пункты содержат пояснения к данном процессу:  
  
1.  Имеющийся контроллер домена виртуальной машины загружается в низкоуровневой оболочке, поддерживающей ИД создания виртуальной машины.  
  
    1.  Эта виртуальная машина не имеет значения ИД создания виртуальной машины, заданного в объекте-компьютере доменных служб Active Directory после повышения уровня.  
  
    2.  Даже если оно равно NULL, следующее создание компьютера будет означать продолжение клонирования из-за несовпадения нового ИД создания виртуальной машины.  
  
    3.  ИД создания виртуальной машины задается после следующей перезагрузки контроллера домена и не реплицируется.  
  
2.  После этого виртуальная машина считывает ИД создания виртуальной машины, предоставленный драйвером VMGenerationCounter. Она сравнивает эти два ИД создания виртуальной машины.  
  
    1.  Если идентификаторы совпадают, эта виртуальная машина не является новой и клонирование не выполняется. Если существует файл DCCloneConfig.xml, контроллер домена переименует его с отметкой времени и даты, чтобы предотвратить клонирование. Сервер продолжает загружаться в обычном режиме. Именно так проходит каждая перезагрузка любого виртуального контроллера домена в Windows Server 2012.  
  
    2.  Если два идентификатора не совпадают, значит это новая виртуальная машина, которая содержит NTDS.DIT из предыдущего контроллера домена (или является восстановленным моментальным снимком). Если файл DCCloneConfig.xml существует, контроллер домена приступает к выполнению операций клонирования. В противном случае он продолжает выполнение операций восстановления моментального снимка. См. раздел [Virtualized domain controller safe restore architecture](../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch).  
  
    3.  Если низкоуровневая оболочка не предоставляет ИД создания виртуальной машины для сравнения, однако файл DCCloneConfig.xml существует, гость переименовывает этот файл и загружается в режиме восстановления служб каталогов, чтобы защитить сеть от дублирования контроллера домена. Если файл dccloneconfig.xml отсутствует, гость загружается в нормальном режиме (при этом имеется риск дублирования контроллера домена в сети). Дополнительные сведения о способах освобождения этого дублирующегося контроллера домена см. в статье базы знаний Майкрософт [2742970](https://support.microsoft.com/kb/2742970).  
  
3.  Служба NTDS проверяет имя значения реестра DWORD VDCisCloning (в разделе HKEY_Local_Machine\System\CurrentControlSet\Services\Ntds\Parameters).  
  
    1.  Если оно не существует, значит это первая попытка клонирования для данной виртуальной машины. Гость применяет меры безопасности для дублирования объектов виртуального контроллера домена, заключающиеся в том, чтобы сделать недействительным локальный пул относительных идентификаторов и задать новый идентификатор вызова репликации для контроллера домена  
  
    2.  Если для него уже установлено значение 0x1, значит это повторная попытка клонирования, а предыдущая операция клонирования завершилась со сбоем. Меры безопасности для дублирования объектов виртуального контроллера домена не применяются, так как они уже должны были выполняться ранее и привели бы к ненужному изменению гостя.  
  
4.  Выполняется запись имени значения реестра DWORD IsClone (в разделе Hkey_Local_Machine\System\CurrentControlSet\Services\NTDS\Parameters)  
  
5.  Служба NTDS изменяет флаг загрузки гостя, чтобы для всех дальнейших загрузок осуществлялся запуск в режиме восстановления служб каталогов.  
  
6.  Служба NTDS пытается считать файл DcCloneConfig.xml в одном из трех допустимых расположениях (рабочий каталог DSA, %windir%\NTDS или съемный носитель с возможностью чтения и записи, поиск выполняется по буквам диска в корневом каталоге).  
  
    1.  Если файл отсутствует во всех допустимых расположениях, гость проверяет IP-адрес на предмет дублирования. Если IP-адрес не дублирован, сервер загружается в обычном режиме. Если IP-адрес дублирован, компьютер загружается в режиме восстановления служб каталогов, чтобы защитить сеть от дублирования контроллера домена.  
  
    2.  Если файл находится в допустимом расположении, служба NTDS проверяет его параметры. Если файл пуст (или пусты отдельные параметры), то NTDS автоматически настраивает значения для этих параметров.  
  
    3.  Если файл DcCloneConfig.xml существует, но содержит какие-либо недопустимые записи или не может быть прочитан, клонирование завершается со сбоем, а гость загружается в режиме восстановления служб каталогов (DSRM).  
  
7.  Гость отключает все функции автоматической регистрации DNS, чтобы предотвратить случайный перехват имени и IP-адресов исходного компьютера.  
  
8.  Гость останавливает службу входа в сеть, чтобы предотвратить получение объявлений или ответ на сетевые запросы доменных служб Active Directory от клиентов.  
  
9. NTDS проверяет отсутствие установленных служб или программ, не являющихся частью DefaultDCCloneAllowList.xml или CustomDCCloneAllowList.xml  
  
    1.  Если присутствуют службы или программы, не включенные в стандартный или пользовательский список разрешенных исключений, клонирование завершается со сбоем, а гость загружается в режиме восстановления служб каталогов, чтобы защитить сеть от дублирования контроллера домена.  
  
    2.  При отсутствии несовместимостей клонирование продолжается.  
  
10. Если из-за пустых параметров сети в DCCloneConfig.xml будет использоваться автоматическая IP-адресация, гость включает DHCP на сетевых адаптерах, чтобы получить сведения об аренде IP-адресов, сетевой маршрутизации и разрешении имен.  
  
11. Гость находит контроллер домена, на котором выполняется роль FSMO эмулятора PDC. При этом используется служба DNS и протокол DCLocator. Устанавливается подключение RPC и вызывается метод IDL_DRSAddCloneDC для клонирования объекта-компьютера контроллера домена.  
  
    1.  Если исходный объект-компьютер гостя содержит расширенное разрешение заголовка домена "'Разрешить контроллеру домена клонировать себя", клонирование продолжается.  
  
    2.  Если исходный объект-компьютер не содержит это расширенное разрешение, клонирование завершается со сбоем, а гость загружается в режиме восстановления служб каталогов, чтобы защитить сеть от дублирования контроллера домена.  
  
12. Имя объекта-компьютера доменных служб Active Directory устанавливается аналогичным имени, указанному в файле DCCloneConfig.xml, если оно там есть, или создается автоматически в PDCE. NTDS создает правильный объект параметров NTDS для подходящего логического сайта Active Directory.  
  
    1.  Если это клонирование PDC, то гость переименовывает локальный компьютер и перезагружается. После перезагрузки он снова выполняет шаги с 1 до 10, а затем переходит к шагу 13.  
  
    2.  Если выполняется клонирование контроллера домена реплики, перезагрузка на данном этапе не выполняется.  
  
13. Гость предоставляет параметры повышения уровня службе сервера с ролью DS, которая запускает повышение.  
  
14. Служба сервера с ролью DS останавливает все службы, связанные с доменными службами Active Directory (NTDS, NTFRS/DFSR, KDC, DNS).  
  
15. Гость принудительно выполняет синхронизацию времени NT5DS (Windows NTP) с другим контроллером домена (в стандартной иерархии службы времени Windows это означает использование PDCE). Гость обращается к PDCE. Все имеющиеся билеты Kerberos записываются на диск.  
  
16. Гость настраивает службы DFSR или NTFRS на автоматический запуск. Гость удаляет все существующие файлы базы данных DFSR и NTFRS (по умолчанию: c:\windows\ntfrs и c:\system volume information\dfsr\\ *< database_GUID >*), чтобы принудительно реализовать не заслуживающую доверия синхронизацию SYSVOL при следующем запуске службы. Гость не удаляет содержимое файлов SYSVOL, чтобы предварительно задать для SYSVOL начальное значение при последующем запуске синхронизации.  
  
17. Гость переименовывается. Служба сервера с ролью DS в госте начинает настройку доменных служб Active Directory (повышение уровня), используя имеющийся файл базы данных NTDS.DIT в качестве источника вместо шаблона базы данных, включенного в c:\windows\system32, который используется при обычном повышении.  
  
18. Гость обращается к владельцу роли FSMO хозяина RID для получения нового распределения пула относительных идентификаторов.  
  
19. Процесс повышения уровня создает новый идентификатор вызова и воссоздает объект параметров NTDS для клонированного контроллера домена (при использовании имеющейся базы данных NTDS.DIT это входит в состав повышения домена независимо от клонирования).  
  
20. NTDS реплицирует объекты, которые отсутствую, имеют более новую дату или более высокую версию, с партнерского контроллера домена. NTDS.DIT уже содержит объекты, относящиеся ко времени перехода исходного контроллера домена в автономный режим, и они по мере возможности используются для минимизации входящего трафика репликации. Выполняется заполнение разделов глобального каталога.  
  
21. Запускается служба DFSR или FRS, а в связи с отсутствием базы данных SYSVOL непринудительно синхронизирует входящие данные от партнера репликации. Этот процесс повторно использует существующие данные в папке SYSVOL, чтобы минимизировать сетевой трафик репликации.  
  
22. Гость повторно активирует регистрацию DNS-клиента на компьютере, который получил уникальное имя и параметры сети.  
  
23. Гость запускает модули SYSPREP, указанные в элементе <SysprepInformation> файла DefaultDCCloneAllowList.xml, чтобы очистить ссылки на предыдущее имя компьютера и предыдущий идентификатор безопасности.  
  
24. Повышение уровня клонирования выполнено.  
  
    1.  Гость удаляет флаг загрузки DSRM, чтобы следующая загрузка проходила в обычном режиме.  
  
    2.  Гость переименовывает файл DCCloneConfig.xml, добавив отметку времени и даты, чтобы этот файл не считывался повторно при следующей загрузке.  
  
    3.  Гость удаляет имя значения реестра DWORD VdcIsCloning из раздела HKEY_Local_Machine\System\CurrentControlSet\Services\NTDS\Parameters.  
  
    4.  Гость задает для имени значения реестра DWORD "VdcCloningDone" в разделе HKEY_Local_Machine\System\CurrentControlSet\Services\NTDS\Parameters значение 0x1. Операционная система Windows не использует это значение, а предоставляет его в качестве маркера сторонним разработчикам.  
  
25. Гость обновляет атрибут msDS-GenerationID в своем клонированном объекте контроллера домена, чтобы он соответствовал текущему ИД создания виртуальной машины гостя.  
  
26. Выполняется перезапуск гостя. Теперь это обычный контроллер домена объявлений.  
  
## <a name="BKMK_SafeRestoreArch"></a>Архитектура виртуализованных контроллеров доменов безопасного восстановления  
  
### <a name="overview"></a>Обзор  
Работа доменных служб Active Directory основана на предоставлении идентификатора **ИД создания виртуальной машины** (VM-Generation ID) платформой низкоуровневой оболочки для обнаружения восстановления моментального снимка виртуальной машины. Доменные службы Active Directory изначально сохраняют значение этого идентификатора в своей базе данных (NTDS.DIT) во время повышения уровня контроллера домена. Когда администратор восстанавливает машину из предыдущего снимка, текущее значение ИД создания виртуальной машины из виртуальной машины сравнивается со значением в базе данных. Если значения не совпадают, контроллер домена выполняет сброс InvocationID и отменяет свой пул относительных идентификаторов, чтобы предотвратить повторное использование номера последовательного обновления или создание дублирующихся субъектов безопасности. Существует два сценария, в которых возможно выполнение безопасного восстановления:  
  
-   Когда виртуальный контроллер домена запускается после того, как моментальный снимок был восстановлен при отключенном контроллере домена  
  
-   Когда моментальный снимок восстанавливается на работающем контроллере домена  
  
    Если виртуализированный контроллер домена в моментальном снимке находится в приостановленном, а не в выключенном состоянии, вам требуется перезапустить доменные службы Active Directory, чтобы активировать новый запрос пула относительных идентификаторов. Вы можете перезапустить доменные службы Active Directory с помощью оснастки "Службы" или Windows PowerShell (Restart-Service NTDS -force).  
  
Следующие разделы содержат подробное описание безопасного восстановления для каждого из сценариев.  
  
### <a name="safe-restore-detailed-processing"></a>Подробный процесс безопасного восстановления  
Следующая блок-схема показывает, как именно происходит безопасное восстановление, когда виртуальный контроллер домена запускается после того, как моментальный снимок был восстановлен при отключенном контроллере домена  
  
![Архитектура виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_VirtualizationSafeguardsDuringNormalBoot.png)  
  
1.  Когда виртуальная машина загружается после восстановления моментального снимка, она получает новый ИД создания виртуальной машины, заданный узлом низкоуровневой оболочки в связи с восстановлением моментального снимка.  
  
2.  Новый ИД создания виртуальной машины из виртуальной машины сравнивается с ИД создания виртуальной машины из базы данных. Поскольку два идентификатора не совпадают, применяются меры безопасности виртуализации (см. шаг 3 в предыдущем разделе). После завершения обновления ИД создания виртуальной машины, заданный для объекта-компьютера доменных служб Active Directory, обновляется, чтобы соответствовать новому идентификатору предоставленному узлом низкоуровневой оболочки.  
  
3.  Гость применяет следующие меры безопасности виртуализации:  
  
    1.  Прекращение действия локального пула относительных идентификаторов.  
  
    2.  Установка нового идентификатора вызова для базы данных контроллера домена.  
  
> [!NOTE]  
> Эта часть безопасного восстановления аналогична процессу клонирования. Хотя данный процесс предназначен для безопасного восстановления виртуального контроллера домена, когда он загружается после восстановления моментального снимка, те же действия выполняются и во время процесса клонирования.  
  
На следующей схеме показано, как меры безопасности виртуализации предотвращают расхождение, вносимое откатом номера последовательного обновления при восстановлении снимка на запущенном виртуальном контроллере домена.  
  
![Архитектура виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_VirtualizationSafeguardsDuringSnapShotRestore.png)  
  
> [!NOTE]  
> Предыдущая иллюстрация специально упрощена, чтобы продемонстрировать наиболее основные принципы.  
  
1.  В момент времени T1 администратор низкоуровневой оболочки получает моментальный снимок виртуального контроллера домена DC1. При этом DC1 имеет номер последовательного обновления (USN) (на практике это **highestCommittedUsn**) со значением 100 и InvocationId (на предыдущей схеме это ID) со значением A (на практике это GUID). Значение savedVMGID — это ИД создания виртуальной машины в файле DIT контроллера домена (хранится для объекта-компьютера контроллера домена в атрибуте с именем **msDS-GenerationId**). VMGID — это текущее значение ИД создания виртуальной машины из драйвера виртуальной машины. Данное значение предоставляется низкоуровневой оболочкой.  
  
2.  В более поздний момент времени T2 для этого контроллера домена добавляется 100 пользователей (рассматривайте пользователей в качестве примера обновлений, которые могли иметь место для данного контроллера домена между моментами T1 и T2; реальные обновления могут включать в себя создание пользователей и групп, обновления паролей и атрибутов и т. п.). В данном примере каждое обновление использует один уникальный номер последовательного обновления (USN) (хотя на практике создание пользователя может использовать более одного номера). Перед фиксацией этих обновлений DC1 проверяет, совпадает ли значение ИД создания виртуальной машины в его базе данных (savedVMGID) с текущим значением в драйвере (VMGID). Они совпадают, так как пока не произошло никакого отката, поэтому обновления фиксируются, а номер последовательного обновления доводится до значения 200, указывая, что следующее обновление может использовать номер 201. В InvocationId, savedVMGID и VMGID не вносится никаких изменений. Эти обновления реплицируются на DC2 в рамках следующего цикла репликации. DC2 обновляет верхнего предела (и **UptoDatenessVector**) представленный здесь просто как DC1(A) @USN = 200. Теперь DC2 оповещен обо всех обновлениях из DC1 в контексте идентификатора InvocationId A до номера последовательного обновления 200.  
  
3.  В момент времени T3 моментальный снимок, полученный в момент времени T1, применяется к DC1. Для DC1 был выполнен откат, поэтому его номер последовательного обновления вернулся к 100, указывая, что он может использовать номера с 101 для сопоставления с последующими обновлениями. Однако на данном этапе значение VMGID было бы другим в низкоуровневых оболочках, которые поддерживают ИД создания виртуальной машины.  
  
4.  Впоследствии, когда DC1 выполняет любое обновление, он проверяет, совпадает ли значение ИД создания виртуальной машины в его базе данных (savedVMGID) со значением в драйвере виртуальной машины (VMGID). В данном случае эти значения отличаются, DC1 расценивает это как признак отката и активирует меры безопасности виртуализации; другими словами, он выполняет сброс своего InvocationId (ID = B) и отменяет пул относительных идентификаторов (не показан на предыдущей схеме). Затем он сохраняет новое значение VMGID в своей базе данных и фиксирует эти обновления (USN 101 — 250) в контексте нового InvocationId B. В ходе следующего цикла репликации DC2 ничего не известно из DC1 в контексте InvocationId B, поэтому все, что он запрашивает из DC1, связанные с InvocationID B. Таким образом выполняется безопасное схождение обновлений, выполненных на DC1 после применения моментального снимка. Кроме того, набор обновлений, выполненных на DC1 в момент времени T2 (которые были потеряны на DC1 после восстановления снимка), будут реплицированы обратно на DC1 при следующей запланированной репликации, так как они были реплицированы на DC2 (что показано пунктирной линией, возвращающейся к DC1).  
  
После применения гостем мер безопасности виртуализации NTDS непринудительно реплицирует различия во входящих объектах Active Directory с партнерского контроллера домена. Вектор актуальности конечного сервера службы каталогов обновляется соответствующим образом. После этого гость синхронизирует SYSVOL:  
  
-   При использовании FRS гость останавливает службу NTFRS и задает значение реестра D2 BURFLAGS. Затем она запускает службу NTFRS, которая непринудительно реплицирует входящие данные, по возможности используя имеющиеся неизмененные данные SYSVOL.  
  
-   Если используется DFSR, Гость останавливает службу DFSR и удаляет файлы базы данных DFSR (расположение по умолчанию: %systemroot%\system volume information\dfsr\\*<database GUID>*). Затем она запускает службу DFSR, которая непринудительно реплицирует входящие данные, по возможности используя имеющиеся неизмененные данные SYSVOL.  
  
> [!NOTE]  
> -   Если низкоуровневая оболочка не предоставляет ИД создания виртуальной машины для сравнения, она не поддерживает меры безопасности виртуализации, и гость будет работать в качестве виртуализированного контроллера домена под управлением Windows Server 2008 R2 или более ранней версии. Гость реализует карантинную защиту отката номера последовательного обновления при наличии попытки запустить репликацию с номерами последовательного обновления, не превышающими последний наибольший номер, который был зарегистрирован партнерским контроллером домена. Дополнительные сведения о карантинной защите отката номера последовательного обновления см. в разделе [USN и откат USN](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv(WS.10).aspx)  
  


