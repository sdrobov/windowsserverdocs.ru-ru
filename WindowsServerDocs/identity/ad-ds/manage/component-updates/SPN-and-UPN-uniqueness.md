---
ms.assetid: 40bc24b1-2e7d-4e77-bd0f-794743250888
title: Уникальность имен участников-служб и участников-пользователей
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adds
ms.openlocfilehash: bca2934b5b691f69fc70cd9d5230a2865b24ac94
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86966426"
---
# <a name="spn-and-upn-uniqueness"></a>Уникальность имен участников-служб и участников-пользователей

>Область применения. Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

**Автор**: Джастин Тернер, старший инженер по расширению поддержки с группой Windows  
  
> [!NOTE]  
> Этот материал создан инженером службы поддержки клиентов Майкрософт и предназначен для опытных администраторов и архитекторов систем, которым нужны более глубокие технические сведения о функциях и решениях в Windows Server 2012 R2, а не обычная информация, доступная в статьях на сайте TechNet. Однако он не был отредактирован согласно требованиям сайта, поэтому некоторые формулировки могут быть не такими выверенными, как на станицах TechNet.  
  
## <a name="overview"></a>Обзор  
Контроллеры домена под Windows Server 2012 R2 блокируют создание повторяющихся имен субъектов-служб (SPN) и имен участников-пользователей (UPN). Это относится к созданию дубликатов в случае восстановления или повторной анимации удаленного объекта или переименования объекта.  
  
### <a name="background"></a>Фон  
Дублирование имен субъектов-служб (SPN) обычно происходит, что приводит к ошибкам проверки подлинности и может привести к чрезмерному использованию процессора службой LSASS. Нет встроенного метода для блокирования добавления повторяющегося имени субъекта-службы или UPN. *  
  
Дублирующиеся значения имени участника-пользователя нарушают синхронизацию между локальной службой AD и Office 365.  
  
* Setspn.exe обычно используется для создания новых имен участников-служб, и функционально был встроен в версию, выпущенную в Windows Server 2008, которая добавляет проверку на наличие дубликатов.  
  
**Таблица SEQ таблица номер \\ \* Арабский 1: уникальность имени участника-пользователя и имени субъекта-службы**  
  
|Функция|Комментировать|  
|-----------|-----------|  
|Уникальность имени участника-пользователя|Дублирование UPN разрывает синхронизацию локальных учетных записей AD с помощью служб Windows Azure AD, таких как Office 365.|  
|Уникальность имени субъекта-службы|Для взаимной проверки подлинности Kerberos требуются имена участников-служб.  Дублирование имени участника-службы приводит к сбоям проверки подлинности.|  
  
Дополнительные сведения о требованиях уникальности к именам участников-служб и имен SPN см. в разделе [ограничения уникальности](/openspecs/windows_protocols/ms-adts/3c154285-454c-4353-9a99-fb586e806944).  
  
## <a name="symptoms"></a>Симптомы  
Коды ошибок 8467 или 8468 или их шестнадцатеричные, символьные или строковые эквиваленты регистрируются в различных диалоговых окнах и в событии с ИДЕНТИФИКАТОРом 2974 в журнале событий служб каталогов. Попытка создать дубликат имени участника-пользователя или SPN блокируется только в следующих случаях.  
  
-   Запись обрабатывается контроллером домена Windows Server 2012 R2  
  
**Таблица SEQ таблица номер \\ \* Арабский 2: коды ошибок имени участника-пользователя и имени участника-службы**  
  
|Decimal|Hex|Символические|Строка|  
|-----------|-------|------------|----------|  
|8467|21C7|ERROR_DS_SPN_VALUE_NOT_UNIQUE_IN_FOREST|Не удалось выполнить операцию, так как значение имени субъекта-службы, указанное для добавления или изменения, не является уникальным для всего леса.|  
|8648|21C8|ERROR_DS_UPN_VALUE_NOT_UNIQUE_IN_FOREST|Операцию не удалось выполнить, так как значение имени участника-пользователя, предоставленное для добавления или изменения, не является уникальным в пределах леса.|  
  
## <a name="new-user-creation-fails-if-upn-is-not-unique"></a>Создание нового пользователя завершается сбоем, если имя участника-пользователя не является уникальным  
  
### <a name="dsamsc"></a>DSA. msc  
Выбранное имя входа пользователя уже используется в этом предприятии. Выберите другое имя для входа и повторите попытку.  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig01_DupUPN.gif)  
  
Изменить существующую учетную запись:  
  
Указанное имя входа пользователя уже существует в Организации. Укажите новое значение, изменив префикс или выбрав другой суффикс из списка.  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig02_DupUPNMod.gif)  
  
### <a name="active-directory-administrative-center-dsacexe"></a>Центр администрирования Active Directory (DSAC.exe)  
При попытке создать нового пользователя в центр администрирования Active Directory с именем участника-пользователя, которое уже существует, будет выдаваться следующая ошибка.  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig03_DupUPNADAC.gif)  
  
**Рис. номер \\ \* арабского 1 ошибка, отображаемая в центре администрирования Active Directory при неудачном создании нового пользователя из-за повторяющегося UPN**  
  
### <a name="event-2974-source-activedirectory_domainservice"></a>Источник события 2974: ActiveDirectory_DomainService  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig04_Event2974.gif)  
  
**Рис. SEQ. \\ \* Арабский 2 событие с кодом 2974 с ошибкой 8648**  
  
В событии 2974 отображается заблокированное значение и список из одного или нескольких объектов (до 10), которые уже содержат это значение.  На следующем рисунке видно, что значение атрибута UPN **<em>dhunt@blue.contoso.com</em>** уже существует в четырех других объектах.  Поскольку это новая функция в Windows Server 2012 R2, случайное создание дубликатов UPN и SPN в смешанной среде по-прежнему будет происходить, когда контроллеры домена нижнего уровня будут обрабатывать попытки записи.  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig05_Event2974ShowAllDups.gif)  
  
**Рис. SEQ. \\ \* Арабский 3 событие 2974 с отображением всех объектов, содержащих повторяющееся имя участника-пользователя**  
  
> [!TIP]  
> Регулярно просматривайте событие с ИДЕНТИФИКАТОРом 2974s:  
>   
> -   выявление попыток создать дубликат имени участника-пользователя или SPN  
> -   Поиск объектов, которые уже содержат дубликаты  
  
8648 = "не удалось выполнить операцию, так как значение UPN, указанное для добавления или изменения, не является уникальным для всего леса".  
  
### <a name="setspn"></a>SetSPN  
В Setspn.exe было обнаружено дублирование встроенного имени участника-службы с момента выпуска Windows Server 2008 при использовании параметра **"-S"** .  Можно обойти обнаружение повторяющегося имени участника-службы с помощью параметра **"-A"** .  Создание повторяющегося имени участника-службы блокируется при нацеливании на контроллер домена Windows Server 2012 R2 с помощью команды SetSPN с параметром-A.  Отображаемое сообщение об ошибке совпадает с именем, отображаемым при использовании параметра-S: "Найдено повторяющееся имя участника-службы, операция прекращена.  
  
### <a name="adsiedit"></a>ADSIEdit  
  
```  
Operation failed. Error code: 0x21c8  
The operation failed because UPN value provided for addition/modification is not unique forest-wide.  
000021C8: AtrErr: DSID-03200BBA, #1: 0: 000021C8: DSID-03200BBA, problem 1005 (CONSTRAINT_ATT_TYPE), data 0, Att 90290 (userPrincipalName)  
```  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig06_ADSI21c8.gif)  
  
**Рис. SEQ. \\ \* сообщение об ошибке арабского 4, отображаемое в ADSIEdit, если Добавление повторяющегося имени участника-пользователя заблокировано**  
  
### <a name="windows-powershell"></a>Windows PowerShell  
Windows Server 2012 R2:  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig07_SetADUser2012.gif)  
  
PS, работающий на сервере 2012, предназначенном для Windows Server 2012 R2 DC:  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig08_SetADUser2012R2.gif)  
  
DSAC.exe под Windows Server 2012, предназначенный для Windows Server 2012 R2 DC:  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig09_UserCreateError.gif)  
  
**Рис. SEQ. \\ \* Арабский 5 дсак ошибка создания пользователя в системе, отличной от windows Server 2012 R2, при использовании windows Server 2012 R2 DC**  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig10_UserModError.gif)  
  
**Рис. SEQ. \\ \* Арабский 6 дсак ошибка изменения пользователя в не windows Server 2012 R2 с целью windows Server 2012 R2 DC**  
  
### <a name="restore-of-an-object-that-would-result-in-a-duplicate-upn-fails"></a>Восстановление объекта, которое привело бы к появлению повторяющегося имени участника-пользователя, завершается ошибкой:  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig11_RestoreDupUPN.gif)  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig12_RestoreDupUPNError.gif)  
  
Событие не регистрируется, если не удается восстановить объект из-за повторяющегося UPN или SPN.  
  
Имя участника-пользователя для объекта должно быть уникальным, чтобы его можно было восстановить.  
  
1.  Указание имени участника-пользователя, существующего в объекте в корзине  
  
2.  Выявление всех объектов, имеющих одинаковое значение  
  
3.  Удалить дублирующиеся UPN-имена  
  
### <a name="identify-the-conflicting-upn-on-the-deleted-objectusing-repadminexe"></a>Определяет конфликтующее имя участника-пользователя на удаленном Обжектусинг repadmin.exe  
  
```  
Repadmin /showattr DCName "DN of deleted objects container" /subtree /filter:"(msDS-LastKnownRDN=<NAME>)" /deleted /atts:userprincipalname  
```  
  
```  
repadmin /showattr DCName "CN=Deleted Objects,DC=blue,DC=contoso,DC=com" /subtree /filter:"(msDS-LastKnownRDN=Dianne Hunt2)" /deleted /atts:userprincipalname  
  
C:\>repadmin /showattr winbluedc1 "cn=deleted objects,dc=blue,dc=contoso,dc=com" /subtree /filter:"(msds-lastknownrdn=Dianne Hunt2)" /deleted /atts:userprincipalname  
DN: CN=Dianne Hunt2\0ADEL:dd3ab8a4-3005-4f2f-814f-d6fc54a1a1c0,CN=Deleted Object  
s,DC=blue,DC=contoso,DC=com  
    1> userPrincipalName: dhunt@blue.contoso.com  
```  
  
### <a name="to-identify-all-objects-with-the-same-upnusing-repadminexe"></a>Чтобы найти все объекты с одним именем участника-пользователя, используйте Repadmin.exe  
  
```  
repadmin /showattr WinBlueDC1 "DC=blue,DC=contoso,DC=com" /subtree /filter:"(userPrincipalName=dhunt@blue.contoso.com)" /deleted /atts:DN  
  
C:\>repadmin /showattr winbluedc1 "dc=blue,dc=contoso,dc=com" /subtree /filter:"(userPrincipalName=dhunt@blue.contoso.com)" /deleted /atts:DN  
DN: CN=Administrator,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=xouser1,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=xouser10,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=xouser100,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=Dianne Hunt,OU=Marketing,DC=blue,DC=contoso,DC=com  
DN: CN=Dianne Hunt2\0ADEL:dd3ab8a4-3005-4f2f-814f-d6fc54a1a1c0,CN=Deleted Objects,DC=blue,DC=contoso,DC=com  
```  
  
> [!TIP]  
> Ранее недокументированный параметр **/делетед** в repadmin.exe используется для включения удаленных объектов в результирующий набор  
  
### <a name="using-global-search"></a>Использование глобального поиска  
  
-   Открытие центр администрирования Active Directory и переход к **глобальному поиску**  
  
-   Выберите переключатель **преобразовать в LDAP** .  
  
-   Тип **(userPrincipalName =*конфликтингупн*)**  
  
    -   Замените ***конфликтингупн*** фактическим именем участника-пользователя, конфликтующим  
  
-   Нажмите кнопку **Применить** .  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig13_GlobalSearch.gif)  
  
### <a name="using-windows-powershell"></a>Использование Windows PowerShell  
  
```  
Get-ADObject -LdapFilter "(userPrincipalName=dhunt@blue.contoso.com)" -IncludeDeletedObjects -SearchBase "DC=blue,DC=Contoso,DC=com" -SearchScope Subtree -Server winbluedc1.blue.contoso.com  
```  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig13_GlobalSearchPS.gif)  
  
Если объект необходимо восстановить, необходимо удалить дубликаты UPN из других объектов.  Только для одного объекта достаточно просто использовать ADSIEdit для удаления дубликата.  Если существует несколько объектов с дубликатами, то лучше использовать Windows PowerShell.  
  
Для значения null атрибута UserPrincipalName с помощью Windows PowerShell:  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig15_NullUPN.gif)  
  
> [!NOTE]  
> Атрибут userPrincipalName является атрибутом с одним значением, поэтому эта процедура удаляет только повторяющееся имя участника-пользователя.  
  
### <a name="duplicate-spn"></a>Повторяющееся имя субъекта-службы  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig16_DupSPN.gif)  
  
**Рис. SEQ. \\ \* сообщение об ошибке арабского 8, отображаемое в ADSIEdit, если Добавление повторяющегося имени субъекта-службы заблокировано**  
  
В журнал событий служб каталогов входит **ActiveDirectory_DomainService** событие с идентификатором **2974**.  
  
```  
Operation failed. Error code: 0x21c7  
The operation failed   
The attribute value provided is not unique in the forest or partition. Attribute:  
servicePrincipalName Value=<SPN>  
<Object DN> Winerror: 8467  
```  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig17_DupSPN2974.gif)  
  
**Рис. номер \\ \* арабского 9 ошибка при создании повторяющегося имени участника-службы заблокирована**  
  
### <a name="workflow"></a>Рабочий процесс  
  
-   **Если DC = = GC**  
  
    -   Не требуется вызов оффбокс, запрос может быть удовлетворен локально  
  
    -   ***Случай имени участника-пользователя***  
  
        -   Запрос в локальном лесу индекса UPN для предоставляемого имени участника-пользователя (*userPrincipalName; глобальный индекс*)  
  
            -   Если возвращены элементы = = 0-> запись продолжается  
  
            -   Если возвращены записи! = 0-> ошибка записи  
  
                -   Запись в журнале  
  
                -   Также возвращает расширенную ошибку:  
  
                    -   **8648:**  
  
                        *ERROR_DS_UPN_VALUE_NOT_UNIQUE_IN_FOREST*  
  
    -   ***Обращение к имени участника-службы***  
  
        -   Запрос индекса SPN в локальном лесу для предоставляемого имени участника-службы ("стандарт"*; глобальный индекс*)  
  
            -   Если возвращены элементы = = 0-> запись продолжается  
  
            -   Если возвращены записи! = 0-> ошибка записи  
  
                -   Запись в журнале  
  
                -   Также возвращает расширенную ошибку:  
  
                    -   **8647:**  
  
                        **ERROR_DS_SPN_VALUE_NOT_UNIQUE_IN_FOREST**  
  
-   **Если DC! = GC**  
  
    -   Оффбокс Call ( **желательно** , но не критическое), т. е. это проверка уникальности.  
  
        -   Проверка продолжается только для локального каталога DIT, если не удается найти GC  
  
        -   Зарегистрировано событие, чтобы указать  
  
    -   ***Случай имени участника-пользователя***  
  
        -   Отправить запрос LDAP к ближайшему сборщику мусора? индексирование имени участника-пользователя в масштабе всего леса GC для заданного UPN (*userPrincipalName; глобальный индекс*)  
  
            -   Если возвращены элементы = = 0-> запись продолжается  
  
            -   Если возвращены записи! = 0-> ошибка записи  
  
                -   Запись в журнале  
  
                -   Также возвращает расширенную ошибку:  
  
                    -   **8648:**  
  
                        *ERROR_DS_UPN_VALUE_NOT_UNIQUE_IN_FOREST*  
  
    -   ***Обращение к имени участника-службы***  
  
        -   Отправить запрос LDAP к ближайшему сборщику мусора? индексирование имен участников-служб в лесу сборщика мусора для предоставляемого SPN (имя приложения,*глобальный индекс*)  
  
            -   Если возвращены элементы = = 0-> запись продолжается  
  
            -   Если возвращены записи! = 0-> ошибка записи  
  
                -   Запись в журнале  
  
                -   Также возвращает расширенную ошибку:  
  
                    -   **8647:**  
  
                        *ERROR_DS_SPN_VALUE_NOT_UNIQUE_IN_FOREST*  
  
При повторном анимировании удаленных объектов значения имени участника-службы или имени участника-пользователя проверяются на уникальность. При обнаружении дубликата запрос завершается ошибкой.  
  
-   Для некоторых изменений атрибутов, таких как имя узла DNS, имя учетной записи SAM и т. д. при внесении изменений имена участников-служб обновляются соответствующим образом. В процессе удаляются устаревшие имена участников-служб, а затем создаются новые имена участников-служб и добавляются в базу данных. Изменения атрибута реквизита, с которыми срабатывает этот путь:  
  
    -   ATT_DNS_HOST_NAME  
  
    -   ATT_MS_DS_ADDITIONAL_DNS_HOST_NAME  
  
    -   ATT_SAM_ACCOUNT_NAME  
  
    -   ATT_MS_DS_ADDITIONAL_SAM_ACCOUNT_NAME  
  
    -   ATT_SERVER_REFERENCE_BL  
  
    -   ATT_USER_ACCOUNT_CONTROL  
  
Если любое новое значение имени субъекта-службы дублируется, мы не будем вносить изменения. В приведенном выше списке важны атрибуты ATT_DNS_HOST_NAME (имя компьютера) и ATT_SAM_ACCOUNT_NAME (имя учетной записи SAM).  
  
### <a name="try-this-exploring-spn-and-upn-uniqueness"></a>Попробуйте это: изучение имени участника-службы и уникальности имени участника-пользователя  
Это первое из нескольких действий "**попробуйте**" в модуле.  Для этого модуля не существует отдельного лабораторного руководства.  Действия по тестированию — **это** , по сути, бесплатные действия, позволяющие исследовать материал урока в лабораторной среде.  Вы можете следовать предложению или отключать сценарий и создавать собственные действия.  
  
> [!NOTE]  
> -   Это первое из нескольких действий "**попробуйте**".  
> -   Для этого модуля не существует отдельного лабораторного руководства.  
> -   Действия по тестированию — **это** , по сути, бесплатные действия, позволяющие исследовать материал урока в лабораторной среде.  
> -   Вы можете следовать предложению или отключать сценарий и создавать собственные действия.  
> -   Хотя не все разделы **попытаются выполнить этот** запрос, по-прежнему рекомендуется исследовать содержимое занятия в лаборатории, где это необходимо.  
  
Экспериментируйте с именами участников-служб и уникальности имени участника-пользователя.  Выполняйте эти запросы или заполните свои собственные.  
  
1.  Создание новых пользователей с помощью имени участника-пользователя  
  
2.  Создание учетных записей с именами участников-служб  
  
3.  Либо создайте нового пользователя с именем участника-пользователя, которое уже было определено ранее, либо измените имя участника-пользователя существующей учетной записи.  Сделайте то же самое для имени субъекта-службы в другой учетной записи  
  
    1.  Заполнение существующей учетной записи пользователя с помощью имени участника-пользователя, которое уже используется  
  
        1.  Использование PowerShell, ADSIEDIT или центр администрирования Active Directory (DSAC.exe)  
  
    2.  Заполнение существующей учетной записи с именем субъекта-службы, которое уже используется  
  
        1.  Использование Windows PowerShell, ADSIEDIT или SetSPN  
  
4.  Просмотрите ошибки  
  
**При необходимости**  
  
1.  Проверяйте с помощью преподавателей, чтобы включить *[корзину AD](../../get-started/adac/advanced-ad-ds-management-using-active-directory-administrative-center--level-200-.md#BKMK_EnableRecycleBin)* в центр администрирования Active Directory.  Если да, переходите к следующему шагу.  
  
2.  Заполнение UPN для учетной записи пользователя  
  
3.  Удаление учетной записи  
  
4.  Заполнение другой учетной записи с тем же именем участника-пользователя, что и у удаленной учетной записи  
  
5.  Попытка восстановить учетную запись с помощью графического пользовательского интерфейса корзины  
  
6.  Представьте, что вы только что выдавали ошибку, которая отображается на предыдущем шаге.  (без ведения журнала действий, которые вы только что выполнили) Ваша цель — завершить восстановление учетной записи.  Примеры действий см. в книге.  
  
