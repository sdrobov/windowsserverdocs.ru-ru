---
title: Устранение неполадок с помощью средства диагностики защищенной структуры
ms.custom: na
ms.prod: windows-server
ms.topic: article
ms.assetid: 07691d5b-046c-45ea-8570-a0a85c3f2d22
manager: dongill
author: huu
ms.technology: security-guarded-fabric
ms.openlocfilehash: 6db9ce1db139558bd1a7aa731cb12c1b227ead03
ms.sourcegitcommit: 083ff9bed4867604dfe1cb42914550da05093d25
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75949763"
---
# <a name="troubleshooting-using-the-guarded-fabric-diagnostic-tool"></a>Устранение неполадок с помощью средства диагностики защищенной структуры

>Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

В этом разделе описывается использование диагностического средства диагностики структур для обнаружения и устранения распространенных сбоев при развертывании, настройке и переходе к работе в инфраструктуре защищенной структуры. Сюда входит служба защиты узла (HGS), все защищенные узлы и вспомогательные службы, такие как DNS и Active Directory. Средство диагностики можно использовать для первого прохода при рассмотрении незащищенной структуры, предоставляя администраторам отправную точку для устранения простоев и выявления неверно настроенных ресурсов. Это средство не является заменой для работы с защищенной структурой и служит только для быстрой проверки наиболее распространенных проблем, возникающих в ходе повседневных операций.

Документацию по командлетам, используемым в этом разделе, можно найти на [сайте TechNet](https://technet.microsoft.com/library/mt718834.aspx).

[!INCLUDE [Guarded fabric diagnostics tool](../../../includes/guarded-fabric-diagnostics-tool.md)] 

## <a name="quick-start"></a>Краткое руководство

Вы можете диагностировать защищенный узел или узел HGS, вызывая следующую команду из сеанса Windows PowerShell с правами локального администратора:
```PowerShell
Get-HgsTrace -RunDiagnostics -Detailed
```
Это автоматически определит роль текущего узла и выполнит диагностику соответствующих проблем, которые могут быть обнаружены автоматически.  Все результаты, созданные во время этого процесса, отображаются из-за наличия параметра `-Detailed`.

В оставшейся части этого раздела приводится подробное пошаговое руководство по расширенному использованию `Get-HgsTrace` для выполнения таких задач, как диагностика нескольких узлов одновременно и обнаружение сложной конфигурации между узлами.

## <a name="diagnostics-overview"></a>Обзор диагностики
Защищенная Диагностика структуры доступна на любом узле, на котором установлены средства и компоненты, связанные с экранированной виртуальной машиной, включая узлы, на которых работает Server Core.  В настоящее время диагностика включает в себя следующие компоненты и пакеты:

1. Роль службы защиты узла
2. Поддержка защиты узла Hyper-V
3. Средства экранирования виртуальных машин для управления структурой
4. Средства удаленного администрирования сервера (RSAT)

Это означает, что средства диагностики будут доступны на всех защищенных узлах, узлах HGS, определенных серверах управления Fabric и на всех рабочих станциях Windows 10 с установленным [RSAT](https://www.microsoft.com/download/details.aspx?id=45520) .  Диагностика может быть вызвана на любом из указанных выше компьютеров с целью диагностики любого защищенного узла или узла HGS в защищенной структуре. с помощью удаленных целевых объектов трассировки диагностика может выполнять обнаружение и подключение к узлам, отличным от компьютера, на котором выполняются средства диагностики.

Каждый узел, предназначенный для диагностики, называется "целью трассировки".  Цели трассировки идентифицируются по именам узлов и ролей.  Роли описывают функцию, которую выполняет заданный целевой объект трассировки в защищенной структуре.  В настоящее время целевые объекты трассировки поддерживают `HostGuardianService` и `GuardedHost` ролей.  Обратите внимание, что узел может занимать несколько ролей одновременно, и это также поддерживается диагностикой, однако это не следует делать в рабочих средах.  Узлы HGS и Hyper-V должны храниться отдельно и отличаться в любое время.

Администраторы могут начать выполнение любых диагностических задач, запустив `Get-HgsTrace`.  Эта команда выполняет две различные функции на основе параметров, предоставленных во время выполнения: трассировка сбора и диагностика.  Эти две комбинации составляют весь инструмент для диагностики защищенной структуры.  Хотя не требуется явно, для наиболее полезной диагностики требуются трассировки, которые могут быть собраны только с учетными данными администратора в целевом объекте трассировки.  Если пользователь, запускающий сбор трассировки, удерживает недостаточные привилегии, трассировка, запрашивающая повышение прав, завершится ошибкой, а все остальные будут пройдены.  Это позволяет выполнить частичную диагностику в случае, если оператор с правами на выполнение операций выполняет рассмотрение. 

### <a name="trace-collection"></a>Трассировка коллекции
По умолчанию `Get-HgsTrace` собираются только трассировки и сохраняет их во временной папке.  Трассировка принимает форму папки с именем, заданной после целевого узла, заполненной специально отформатированными файлами, описывающими настройку узла.  Трассировки также содержат метаданные, описывающие способ вызова диагностики для накопления трассировок.  Эти данные используются системой диагностики для повторного заполнения информации об узле при ручной диагностике.

При необходимости трассировки можно проверить вручную.  Все форматы могут быть либо понятными (XML), либо легко проверены с помощью стандартных средств (например, сертификатов X509 и расширений оболочки шифрования Windows).  Обратите внимание, что трассировки не предназначены для ручной диагностики и всегда более эффективны для обработки трассировок с помощью средств диагностики `Get-HgsTrace`.

Результаты выполнения сбора трассировки не позволяют определить состояние работоспособности данного узла.  Они просто указывают, что трассировки успешно собраны.  Необходимо использовать средства диагностики `Get-HgsTrace`, чтобы определить, указывают ли трассировки на сбойную среду.

С помощью параметра `-Diagnostic` можно ограничить коллекцию трассировки только теми трассировками, которые необходимы для выполнения указанной диагностики.  Это сокращает объем собираемых данных, а также разрешения, необходимые для запуска диагностики.

### <a name="diagnosis"></a>Диагностика
Собранные трассировки можно диагностировать, если указать `Get-HgsTrace` расположение трассировок с помощью параметра `-Path` и указать параметр `-RunDiagnostics`.  Кроме того, `Get-HgsTrace` может выполнять сбор и диагностику за один проход, предоставляя параметр `-RunDiagnostics` и список целевых объектов трассировки.  Если цели трассировки не предоставлены, текущий компьютер используется как неявный целевой объект, а его роль выводится путем проверки установленных модулей Windows PowerShell.

Диагностика предоставит результаты в виде иерархического формата, показывающего, какие цели трассировки, диагностические наборы и отдельные средства диагностики отвечают за определенный сбой.  Ошибки включают рекомендации по исправлению и разрешению, если можно определить, какое действие следует предпринять далее.  По умолчанию передача и несущественные результаты скрыты.  Чтобы просмотреть все, что проверяется диагностикой, укажите параметр `-Detailed`.  Это приведет к отображению всех результатов независимо от их состояния.

Можно ограничить набор диагностических данных, выполняемых с помощью параметра `-Diagnostic`.  Это позволяет указать, какие классы диагностики должны выполняться для целевых объектов трассировки, и подавить все остальные.  Примеры доступных классов диагностики включают в себя сети, рекомендации и клиентское оборудование.  Ознакомьтесь с [документацией по командлетам](https://technet.microsoft.com/library/mt718831.aspx) , чтобы найти актуальный список доступных диагностических сведений.

> [!WARNING]
> Диагностика не является заменой для конвейера строгого мониторинга и реагирования на инциденты.  Существует пакет System Center Operations Manager, доступный для отслеживания защищенных структур, а также различные каналы журнала событий, которые можно отслеживать для обнаружения проблем на раннем этапе.  Затем можно использовать диагностику для быстрого рассмотрения этих сбоев и выполнения действий.

## <a name="targeting-diagnostics"></a>Целевая диагностика

`Get-HgsTrace` работает с целями трассировки.  Цель трассировки — это объект, соответствующий узлу HGS или защищенному узлу внутри защищенной структуры.  Его можно рассматривать как расширение для `PSSession`, которое содержит сведения, необходимые только для диагностики, например роль узла в структуре.  Целевые объекты могут создаваться неявно (например, локальная или ручная диагностика) или явно с помощью команды `New-HgsTraceTarget`.

### <a name="local-diagnosis"></a>Локальная диагностика

По умолчанию `Get-HgsTrace` будет ориентироваться на localhost (т. е. где вызывается командлет).  Это называется неявным локальным целевым объектом.  Неявный локальный целевой объект используется только в том случае, если в параметре `-Target` не указаны целевые объекты и в `-Path`не обнаружены предварительно существовавшие трассировки.

Неявный локальный целевой объект использует определение роли для определения роли, которую текущий узел воспроизводит в защищенной структуре.  Это основано на установленных модулях Windows PowerShell, которые примерно соответствуют функциям, установленным в системе.  Наличие модуля `HgsServer` приведет к тому, что целевой объект трассировки будет принимать роль `HostGuardianService` и присутствие модуля `HgsClient` приведет к тому, что целевой объект трассировки будет принимать `GuardedHost`роли.  У данного узла может быть оба модуля, и в таком случае он будет рассматриваться как `HostGuardianService` и как `GuardedHost`.

Таким образом, при локальном вызове диагностики по умолчанию для сбора трассировок:
```PowerShell
Get-HgsTrace
```
... эквивалентно следующему:
```PowerShell
New-HgsTraceTarget -Local | Get-HgsTrace
```
> [!TIP]
> `Get-HgsTrace` может принимать целевые объекты через конвейер или напрямую через параметр `-Target`.  Разница между этими двумя операциями отсутствует.

### <a name="remote-diagnosis-using-trace-targets"></a>Удаленная диагностика с использованием целевых объектов трассировки

Можно удаленно диагностировать узел путем создания целевых объектов трассировки с информацией об удаленном подключении.  Все, что требуется, — это имя узла и набор учетных данных, способных подключаться с помощью удаленного взаимодействия Windows PowerShell.
```PowerShell
$server = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential)
Get-HgsTrace -RunDiagnostics -Target $server
```
В этом примере создается запрос на сбор учетных данных удаленного пользователя, а затем система диагностики запускается с помощью удаленного узла на `hgs-01.secure.contoso.com` для завершения сбора трассировки.  Полученные трассировки загружаются на localhost, а затем — в ходе диагностики.  Результаты диагностики представляются так же, как и при [локальной диагностике](#local-diagnosis).  Аналогичным образом не нужно указывать роль, так как она может быть выведена на основе модулей Windows PowerShell, установленных в удаленной системе.

Удаленная диагностика использует удаленное взаимодействие Windows PowerShell для всех обращений к удаленному узлу.  Таким образом, это обязательное условие того, что для цели трассировки включено удаленное взаимодействие Windows PowerShell (см. раздел [Enable PSRemoting](https://technet.microsoft.com/library/hh849694.aspx)) и что localhost правильно настроен для запуска подключений к целевому объекту.

> [!NOTE]
> В большинстве случаев необходимо, чтобы localhost был частью одного леса Active Directory и было использовано допустимое имя узла DNS.  Если в вашей среде используется более сложная модель Федерации или вы хотите использовать прямые IP-адреса для подключения, может потребоваться выполнить дополнительную настройку, например настроить [Доверенные узлы](https://technet.microsoft.com/library/ff700227.aspx)WinRM.

Вы можете убедиться, что целевой объект трассировки правильно создан и настроен для приема соединений с помощью командлета `Test-HgsTraceTarget`:
```PowerShell
$server = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential)
$server | Test-HgsTraceTarget
```
Эта команда возвратит `$True`, только если `Get-HgsTrace` сможет установить удаленный сеанс диагностики с целью трассировки.  При сбое этот командлет возвратит актуальные сведения о состоянии для дальнейшего устранения неполадок подключения удаленного взаимодействия Windows PowerShell.

#### <a name="implicit-credentials"></a>Неявные учетные данные

При удаленной диагностике у пользователя, обладающего достаточными привилегиями для удаленного подключения к цели трассировки, нет необходимости предоставлять учетные данные для `New-HgsTraceTarget`.  Командлет `Get-HgsTrace` автоматически повторно использует учетные данные пользователя, вызвавшего командлет, при открытии соединения.

> [!WARNING]
> Некоторые ограничения применяются для повторного использования учетных данных, особенно при выполнении второго прыжка.  Это происходит при попытке повторного использования учетных данных в удаленном сеансе на другом компьютере.  Для поддержки этого сценария необходимо [настроить CredSSP](https://technet.microsoft.com/library/hh849872.aspx) , но это не относится к области защищенного управления структурой и устранению неполадок.

#### <a name="using-windows-powershell-just-enough-administration-jea-and-diagnostics"></a>Использование Windows PowerShell только для администрирования (JEA) и диагностики

Удаленная диагностика поддерживает использование конечных точек Windows PowerShell с ограничением JEA. По умолчанию удаленные целевые объекты трассировки будут подключаться с помощью конечной точки `microsoft.powershell` по умолчанию.  Если цель трассировки имеет роль `HostGuardianService`, она также будет пытаться использовать конечную точку `microsoft.windows.hgs`, которая настроена при установке HGS.

Если вы хотите использовать пользовательскую конечную точку, необходимо указать имя конфигурации сеанса при построении целевого объекта трассировки с помощью параметра `-PSSessionConfigurationName`, как показано ниже.

```PowerShell
New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential) -PSSessionConfigurationName "microsoft.windows.hgs"
```

#### <a name="diagnosing-multiple-hosts"></a>Диагностика нескольких узлов

Несколько целевых объектов трассировки можно передать одновременно `Get-HgsTrace`.  Сюда входит смесь локальных и удаленных целевых объектов.  Каждая цель будет отслеживаться в свою очередь, а затем будут диагностироваться все трассировки каждой цели.  Средство диагностики может использовать расширенные знания о развертывании для определения сложных недопустимых конфигураций между узлами, которые в противном случае не обнаруживаются.  При использовании этой функции требуется только предоставление трассировок с нескольких узлов одновременно (в случае ручной диагностики) или выбор нескольких узлов при вызове `Get-HgsTrace` (в случае удаленной диагностики).

Ниже приведен пример использования удаленной диагностики для рассмотрения структуры, состоящей из двух узлов HGS и двух защищенных узлов, где один из защищенных узлов используется для запуска `Get-HgsTrace`.

```PowerShell
$hgs01 = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Credential (Enter-Credential)
$hgs02 = New-HgsTraceTarget -HostName "hgs-02.secure.contoso.com" -Credential (Enter-Credential)
$gh01 = New-HgsTraceTarget -Local
$gh02 = New-HgsTraceTarget -HostName "guardedhost-02.contoso.com"
Get-HgsTrace -Target $hgs01,$hgs02,$gh01,$gh02 -RunDiagnostics
```

> [!NOTE]
> При диагностике нескольких узлов не нужно диагностировать всю защищенную структуру.  Во многих случаях достаточно включить все узлы, которые могут быть вовлечены в заданное условие сбоя.  Обычно это подмножество защищенных узлов и некоторое количество узлов из кластера HGS.

## <a name="manual-diagnosis-using-saved-traces"></a>Ручная диагностика с помощью сохраненных трассировок

Иногда может потребоваться повторное выполнение диагностики без сбора трассировок снова или нет необходимых учетных данных для удаленной диагностики всех узлов в вашей структуре одновременно.  Ручная диагностика — это механизм, с помощью которого можно по-прежнему выполнять рассмотрение по всей структуре с использованием `Get-HgsTrace`, но без использования удаленной коллекции трассировки.

Прежде чем выполнять диагностику вручную, необходимо убедиться, что администраторы каждого узла в структуре, которые будут рассмотрены, готовы и хотят выполнять команды от вашего имени.  Выходные данные диагностической трассировки не предоставляют никакой информации, которая обычно просматривается как конфиденциальная, однако он именно от пользователя, чтобы определить, может ли он быть уверенным в предоставлении этих сведений другим пользователям.

> [!NOTE]
> Трассировки не являются анонимными и раскрывают конфигурацию сети, параметры PKI и другую конфигурацию, которая иногда рассматривается как частная информация.  Поэтому трассировка должна передаваться только в доверенные сущности в пределах организации и никогда не публиковаться в общедоступной области.

Ниже приведены шаги для выполнения ручной диагностики.

1. Попросите каждого администратора узла запустить `Get-HgsTrace` указав известное `-Path` и список диагностических данных, которые будут выполняться с результирующими трассировками.  Пример

   ```PowerShell
   Get-HgsTrace -Path C:\Traces -Diagnostic Networking,BestPractices
   ```
2. Запросите каждого из администраторов узлов результирующую папку трассировок и отправьте ее вам.  Этот процесс может осуществляться по электронной почте, через общие папки или любой другой механизм, основанный на политиках и процедурах, установленных в вашей организации.

3. Объединить все полученные трассировки в одну папку без других содержимого или папок.

    * Например, предположим, что администраторы отправили трассировки, собранные из четырех компьютеров с именами HGS-01, HGS-02, RR1N2608-12 и RR1N2608-13.  Каждый администратор отправил вам папку с тем же именем.  Вы собрали структуру каталогов, которая выглядит следующим образом:

      ```
      FabricTraces
      |- HGS-01
      |  |- TargetMetadata.xml
      |  |- Metadata.xml
      |  |- [any other trace files for this host]
      |- HGS-02
      |  |- [...]
      |- RR1N2608-12
      |  |- [...]
      |- RR1N2608-13
         |- [..]
      ```

4. Выполните диагностику, указав путь к собранной папке трассировки в параметре `-Path` и указав параметр `-RunDiagnostics`, а также диагностические сведения, для которых вы запросили администраторам собирать трассировки.  Диагностика предполагает, что она не может получить доступ к узлам, найденным внутри пути, и, следовательно, попытается использовать только предварительно собранные трассировки.  Если какие бы то ни было трассировки отсутствуют или повреждены, диагностика будет завершаться сбоем только для соответствующих тестов и продолжать работу в обычном режиме.  Пример

   ```PowerShell
   Get-HgsTrace -RunDiagnostics -Diagnostic Networking,BestPractices -Path ".\FabricTraces"
   ```

### <a name="mixing-saved-traces-with-additional-targets"></a>Смешивание сохраненных трассировок с дополнительными целевыми объектами

В некоторых случаях у вас может быть набор предварительно собранных трассировок, которые вы хотите дополнить дополнительными трассировками узлов.  Можно смешивать предварительно собранные трассировки с дополнительными целевыми объектами, которые будут отслеживаться и диагностироваться в одном вызове диагностики.

Следуя инструкциям по сбору и сборке указанной выше папки трассировки, вызовите `Get-HgsTrace` с дополнительными целями трассировки, не найденными в предварительно собранной папке трассировки:

```PowerShell
$hgs03 = New-HgsTraceTarget -HostName "hgs-03.secure.contoso.com" -Credential (Enter-Credential)
Get-HgsTrace -RunDiagnostics -Target $hgs03 -Path .\FabricTraces
``` 

Командлет диагностики будет определять все предварительно собранные узлы и один дополнительный узел, по-прежнему требующий трассировки и выполняющий необходимую трассировку.  Будет выявляться сумма всех предварительно собранных и собранных трассировок.  Результирующая Папка трассировки будет содержать как старые, так и новые трассировки.
