---
title: Обновление защищенной структуры до Windows Server 2019
ms.prod: windows-server
ms.topic: article
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.technology: security-guarded-fabric
ms.date: 11/21/2018
ms.openlocfilehash: 50e35939031a74173fb031cf963af97bf8bb6dba
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80856357"
---
# <a name="upgrade-a-guarded-fabric-to-windows-server-2019"></a>Обновление защищенной структуры до Windows Server 2019

> Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

В этой статье описываются действия, необходимые для обновления существующей защищенной структуры с Windows Server 2016, Windows Server версии 1709 или Windows Server версии 1803 до Windows Server 2019.

## <a name="whats-new-in-windows-server-2019"></a>Новые возможности Windows Server 2019

При запуске защищенной структуры на Windows Server 2019 можно воспользоваться преимуществами нескольких новых функций:

**Аттестация ключа узла** — это самый новый режим аттестации, предназначенный для упрощения запуска экранированных виртуальных машин, если на узлах Hyper-V нет устройств TPM 2,0, доступных для аттестации доверенного платформенного модуля. Аттестация ключа узла использует пары ключей для проверки подлинности узлов с помощью HGS, устраняя необходимость присоединения узлов к домену Active Directory, исключая доверие AD между HGS и корпоративным лесом и уменьшая число открытых портов брандмауэра. Аттестация ключа узла заменяет Active Directory аттестации, которая является устаревшей в Windows Server 2019.

**Версия аттестации v2** . для поддержки аттестации ключа узла и новых функций в будущем мы предоставили управление ВЕРСИЯМИ для HGS. Новая установка HGS на Windows Server 2019 приведет к тому, что сервер будет использовать аттестацию v2. Это означает, что он может поддерживать аттестацию ключа узла для узлов Windows Server 2019 и по-прежнему поддерживать узлы v1 в Windows Server 2016. Обновления на месте до 2019 будут оставаться в версии v1 до тех пор, пока вы не включите версию 2 вручную. У большинства командлетов теперь есть параметр-Хгсверсион, который позволяет указать, следует ли работать со старыми или современными политиками аттестации.

**Поддержка экранированных виртуальных машин Linux** . узлы Hyper-V под управлением Windows Server 2019 могут запускать экранированные виртуальные машины Linux. Хотя экранированные виртуальные машины Linux обработаны с момента выпуска Windows Server версии 1709, Windows Server 2019 является первым выпуском долгосрочного пакета обслуживания для поддержки этих виртуальных машин.

**Улучшения** филиалов. Мы упростили возможность запуска экранированных виртуальных машин в филиалах с поддержкой автономных виртуальных машин и резервных конфигураций на узлах Hyper-V.

**Привязка узла TPM** . для наиболее безопасных рабочих нагрузок, в которых требуется, чтобы ЭКРАНИРОВАНная виртуальная машина выполнялась только на первом узле, где она была создана, но без других, можно ПРИвязать виртуальную машину к этому узлу, используя доверенный платформенный модуль узла. Это лучше всего использовать для рабочих станций привилегированного доступа и филиалов, а не для общих рабочих нагрузок центра обработки данных, которые необходимо перенести между узлами.

## <a name="compatibility-matrix"></a>Матрица совместимости

Перед обновлением защищенной структуры до Windows Server 2019 просмотрите следующую таблицу совместимости, чтобы узнать, поддерживается ли конфигурация.

|  | WS2016 HGS | WS2019 HGS|
|---|---|---|
|**Узел Hyper-V WS2016** | Поддерживается | Поддерживается<sup>1</sup>|
|**Узел Hyper-V WS2019** | Не поддерживается<sup>2</sup> | Поддерживается|

<sup>1</sup> узлы windows Server 2016 могут только подтверждать работу серверов HGS windows Server 2019 с помощью протокола аттестации v1. Новые функции, доступные только в протоколе аттестации v2, включая аттестацию ключей узла, не поддерживаются для узлов Windows Server 2016.

<sup>2</sup> Корпорация Майкрософт осведомлена о проблемах, препятствующим успешной аттестации узлов windows Server 2019, использующих аттестацию доверенного платформенного модуля, на сервере windows Server 2016 HGS. Это ограничение будет решено в будущем обновлении для Windows Server 2016.

## <a name="upgrade-hgs-to-windows-server-2019"></a>Обновление HGS до Windows Server 2019

Рекомендуется обновить кластер HGS до Windows Server 2019 перед обновлением узлов Hyper-V, чтобы убедиться, что все узлы, работающие под управлением Windows Server 2016 или 2019, могут продолжать аттестацию.

Для обновления кластера HGS потребуется временно удалить один узел из кластера в то время, пока он будет обновлен. Это снизит емкость кластера для реагирования на запросы от узлов Hyper-V и может привести к снижению времени отклика или простоев службы для клиентов. Перед обновлением сервера HGS убедитесь, что у вас достаточно ресурсов для обработки аттестации и запросов на освобождение ключей.

Чтобы обновить кластер HGS, выполните следующие действия на каждом узле кластера, по одному узлу за раз:

1.  Удалите сервер HGS из кластера, запустив `Clear-HgsServer` в командной строке PowerShell с повышенными привилегиями. Этот командлет удалит реплицированное хранилище HGS, веб-сайты HGS и узел из отказоустойчивого кластера.
2.  Если сервер HGS является контроллером домена (конфигурацией по умолчанию), необходимо запустить `adprep /forestprep` и `adprep /domainprep` на первом обновляемом узле, чтобы подготовить домен для обновления ОС. Дополнительные сведения см. в [документации по обновлению домен Active Directory Services](https://docs.microsoft.com/windows-server/identity/ad-ds/deploy/upgrade-domain-controllers#supported-in-place-upgrade-paths) .
3.  Выполните [обновление на месте](../../get-started-19/install-upgrade-migrate-19.md) до Windows Server 2019.
4.  Выполните команду [Initialize-HgsServer](guarded-fabric-configure-additional-hgs-nodes.md) , чтобы присоединить узел к кластеру.

После обновления всех узлов до Windows Server 2019 можно при необходимости обновить версию HGS до версии 2 для поддержки новых функций, таких как аттестация ключа узла.

```powershell
Set-HgsServerVersion  v2
```

## <a name="upgrade-hyper-v-hosts-to-windows-server-2019"></a>Обновление узлов Hyper-V до Windows Server 2019

Перед обновлением узлов Hyper-V до Windows Server 2019 убедитесь, что кластер HGS уже обновлен до Windows Server 2019 и вы переместили все виртуальные машины с сервера Hyper-V.

1.  Если вы используете политики целостности кода управления приложениями в Защитнике Windows на сервере (всегда при использовании аттестации TPM), перед попыткой обновления сервера убедитесь, что политика находится в режиме аудита или отключена. [Сведения об отключении политики WDAC](https://docs.microsoft.com/windows/security/threat-protection/windows-defender-application-control/disable-windows-defender-application-control-policies)
2.  Следуйте инструкциям в статье [Обновление Windows Server](../../upgrade/upgrade-overview.md) , чтобы обновить узел до Windows Server 2019. Если узел Hyper-V является частью отказоустойчивого кластера, можно использовать [последовательное обновление операционной системы кластера](../../failover-clustering/Cluster-Operating-System-Rolling-Upgrade.md).
3.  [Протестируйте и повторно включите](https://docs.microsoft.com/windows/security/threat-protection/windows-defender-application-control/audit-windows-defender-application-control-policies) политику управления приложениями в Защитнике Windows, если она была включена до обновления.
4.  Запустите `Get-HgsClientConfiguration`, чтобы проверить, что **ишостгуардед = true**, что означает, что узел успешно передает аттестацию на сервер HGS.
5.  Если вы используете аттестацию доверенного платформенного модуля, может потребоваться [повторно записать базовые показатели доверенного платформенного модуля или политики целостности кода](guarded-fabric-add-host-information-for-tpm-trusted-attestation.md) после обновления для передачи аттестации.
6.  Снова запустите запуск экранированных виртуальных машин на узле.

## <a name="switch-to-host-key-attestation"></a>Переключиться на аттестацию ключа узла

Выполните следующие действия, если в настоящее время выполняется аттестация на основе Active Directory и требуется выполнить обновление до аттестации ключа узла. Обратите внимание, что аттестация на основе Active Directory является устаревшей в Windows Server 2019 и может быть удалена в будущем выпуске.

1.  Убедитесь, что сервер HGS работает в режиме аттестации v2, выполнив следующую команду. Существующие узлы версии 1 будут по-прежнему подтверждать аттестацию, даже если сервер HGS обновлен до версии 2.

    ```powershell
    Set-HgsServerVersion v2
    ```

2.  [Создайте ключи узлов](guarded-fabric-create-host-key.md) на каждом из узлов Hyper-V и зарегистрируйте их в HGS. Так как HGS по-прежнему работает в режиме Active Directory, вы получите предупреждение о том, что новые ключи узла не вступают в силу немедленно. Это сделано намеренно, так как вы не хотите изменять режим ключа узла до тех пор, пока все узлы не будут успешно подтверждать ключи узла.

3.  После регистрации ключей узлов для каждого узла можно настроить в HGS использование режима аттестации ключа узла:

    ```powershell
    Set-HgsServer -TrustHostKey
    ```

    При возникновении проблем с режимом ключа узла и необходимости вернуться к аттестации на основе Active Directory выполните следующую команду в HGS:

    ```powershell
    Set-HgsServer -TrustActiveDirectory
    ```