---
title: Служба теневого копирования томов
ms.date: 01/30/2019
ms.prod: windows-server
ms.technology: storage
author: JasonGerend
manager: elizapo
ms.author: jgerend
ms.openlocfilehash: 1ab941e25da7171349bb24762940af3bf886c165
ms.sourcegitcommit: a4b489d0597b6a73c905d3448d5bc332efd6191b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/27/2020
ms.locfileid: "77675365"
---
# <a name="volume-shadow-copy-service"></a>Служба теневого копирования томов

Применяется к: Windows Server 2019, Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008, Windows 10, Windows 8.1, Windows 8, Windows 7

Резервное копирование и восстановление важных бизнес-данных может быть очень сложным из-за приведенных ниже проблем.

  - Данные обычно следует архивировать, пока приложения, которые их производят, все еще работают. Это означает, что некоторые файлы данных могут быть открыты или находятся в несогласованном состоянии.

  - Если набор данных большой, может быть сложно выполнить резервное копирование всего за один раз.


Для правильного выполнения операций резервного копирования и восстановления требуется тесная координация между приложениями резервного копирования, бизнес-приложениями, для которых выполняется резервное копирование, оборудованием и программным обеспечением управления хранением. Служба теневого копирования томов (VSS), которая появилась в Windows Server® 2003, упрощает взаимодействие между этими компонентами, позволяя им лучше работать вместе. Если все компоненты поддерживают VSS, их можно использовать для резервного копирования данных приложения, не переводя приложения в автономный режим.

VSS координирует действия, необходимые для создания единообразной теневой копии (также известной как моментальный снимок или копия "на момент времени") архивируемых данных. Теневая копия может использоваться "как есть", или ее можно использовать в следующих сценариях.

  - Вам нужно выполнить резервное копирование данных приложения и информации о состоянии системы, включая архивацию данных на другой жесткий диск, на ленточный накопитель или на другой съемный носитель.

  - Вы занимаетесь интеллектуальным анализом данных.

  - Вы выполняете резервное копирование с диска на диск.

  - Необходимо быстрое восстановление после потери данных путем восстановления данных через исходный LUN или через совершенно новый LUN, который заменяет исходный LUN, вышедший из строя.


К компонентам и приложениям Windows, использующим VSS, относятся следующие:

  - [Система архивации данных Windows Server](https://go.microsoft.com/fwlink/?linkid=180891) (https://go.microsoft.com/fwlink/?LinkId=180891)

  - [Теневые копии общих папок](https://go.microsoft.com/fwlink/?linkid=142874) (https://go.microsoft.com/fwlink/?LinkId=142874)

  - [System Center Data Protection Manager](https://go.microsoft.com/fwlink/?linkid=180892) (https://go.microsoft.com/fwlink/?LinkId=180892)

  - [Восстановление системы](https://go.microsoft.com/fwlink/?linkid=180893) (https://go.microsoft.com/fwlink/?LinkId=180893)


## <a name="how-volume-shadow-copy-service-works"></a>Как работает служба теневого копирования томов

Полное решение VSS требует приведенных ниже основных компонентов.

**Служба VSS**   является частью операционной системы Windows, которая обеспечивает правильное взаимодействие и обмен данными между компонентами.

**Инициатор запроса VSS**    — это программное обеспечение, которое запрашивает фактическое создание теневых копий (или другие операции высокого уровня, такие как их импорт или удаление). Обычно это приложение для резервного копирования. Служебная программа системы архивации данных Windows Server и приложение System Center Data Protection Manager являются инициаторами запросов VSS. Инициаторы запросов VSS, отличные от корпорации Майкрософт®, включают почти все программное обеспечение для резервного копирования, работающее в Windows.

**Модуль записи VSS**    — это компонент, который гарантирует наличие согласованного набора данных для резервного копирования. Обычно он предоставляется как часть бизнес-приложения, например SQL Server® или Exchange Server. Модули записи VSS для различных компонентов Windows, таких как реестр, входят в состав операционной системы Windows. Модули записи VSS сторонних производителей входят в состав многих приложений для Windows, которые должны обеспечить согласованность данных во время резервного копирования.

**Поставщик VSS**    — это компонент, который создает и обслуживает теневые копии. Он может быть в программном обеспечении или оборудовании. Операционная система Windows включает поставщика VSS, который использует операцию копирование при записи. Если используется сеть хранения данных (SAN), то для сети SAN важно установить поставщика оборудования VSS, если такой предоставляется. Поставщик оборудования снимает с себя задачу создания и обслуживания теневой копии из операционной системы узла.

На следующей схеме показано, как служба VSS координирует работу с инициаторами запросов, модулями записи и поставщиками для создания теневой копии тома.

![](media/volume-shadow-copy-service/Ee923636.94dfb91e-8fc9-47c6-abc6-b96077196741(WS.10).jpg)

**Рис. 1**   Архитектурная схема службы теневого копирования томов

### <a name="how-a-shadow-copy-is-created"></a>Создание теневой копии

В этом разделе рассматриваются различные роли инициатора запроса, модуля записи и поставщика в контексте путем перечисления действий, необходимых для создания теневой копии. На следующей схеме показано, как служба теневого копирования томов управляет общей координацией инициатора запроса, модуля записи и поставщика.

![](media/volume-shadow-copy-service/Ee923636.1c481a14-d6bc-4796-a3ff-8c6e2174749b(WS.10).jpg)

**Рис. 2**Процесс создания теневой копии

Для создания теневой копии инициатор запроса, модуль записи и поставщик выполняют приведенные ниже действия.

1.  Инициатор запроса создает запрос в службу теневого копирования томов на перечисление модулей записи, сбор метаданных модуля записи и подготовку к созданию теневой копии.

2.  Каждый модуль записи создает XML-файл описания компонентов и хранилищ данных, для которых необходимо создать резервную копию, и предоставляет их службе теневого копирования томов. Модуль записи определяет метод восстановления, который используется для всех компонентов. Служба теневого копирования томов предоставляет описание модуля записи инициатору запроса, который выбирает компоненты, для которых будет выполняться резервное копирование.

3.  Служба теневого копирования томов уведомляет все модули записи о подготовке данных для создания теневой копии.

4.  Каждый модуль записи подготавливает данные соответствующим образом, например, завершает все открытые транзакции, возвращает журналы транзакций и очищает кэши. Модуль записи уведомляет службу теневого копирования томов о готовности данных к теневому копированию.

5.  Служба теневого копирования томов предписывает модулям записи временно заморозить запросы приложения на запись операций ввода-вывода (запросы операций ввода-вывода для чтения по-прежнему возможны) на несколько секунд, необходимых для создания теневой копии тома или томов. Замораживание приложения не может занять более 60 секунд. Служба теневого копирования томов очищает буферы файловой системы, а затем замораживает состояние файловой системы, что гарантирует, что метаданные файловой системы будут записаны правильно, а данные, предназначенные для теневого копирования, записываются в единообразном порядке.

6.  Служба теневого копирования томов сообщает поставщику о необходимости создания теневой копии. Период создания теневой копии длится не более 10 секунд, в течение которых все запросы на запись операций ввода-вывода в файловую систему остаются замороженными.

7.  Служба теневого копирования томов выпускает запросы на запись операций ввода-вывода в файловой системе.

8.  Служба VSS сообщает модулям записи разморозить запросы приложения на запись операций ввода-вывода. На этом этапе приложения могут возобновить запись данных на диск, на который выполняется теневое копирование.


> [!NOTE]
> Создание теневой копии может быть прервано, если модули записи находятся в замороженном состоянии дольше 60 секунд или если для фиксации теневой копии поставщикам требуется больше 10 секунд.
<br>

9. Инициатор запроса может повторить процесс (вернитесь к шагу 1) или уведомить администратора о необходимости повторить попытку позже.

10. Служба теневого копирования томов возвращает инициатору запроса сведения о расположении для теневого копирования, если теневая копия создана успешно. В некоторых случаях теневая копия может быть временно доступна в качестве тома для чтения и записи, чтобы служба VSS и одно или несколько приложений могли изменять содержимое теневой копии до завершения ее создания. После внесения изменений VSS и приложениями, теневая копия становится доступной только для чтения. Этот этап называется автоматическим восстановлением и используется для отмены любых транзакций файловой системы или приложений в томе теневого копирования, которые не были завершены до создания теневой копии.


### <a name="how-the-provider-creates-a-shadow-copy"></a>Создание теневой копии поставщиком

Поставщик теневого копирования оборудования или программного обеспечения использует один из следующих методов создания теневой копии.

**Полная копия**    — этот метод создает завершенную копию исходного тома (называемую "полной копией" или "клоном") в определенный момент времени. Копия доступна только для чтения.

**Копирование при записи**    — метод не копирует исходный том. Вместо этого создается разностная копия путем копирования всех изменений (завершенных запросов на операции ввода-вывода), внесенных в том после определенного момента времени.

**Перенаправление при записи**   Этот метод не копирует исходный том и не вносит изменения в исходный том после определенного момента времени. Вместо этого создается разностная копия путем перенаправления всех изменений в другой том.

## <a name="complete-copy"></a>Полная копия

Полная копия обычно создается путем выполнения "разделения зеркальной копии", как описано ниже.

1. Исходный том и теневая копия тома являются зеркальным набором томов.

2. Теневая копия тома отделена от исходного тома. Это приводит к разрыву зеркального соединения.


После разрыва зеркального соединения исходный том и теневая копия тома становятся независимыми. Исходный том продолжает принимать все изменения (запросы на запись операций ввода-вывода), в то время как теневая копия тома на момент перерыва остается точной копией исходных данных только для чтения.

### <a name="copy-on-write-method"></a>Метод "копирование при записи"

При изменении исходного тома в методе "копирование при записи" (но до завершения запроса на запись операций ввода-вывода), с каждого изменяемого блока считываются данные, которые затем записываются в место хранения теневой копии тома (также называется "областью копирования"). Область хранения теневых копий может находиться в том же томе или в другом. При этом копия блока данных сохраняется в оригинальном томе, прежде чем изменение перезапишет его.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Время</th>
<th>Исходные данные (состояние и данные)</th>
<th>Теневое копирование (состояние и данные)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>T0</p></td>
<td><p>Исходные данные: 1 2 3 4 5</p></td>
<td><p>Без копирования: —</p></td>
</tr>
<tr class="even">
<td><p>T1</p></td>
<td><p>Данные, измененные в кэше: 3 — 3'</p></td>
<td><p>Создана теневая копия (только различия): 3</p></td>
</tr>
<tr class="odd">
<td><p>T2</p></td>
<td><p>Перезаписаны исходные данные: 1 2 3' 4 5</p></td>
<td><p>Отличия и индекс, хранящиеся в теневой копии: 3</p></td>
</tr>
</tbody>
</table>

**Таблица 1**   Метод "копирование при записи" для создания теневых копий

Метод "копирование при записи" является быстрым способом создания теневой копии, поскольку копирует только измененные данные. Скопированные блоки в области копирования можно объединить с измененными данными в исходном томе, чтобы восстановить его состояние до внесения каких-либо изменений. Метод "копирование при записи" может стать дорогостоящим при наличии большого количества изменений.

### <a name="redirect-on-write-method"></a>Метод "перенаправление при записи"

В методе "перенаправление при записи", каждое полученное изменение исходного тома (запрос на запись операций ввода-вывода) не применяется к исходному тому. Вместо этого изменение записывается в область хранения теневых копий другого тома.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Время</th>
<th>Исходные данные (состояние и данные)</th>
<th>Теневое копирование (состояние и данные)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>T0</p></td>
<td><p>Исходные данные: 1 2 3 4 5</p></td>
<td><p>Без копирования: —</p></td>
</tr>
<tr class="even">
<td><p>T1</p></td>
<td><p>Данные, измененные в кэше: 3 — 3'</p></td>
<td><p>Создана теневая копия (только различия): 3'</p></td>
</tr>
<tr class="odd">
<td><p>T2</p></td>
<td><p>Исходные данные не изменены: 1 2 3 4 5</p></td>
<td><p>Отличия и индекс, хранящиеся в теневой копии: 3'</p></td>
</tr>
</tbody>
</table>

**Таблица 2**   Метод "перенаправление при записи" для создания теневых копий

Метод "перенаправление при записи" также является быстрым способом создания теневой копии, поскольку, он, как и метод "копирование при записи", копирует только изменения данных. Скопированные блоки в области копирования можно объединить с неизмененными данными в исходном томе, чтобы создать полную и актуальную копию данных. Метод перенаправления при записи может оказаться дорогостоящим при наличии большого количества запросов на чтение операций ввода-вывода.

## <a name="shadow-copy-providers"></a>Поставщики теневого копирования

Существует два типа поставщиков теневого копирования: поставщики оборудования и поставщики программного обеспечения. Также существует системный поставщик, который является поставщиком программного обеспечения, встроенного в операционную систему Windows.

### <a name="hardware-based-providers"></a>Поставщики оборудования

Поставщики оборудования теневого копирования действуют в качестве интерфейса между службой теневого копирования томов и уровнем оборудования, работая в сочетании с адаптером или контроллером оборудования для хранения данных. Работу по созданию и поддержке теневой копии выполняет массив хранения.

Служба теневого копирования томов предоставляет запрошенную теневую копию тома или томов, тогда как поставщики оборудования всегда оставляют теневую копию всего LUN.

Поставщик оборудования теневого копирования использует функции службы теневого копирования томов, которые определяют момент времени, позволяют синхронизировать данные, управляют теневой копией и предоставляют единый интерфейс с приложениями резервного копирования. Однако, в службе теневого копирования томов не определен базовый механизм, с помощью которого поставщик оборудования создает и поддерживает теневые копии.

### <a name="software-based-providers"></a>Поставщики программного обеспечения

Поставщики программного обеспечения теневого копирования обычно перехватывают и обрабатывают запросы на чтение и запись операций ввода и вывода на программном уровне между файловой системой и программным обеспечением диспетчера томов.

Эти поставщики реализованы в виде компонента DLL в пользовательском режиме и, по крайней мере, одного драйвера устройства в режиме ядра, обычно драйвера-фильтра хранилища. В отличие от поставщиков оборудования, поставщики программного обеспечения создают теневые копии на уровне программного обеспечения, а не на уровне оборудования.

Поставщик программного обеспечения теневого копирования должен поддерживать представление тома "на момент времени", имея доступ к набору данных, который можно использовать для воссоздания состояния тома до момента создания теневой копии. Примером является метод "копирование при записи" системного поставщика. Однако служба теневого копирования томов не накладывает никаких ограничений на методы, используемые поставщиками программного обеспечения для создания и обслуживания теневых копий.

Поставщик программного обеспечения применим к более широкому спектру хранилищ, чем поставщик оборудования. Кроме того, он должен одинаково хорошо работать с базовыми дисками или логическими томами. (Логический том — это том, который создается путем объединения свободного места на двух или более дисках.) В отличие от теневых копий оборудования, поставщики программного обеспечения используют ресурсы операционной системы для обслуживания теневой копии.

Дополнительные сведения о базовых дисках см. в статье [What Are Basic Disks and Volumes?](https://go.microsoft.com/fwlink/?linkid=180894) (Что такое базовые диски и тома?) (https://go.microsoft.com/fwlink/?LinkId=180894) в TechNet.

### <a name="system-provider"></a>Системный поставщик

В операционной системе Windows есть один поставщик теневых копий — системный поставщик. Хотя с Windows предоставляется поставщик по умолчанию, другие поставщики могут свободно предоставлять реализации, оптимизированные для их приложений хранения оборудования и программного обеспечения.

Чтобы поддерживать представление тома "на момент времени", содержащееся в теневой копии, системный поставщик использует метод "копирование при записи". Копии блоков на томе, измененные с начала создания теневой копии, хранятся в области хранения теневой копии.

Системный поставщик может предоставлять производственный том, который можно записать и прочитать обычным образом. Если требуется теневая копия, он логически применяет различия к данным в производственном томе для предоставления полной теневой копии.

Для системного поставщика область хранения теневой копии должна находиться в томе NTFS. Том для теневого копирования не обязательно должен быть томом NTFS, однако среди подключенных к системе томов должен быть по крайней мере один том NTFS.

Файлы компонентов, из которых состоит системный поставщик — swprv.dll и volsnap.sys.

### <a name="in-box-vss-writers"></a>Встроенные модули записи VSS

Операционная система Windows включает набор модулей записи VSS, которые отвечают за перечисление данных, необходимых для различных функций Windows.

См. сведения об этих модулях записи на следующей странице веб-документации Майкрософт:

- [In-Box VSS Writers](https://docs.microsoft.com/windows/win32/vss/in-box-vss-writers)(https://docs.microsoft.com/windows/win32/vss/in-box-vss-writers) (Встроенные модули записи VSS)


## <a name="how-shadow-copies-are-used"></a>Использование теневых копий

Кроме резервного копирования данных приложения и сведений о состоянии системы, теневые копии можно использовать в ряде целей, включая следующие.

  - Восстановление LUN (повторная синхронизация LUN и замена LUN)

  - Восстановление отдельных файлов (теневые копии общих папок)

  - Интеллектуальный анализ данных с помощью переносных теневых копий


### <a name="restoring-luns-lun-resynchronization-and-lun-swapping"></a>Восстановление LUN (повторная синхронизация LUN и замена LUN)

В Windows Server 2008 R2 и Windows 7 инициаторы запросов VSS могут использовать функцию поставщика оборудования теневого копирования, называемую повторной синхронизацией LUN (или "синхронизация LUN"). Это схема быстрого восстановления, которая позволяет администратору приложения восстанавливать данные из теневой копии в исходный ​​или новый LUN.

Теневая копия может быть полным клоном теневой копии или разностной теневой копией. В любом случае, в конце операции повторной синхронизации, целевой LUN будет иметь то же содержимое, что и LUN теневого копирования. Во время операции повторной синхронизации массив выполняет копирование на уровне блока из теневой копии в целевой LUN.


> [!NOTE]
> Теневая копия должна быть переносной теневой копией оборудования.
<br>


Большинство массивов позволяют возобновлять рабочие операции ввода-вывода вскоре после начала операции повторной синхронизации. Пока выполняется операция повторной синхронизации, запросы на чтение перенаправляются в теневую копию LUN, а запросы на запись в целевой LUN. Это позволяет массивам восстанавливать очень большие наборы данных и возобновлять нормальные операции за несколько секунд.

Повторная синхронизация LUN отличается от замены LUN. Замена LUN — это сценарий быстрого восстановления, поддерживаемый VSS начиная с Windows Server 2003 с пакетом обновления 1 (SP1). При замене LUN теневая копия импортируется, а затем преобразуется в том для чтения и записи. Преобразование является необратимой операцией, после которой управление томом и базовым LUN с помощью API-интерфейсов VSS станет невозможным. В следующем списке описано сравнение повторной синхронизации LUN с заменой LUN.

  - При повторной синхронизации LUN теневая копия не изменяется, поэтому ее можно использовать несколько раз. При замене LUN ​​теневую копию для восстановления можно использовать только один раз. Это важно для большинства администраторов, соблюдающих правила безопасности. При использовании повторной синхронизации LUN, инициатор запроса может повторить всю операцию восстановления, если в первый раз что-то пойдет не так.

  - В конце замены LUN используется теневая копия LUN для производственных запросов ввода-вывода. По этой причине теневая копия LUN должна использовать хранилище того же качества, что и исходная производственная копия LUN, чтобы гарантировать, что производительность не пострадает после операции восстановления. Поставщик оборудования может поддерживать теневую копию в хранилище, которое стоит дешевле, чем хранилище производственного качества, если вместо этого используется повторная синхронизация LUN.

  - Если целевой LUN непригоден для использования и его необходимо создать повторно, замена LUN может быть более экономичной, поскольку не требует целевого LUN.


> [!WARNING]
> Все перечисленные операции являются операциями на уровне LUN. Если вы попытаетесь восстановить определенный том с помощью повторной синхронизации LUN, вы невольно вернете все остальные тома, которые совместно используют LUN.
<br>


### <a name="restoring-individual-files-shadow-copies-for-shared-folders"></a>Восстановление отдельных файлов (теневые копии общих папок)

Служба теневого копирования томов использует теневые копии общих папок для предоставления копий файлов в режиме "на момент времени", расположенных в общей сетевой папке, например на файловом сервере. С помощью теневых копий общих папок пользователи смогут быстро восстанавливать удаленные или измененные файлы, хранящиеся в сети. Теневые копии для общих папок могут повысить производительность и снизить административные расходы, поскольку они могут сделать это без помощи администратора.

Дополнительные сведения о теневых копиях общих папок см. в статье [Shadow Copies of Shared Folders](https://go.microsoft.com/fwlink/?linkid=180898) (https://go.microsoft.com/fwlink/?LinkId=180898) (Теневые копии общих папок) на TechNet.

### <a name="data-mining-by-using-transportable-shadow-copies"></a>Интеллектуальный анализ данных с помощью переносных теневых копий

С помощью поставщика оборудования, предназначенного для использования со службой теневого копирования томов, можно создавать переносимые теневые копии, которые затем можно импортировать на серверы в той же подсистеме (например, SAN). Эти теневые копии можно использовать, чтобы заполнить рабочую или тестовую установку данными только для чтения, для интеллектуального анализа данных.

С помощью службы теневого копирования томов и массива хранения данных, а также поставщика оборудования, предназначенного для службы теневого копирования томов, можно создать теневую копию исходного тома данных на одном сервере, а затем импортировать эту теневую копию на другой сервер (или обратно на тот же сервер). Этот процесс выполняется за несколько минут, независимо от размера данных. Процесс переноса выполняется с помощью ряда действий, использующих инициатор запроса теневого копирования (приложение управления хранением), поддерживающий переносимые теневые копии.

## <a name="to-transport-a-shadow-copy"></a>Действия для переноса теневой копии

1.  Создайте переносимую теневую копию исходных данных на сервере.

2.  Импортируйте теневую копию на сервер, подключенный к сети SAN (можно импортировать на другой или тот же сервер).

3.  Теперь данные готовы к использованию.

![](media/volume-shadow-copy-service/Ee923636.633752e0-92f6-49a7-9348-f451b1dc0ed7(WS.10).jpg)

**Рис. 3**   Создание и перенос теневой копии между двумя серверами


> [!NOTE]
> Импортировать переносную теневую копию, созданную в Windows Server 2003, на сервер с Windows Server 2008 или Windows Server 2008 R2 невозможно. Переносную теневую копию, созданную в Windows Server 2008 или Windows Server 2008 R2, нельзя импортировать на сервер с Windows Server 2003. Однако переносную теневую копию, созданную в Windows Server 2008 можно импортировать на сервер с Windows Server 2008 R2 и наоборот.
<br>


Теневые копии доступны только для чтения. Если вы хотите преобразовать теневую копию в LUN для чтения и записи, кроме службы теневого копирования томов можно использовать приложение для управления хранилищем на основе службы виртуальных дисков (включая некоторые инициаторы запроса). С помощью этого приложения можно удалить теневую копию из управления службы теневого копирования томов и преобразовать ее в LUN для чтения и записи.

Перенос службы теневого копирования томов — это дополнительное решение на компьютерах под управлением Windows Server 2003 Enterprise Edition, Windows Server 2003 Datacenter Edition, Windows Server 2008 или Windows Server 2008 R2. Оно работает только при наличии в массиве хранения данных поставщика оборудования. Перенос теневой копии может использоваться для разных целей, включая резервное копирование на магнитную ленту, интеллектуальный анализ данных и тестирование.

## <a name="frequently-asked-questions"></a>Вопросы и ответы

Ответы на часто задаваемые вопросы о службе теневого копирования томов (VSS) для системных администраторов. Дополнительные сведения о интерфейсах программирования приложений VSS см. в статье [Volume Shadow Copy Service](https://go.microsoft.com/fwlink/?linkid=180899) (https://go.microsoft.com/fwlink/?LinkId=180899) (Служба теневого копирования томов) в библиотеке центра разработчиков Windows.

### <a name="when-was-volume-shadow-copy-service-introduced-on-which-windows-operating-system-versions-is-it-available"></a>Когда было выпущено службу теневого копирования томов (VSS)? На каких версиях операционной системы Windows она доступна?

VSS впервые появилась в Windows XP. Поддерживается в Windows XP, Windows Server 2003, Windows Vista®, Windows Server 2008, Windows 7, и Windows Server 2008 R2.

### <a name="what-is-the-difference-between-a-shadow-copy-and-a-backup"></a>Чем отличаются теневая копия и резервное копирование?

При резервном копировании жесткого диска созданная теневая копия также является резервной копией. Из теневой копии можно скопировать данные для восстановления, кроме того теневую копию можно использовать для сценария быстрого восстановления, например, ресинхронизация LUN или замена LUN.

При копировании данных из теневой копии на ленту или другой съемный носитель хранящееся на носителе содержимое образует резервную копию. Саму теневую копию можно удалить после копирования данных из нее.

### <a name="what-is-the-largest-size-volume-that-volume-shadow-copy-service-supports"></a>Каков самый больший объем, поддерживаемый службой теневого копирования томов?

Служба теневого копирования томов поддерживает тома размером до 64 ТБ.

### <a name="i-made-a-backup-on-windows-server2008-can-i-restore-it-on-windows-server2008r2"></a>Я сделал резервную копию на Windows Server 2008. Можно ли восстановить ее в Windows Server 2008 R2?

Это зависит от используемого программного обеспечения резервного копирования. Большинство программ резервного копирования поддерживают этот сценарий для резервных копий данных, но не для резервного копирования состояния системы.

Теневые копии, созданные в любой из этих версий Windows, можно использовать на другой.

### <a name="i-made-a-backup-on-windows-server2003-can-i-restore-it-on-windows-server2008"></a>Я сделал резервную копию на Windows Server 2003. Можно ли восстановить ее в Windows Server 2008?

Это зависит от используемого программного обеспечения резервного копирования. При создании теневой копии на Windows Server 2003 ее использование в Windows Server 2008 будет невозможным. Кроме того, при создании теневой копии на Windows Server 2008 ее восстановление в Windows Server 2003 будет невозможным.

### <a name="how-can-i-disable-vss"></a>Как отключить VSS?

Службу теневого копирования томов можно отключить с помощью консоли управления (MMC). Однако это не рекомендуется. Отключение VSS негативно влияет на любое программное обеспечение, которое использует эту службу, например Восстановление системы и система архивации данных Windows Server.

Дополнительные сведения см. на следующем веб-сайте TechNet корпорации Майкрософт:

- [Восстановление системы](https://go.microsoft.com/fwlink/?linkid=157113) (https://go.microsoft.com/fwlink/?LinkID=157113)

- [Система архивации данных Windows Server](https://go.microsoft.com/fwlink/?linkid=180891) (https://go.microsoft.com/fwlink/?LinkID=180891)


### <a name="can-i-exclude-files-from-a-shadow-copy-to-save-space"></a>Можно ли исключить файлы из теневой копии, чтобы сэкономить место?

Служба VSS предназначена для создания теневых копий целых томов. Временные файлы, например файлы подкачки, автоматически удаляются из теневых копий для экономии пространства.

Чтобы исключить определенные файлы из теневых копий, используйте следующий раздел реестра: **FilesNotToSnapshot**.


> [!NOTE]
> Раздел реестра <STRONG>FilesNotToSnapshot</STRONG> предназначен для использования только приложениями. Пользователи, пытающиеся использовать этот раздел, сталкиваются с приведенными ниже ограничениями.
> <br>
> <UL>
> <LI>Он не может удалять файлы из теневой копии, созданной на Windows Server, с помощью функции "Предыдущие версии".<BR><BR>
> <LI>Он не может удалить файлы из теневых копий общих папок.<BR><BR>
> <LI>Он может удалять файлы из теневой копии, созданной с помощью служебной программы <a href="https://docs.microsoft.com/windows-server/administration/windows-commands/diskshadow" data-raw-source="[Diskshadow](https://docs.microsoft.com/windows-server/administration/windows-commands/diskshadow)">Diskshadow</a>, но удаление файлов с помощью служебной программы <a href="https://docs.microsoft.com/windows-server/administration/windows-commands/vssadmin" data-raw-source="[Vssadmin](https://docs.microsoft.com/windows-server/administration/windows-commands/vssadmin)">vssadmin</a> будет невозможным.<BR><BR>
> <LI>Файлы удаляются из теневой копии при наличии соответствующих ресурсов и возможностей. Это означает, что их удаление не гарантируется.<BR><BR></LI></UL>


Дополнительные сведения см. в разделе [Excluding Files from Shadow Copies](https://go.microsoft.com/fwlink/?linkid=180904) (https://go.microsoft.com/fwlink/?LinkId=180904) (Исключение файлов из теневых копий) на сайте MSDN.

### <a name="my-non-microsoft-backup-program-failed-with-a-vss-error-what-can-i-do"></a>Моя программа резервного копирования, не относящаяся к Майкрософт, завершилась с ошибкой VSS. Что я могу сделать?

Просмотрите раздел "Поддержка продуктов" на веб-сайте компании, которая создала программу резервного копирования. Возможно, для исправления проблемы можно загрузить и установить обновление продукта. Если нет, обратитесь в службу техподдержки компании.

Системные администраторы могут использовать сведения об устранении неполадок VSS на следующем веб-сайте библиотеки TechNet от Майкрософт для сбора диагностических сведений о проблемах, связанных с VSS.

Дополнительные сведения см. в статье [Volume Shadow Copy Service](https://go.microsoft.com/fwlink/?linkid=180905) (Служба теневого копирования томов) (https://go.microsoft.com/fwlink/?LinkId=180905) на TechNet.

### <a name="what-is-the-diff-area"></a>Что такое "область копирования"?

Область хранения теневых копий (или "область копирования") — это расположение, в котором хранятся данные для теневой копии, создаваемой поставщиком программного обеспечения системы.

### <a name="where-is-the-diff-area-located"></a>Где расположена область копирования?

Область копирования может располагаться на любом локальном томе. Однако он должен располагаться на томе NTFS, который имеет достаточно места для хранения.

### <a name="how-is-the-diff-area-location-determined"></a>Как определяется расположение области копирования?

Для определения местоположения области копирования в этом порядке оцениваются приведенные ниже критерии.

  - Если у тома уже есть теневая копия, используется ее расположение.

  - Если существует предварительно настроенное вручную сопоставление между исходным томом и расположением тома теневой копии, то используется это расположение.

  - Если предыдущие два критерия не предоставляют расположение, служба теневого копирования выбирает расположение на основе доступного свободного пространства. Если выполняется теневое копирование нескольких томов, служба теневого копирования создает список возможных расположений моментальных снимков в зависимости от размера свободного пространства в порядке убывания. Количество указанных расположений равно числу томов, для которых выполняется теневое копирование.

  - Если копируемый том является одним из возможных расположений, то создается локальная ассоциация. В противном случае создается связь с томом с наибольшим доступным пространством.


### <a name="can-vss-create-shadow-copies-of-non-ntfs-volumes"></a>Может ли VSS создавать теневые копии томов, отличных от NTFS?

Да. Однако постоянные теневые копии можно создавать только для томов NTFS. Кроме того, среди всех подключенных к системе томов, по крайней мере один должен быть томом NTFS.

### <a name="whats-the-maximum-number-of-shadow-copies-i-can-create-at-one-time"></a>Каково максимальное количество теневых копий можно создать одновременно?

Максимальное число теневых копий томов в одном наборе теневых копий — 64. Обратите внимание, что это не то же самое, что количество теневых копий.

### <a name="whats-the-maximum-number-of-software-shadow-copies-created-by-the-system-provider-that-i-can-maintain-for-a-volume"></a>Какое максимальное количество теневых копий программного обеспечения, созданных поставщиком системы, я могу поддерживать для тома?

Максимальное число теневых копий программного обеспечения для каждого тома — 512. Однако по умолчанию вы можете поддерживать 64 теневых копий, используемых теневыми копиями компонента "Общие папки". Чтобы изменить ограничение для теневых копий компонента "Общие папки", используйте следующий раздел реестра: **MaxShadowCopies**.

### <a name="how-can-i-control-the-space-that-is-used-for-shadow-copy-storage-space"></a>Как управлять пространством, используемым для хранения теневых копий?

Введите команду **vssadmin resize shadowstorage**.

Дополнительные сведения см. в статье [Vssadmin resize shadowstorage](https://go.microsoft.com/fwlink/?linkid=180906) (https://go.microsoft.com/fwlink/?LinkId=180906) на сайте TechNet.

### <a name="what-happens-when-i-run-out-of-space"></a>Что происходит, когда заканчивается свободное пространство?

Теневые копии тома удаляются, начиная с самой старой теневой копии.

## <a name="volume-shadow-copy-service-tools"></a>Средства службы теневого копирования томов

Операционная система Windows предоставляет следующие средства для работы с VSS:

  - [DiskShadow](https://go.microsoft.com/fwlink/?linkid=180907) (https://go.microsoft.com/fwlink/?LinkId=180907)

  - [VssAdmin](https://go.microsoft.com/fwlink/?linkid=84008) (https://go.microsoft.com/fwlink/?LinkId=84008)


### <a name="diskshadow"></a>DiskShadow

DiskShadow — это инициатор запроса VSS, который можно использовать для управления всеми моментальными снимками оборудования и программного обеспечения, которые могут быть установлены в системе. DiskShadow включает приведенные ниже команды.

  - **list**: перечисление модулей записи VSS, поставщиков VSS и теневых копий.

  - **create**: создание новой теневой копии.

  - **import**: импорт переносной теневой копии.

  - **expose**: предоставление постоянной теневой копии (например, букву диска).

  - **revert**: возврат тома к указанной теневой копии.


Этот инструмент предназначен для использования ИТ-специалистами, но он также может быть полезным разработчикам при тестировании модуля записи VSS или поставщика VSS.

DiskShadow доступен только в операционных системах Windows Server. Он недоступен в клиентских операционных системах Windows.

### <a name="vssadmin"></a>VssAdmin

VssAdmin используется для создания, удаления и вывода списка сведений о теневых копиях. Его также можно использовать для изменения размера области хранения теневых копий (область копирования).

VssAdmin включает приведенные ниже команды.

  - **create shadow**: создание новой теневой копии.

  - **delete shadows**: удаление теневых копий.

  - **list providers**: список всех зарегистрированных поставщиков VSS.

  - **list writers**: список всех модулей записи VSS с подпиской.

  - **resize shadowstorage**: изменение максимального размера области хранения теневых копий.


VssAdmin можно использовать только для управления теневыми копиями, созданными поставщиком системного программного обеспечения.

VssAdmin доступен в версиях операционной системы клиента Windows и Windows Server.

## <a name="volume-shadow-copy-service-registry-keys"></a>Разделы реестра службы теневого копирования томов

Для использования с VSS доступны следующие разделы реестра.

  - **VssAccessControl**

  - **MaxShadowCopies**

  - **MinDiffAreaFileSize**


### <a name="vssaccesscontrol"></a>VssAccessControl

Этот раздел используется для указания пользователей, имеющих доступ к теневым копиям.

Дополнительные сведения см. в следующих ресурсах на веб-сайте MSDN.

  - [Security Considerations for Writers](https://go.microsoft.com/fwlink/?linkid=157739) (https://go.microsoft.com/fwlink/?LinkId=157739) (Аспекты обеспечения безопасности для модулей записи)

  - [Security Considerations for Requesters](https://go.microsoft.com/fwlink/?linkid=180908) (https://go.microsoft.com/fwlink/?LinkId=180908) (Аспекты обеспечения безопасности для инициаторов запросов)


### <a name="maxshadowcopies"></a>MaxShadowCopies

Этот раздел указывает максимальное количество доступных для клиента теневых копий, которые могут храниться на каждом томе компьютера. Доступные для клиента теневые копии, которые используются теневыми копиями для общих папок.

Дополнительные сведения см. в следующем ресурсе на веб-сайте MSDN.

Раздел **MaxShadowCopies** в статье [Registry Keys and Values for Backup and Restore](https://go.microsoft.com/fwlink/?linkid=180909) (https://go.microsoft.com/fwlink/?LinkId=180909) (Разделы реестра и значения для резервного копирования и восстановления)

### <a name="mindiffareafilesize"></a>MinDiffAreaFileSize

Этот раздел задает минимальный исходный размер области хранения теневых копий (в МБ).

Дополнительные сведения см. в следующем ресурсе на веб-сайте MSDN.

Раздел **MinDiffAreaFileSize** в статье [Registry Keys and Values for Backup and Restore ](https://go.microsoft.com/fwlink/?linkid=180910)(https://go.microsoft.com/fwlink/?LinkId=180910) (Разделы реестра и значения для резервного копирования и восстановления)

### <a name="supported-operating-system-versions"></a>Поддерживаемые версии операционной системы

В следующей таблице перечислены минимальные версии операционных систем, поддерживаемые компонентами VSS.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Компонент VSS</th>
<th>Минимальная версия клиента</th>
<th>Минимальная версия сервера</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Повторная синхронизация LUN</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2008 R2</p></td>
</tr>
<tr class="even">
<td><p>Раздел реестра <strong>FilesNotToSnapshot</strong></p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="odd">
<td><p>Переносные теневые копии</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2003 с пакетом обновления 1 (SP1);</p></td>
</tr>
<tr class="even">
<td><p>Теневые копии оборудования</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2003.</p></td>
</tr>
<tr class="odd">
<td><p>Предыдущие версии Windows Server</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2003.</p></td>
</tr>
<tr class="even">
<td><p>Быстрое восстановление с помощью замены LUN</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2003 с пакетом обновления 1 (SP1);</p></td>
</tr>
<tr class="odd">
<td><p>Многократный импорт теневых копий оборудования</p>
<div class="alert">
<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="header">
<th><img src="media/volume-shadow-copy-service/Dd560667.note(WS.10).gif" />Примечание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Это возможность импортировать теневую копию несколько раз. Одновременно можно выполнять только одну операцию импорта.
<p></p></td>
</tr>
</tbody>
</table>
<p></p>
</div></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="even">
<td><p>Теневые копии для общих папок</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2003.</p></td>
</tr>
<tr class="odd">
<td><p>Переносимые автоматически восстанавливаемые теневые копии</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="even">
<td><p>Одновременные сеансы резервного копирования (до 64)</p></td>
<td><p>Windows XP;</p></td>
<td><p>Windows Server 2003.</p></td>
</tr>
<tr class="odd">
<td><p>Однократный сеанс восстановления одновременно с резервным копированием</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2003 SP2 с пакетом обновления 2 (SP2)</p></td>
</tr>
<tr class="even">
<td><p>До 8 сеансов восстановления одновременно с резервным копированием</p></td>
<td><p>Windows 7</p></td>
<td><p>Windows Server 2003 R2</p></td>
</tr>
</tbody>
</table>

## <a name="see-also"></a>См. также статью

[Volume Shadow Copy Service Overview](https://docs.microsoft.com/windows/desktop/vss/volume-shadow-copy-service-overview) (Обзор службы теневого копирования томов)
