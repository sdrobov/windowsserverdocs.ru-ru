---
title: Перевод сервера локальных дисковых пространств в автономный режим для обслуживания
ms.prod: windows-server-threshold
ms.author: eldenc
ms.manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: eldenchristensen
ms.date: 10/08/2018
Keywords: Локальные дисковые пространства, S2D, обслуживание
ms.assetid: 73dd8f9c-dcdb-4b25-8540-1d8707e9a148
ms.localizationpriority: medium
ms.openlocfilehash: 96ae0ad0d1def12ab68466f0a9ae60d0afcc2c17
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59871225"
---
# <a name="taking-a-storage-spaces-direct-server-offline-for-maintenance"></a>Перевод сервера локальных дисковых пространств в автономный режим для обслуживания

> Относится к: Windows Server 2019, Windows Server 2016

В этом разделе приведены рекомендации для корректного перезапуска или завершения работы серверов с [локальными дисковыми пространствами](storage-spaces-direct-overview.md).

При использовании локальных дисковых пространств перевод сервера в автономный режим также означает отключение от сети частей хранилища, которые совместно используются на всех серверах в кластере. Для этого необходимо приостановить соответствующий сервер, перенести роли на другие серверы кластера и убедиться, что все данные доступны на других серверах в кластере, чтобы обеспечить их безопасность и доступность на период обслуживания.

Используйте следующие процедуры для корректной приостановки сервера в кластере локальных дисковых пространств перед его переводом в автономный режим. 

   > [!IMPORTANT]
   > Для установки обновлений в кластере локальных дисковых пространств используйте кластерное обновление (CAU), которое автоматически выполняет процедуры, описанные в этом разделе. Дополнительные сведения см. в статье [Кластерное обновление (CAU)](https://technet.microsoft.com/library/hh831694.aspx).

## <a name="verifying-its-safe-to-take-the-server-offline"></a>Проверка безопасности перевода сервера в автономный режим

Перед переводом сервера в автономный режим для обслуживания убедитесь, что все тома работоспособны.

Для этого откройте сеанс PowerShell с разрешениями администратора и выполните следующую команду для просмотра состояния тома:

```PowerShell
Get-VirtualDisk 
```

Вот пример того, как могут выглядеть выходные данные команды:
```
FriendlyName ResiliencySettingName OperationalStatus HealthStatus IsManualAttach Size
------------ --------------------- ----------------- ------------ -------------- ----
MyVolume1    Mirror                OK                Healthy      True           1 TB
MyVolume2    Mirror                OK                Healthy      True           1 TB
MyVolume3    Mirror                OK                Healthy      True           1 TB
```

Убедитесь, что в свойстве **HealthStatus** каждого тома (виртуального диска) задано значение **Healthy**.

Для этого в диспетчере отказоустойчивости кластеров выберите **Хранилище** > **Диски**.

Убедитесь, что в столбце **Состояние** каждого тома (виртуального диска) указано значение **В сети**.

## <a name="pausing-and-draining-the-server"></a>Приостановка и очистка сервера

Перед перезапуском или завершением работы сервера приостановите и очистите (перенесите) все роли, например виртуальные машины, запущенные на нем. Это позволяет локальным дисковым пространствам корректно очистить и сохранить данные, чтобы обеспечить прозрачное завершение работы для всех приложений, работающих на этом сервере.

   > [!IMPORTANT]
   > Всегда приостанавливайте и очищайте серверы кластера до перезагрузки или завершения их работы.

В PowerShell выполните следующий командлет (от имени администратора) для приостановки и очистки сервера.

```PowerShell
Suspend-ClusterNode -Drain
```

Для этого в диспетчере отказоустойчивости кластера перейдите в раздел **Узлы**, щелкните узел правой кнопкой мыши и выберите **Приостановить** > **Очистить роли**.

![Pause-Drain](media/maintain-servers/pause-drain.png)

Все виртуальные машины начнут динамическую миграцию на другие серверы в кластере. Это может занять несколько минут.

   > [!NOTE]
   > При корректной приостановке и очистке узла кластера Windows выполняет автоматическую проверку безопасности продолжения процесса. Если существуют неработоспособные тома, процесс будет остановлен, а вы увидите предупреждение о том, что продолжать не безопасно.

![Safety-Check](media/maintain-servers/safety-check.png)

## <a name="shutting-down-the-server"></a>Завершение работы сервера

После завершения очистки сервера в диспетчере отказоустойчивого кластера и PowerShell он будет показан с состоянием **Приостановлено**.

![Приостановлена](media/maintain-servers/paused.png)

Теперь вы можете безопасно перезапустить или завершить работу сервера обычным способом (например, с помощью командлетов PowerShell Stop-Computer или Restart-Computer).

```PowerShell
Get-VirtualDisk 

FriendlyName ResiliencySettingName OperationalStatus HealthStatus IsManualAttach Size
------------ --------------------- ----------------- ------------ -------------- ----
MyVolume1    Mirror                Incomplete        Warning      True           1 TB
MyVolume2    Mirror                Incomplete        Warning      True           1 TB
MyVolume3    Mirror                Incomplete        Warning      True           1 TB
```

Не завершено или сниженной активности оперативное состояние является нормальным, когда узлы выполняется завершение работы или запуск и остановку кластера службы на узле и причины для беспокойства нет. Все другие тома остаются доступными и подключенными к сети.

## <a name="resuming-the-server"></a>Возобновление работы сервера

Когда вы будете готовы к тому, чтобы начать использовать сервер для размещения рабочих нагрузок, возобновите его работу.

В PowerShell выполните следующий командлет (от имени администратора), чтобы возобновить работу сервера.

```PowerShell
Resume-ClusterNode
```

Чтобы вернуть ранее запущенные роли на сервер, используйте дополнительный флаг **-Failback**.

```PowerShell
Resume-ClusterNode –Failback Immediate
```

Для этого в диспетчере отказоустойчивости кластера перейдите в раздел **Узлы**, щелкните узел правой кнопкой мыши и выберите **Возобновить** > **Восстановить размещение ролей**.

![Resume-Failback](media/maintain-servers/resume-failback.png)

## <a name="waiting-for-storage-to-resync"></a>Ожидание синхронизации хранилища

При возобновлении работы сервера, все новые записи, которые произошли, когда он был недоступен требуется повторная синхронизация. Это происходит автоматически. Благодаря интеллектуальному отслеживанию изменений не требуется сканировать или синхронизировать *все* данные, это необходимо сделать только для изменений. Этот процесс регулируется для снижения влияния на рабочие нагрузки. В зависимости от того, как долго сервер был приостановлен и сколько новых данных было записано, процесс может занять несколько минут.

Вам следует дождаться завершения повторной синхронизации перед переводом других серверов кластера в автономный режим.

В PowerShell выполните следующий командлет (от имени администратора) для отслеживания хода выполнения.

```PowerShell
Get-StorageJob
```
Вот пример выходных данных с отображением заданий синхронизации (восстановления):
```
Name   IsBackgroundTask ElapsedTime JobState  PercentComplete BytesProcessed BytesTotal
----   ---------------- ----------- --------  --------------- -------------- ----------
Repair True             00:06:23    Running   65              11477975040    17448304640
Repair True             00:06:40    Running   66              15987900416    23890755584
Repair True             00:06:52    Running   68              20104802841    22104819713
```

Значение **BytesTotal** показывает, сколько данных требуется синхронизировать повторно. **PercentComplete** — ход выполнения операции.

   > [!WARNING]
   > Небезопасно отключать другой сервер до завершения заданий восстановления.

В это время для томов будет отображаться состояние **Предупреждение** — это нормально. 

Например, если вы используете командлет `Get-VirtualDisk`, можно увидеть следующее:
```
FriendlyName ResiliencySettingName OperationalStatus HealthStatus IsManualAttach Size
------------ --------------------- ----------------- ------------ -------------- ----
MyVolume1    Mirror                InService         Warning      True           1 TB
MyVolume2    Mirror                InService         Warning      True           1 TB
MyVolume3    Mirror                InService         Warning      True           1 TB
```

После завершения заданий убедитесь, что для томов отображается состояние **Исправен**, используя командлет `Get-VirtualDisk`. Вот пример выходных данных:

```
FriendlyName ResiliencySettingName OperationalStatus HealthStatus IsManualAttach Size
------------ --------------------- ----------------- ------------ -------------- ----
MyVolume1    Mirror                OK                Healthy      True           1 TB
MyVolume2    Mirror                OK                Healthy      True           1 TB
MyVolume3    Mirror                OK                Healthy      True           1 TB
```

Теперь можно безопасно приостановить и перезапустить другие серверы в кластере.

## <a name="how-to-update-storage-spaces-direct-nodes-offline"></a>Как обновить дисковых узлов в автономный режим
Используйте следующие шаги, чтобы путь дисковые системы быстро. Он включает в себя планирование периода обслуживания и перезагрузки системы для установки исправлений. Если критическое обновление безопасности, необходимо применить быстро или может быть необходимо убедиться, что установка исправлений завершения окна обслуживания, этот метод может быть для вас. Этот процесс приводит к завершению работы кластера дисковых, ее исправления и переводит ее до все еще раз. Недостаток — простои к размещенным ресурсам.

1. План на период обслуживания.
2. Отключите виртуальные диски.
3. Остановите кластера, чтобы перевести в пул носителей в автономный режим. Запустите **Stop-Cluster** командлета или воспользоваться диспетчером отказоустойчивости кластеров, чтобы остановить кластер.
4. Настройте для службы кластера **отключено** в Services.msc на каждом узле. Это предотвращает запуск при вносятся исправления служба кластеров.
5. Примените накопительное обновление Windows Server и любые нужные стека обновлений для обслуживания ко всем узлам. (Следует обновить все узлы в то же время, не нужно ждать, поскольку кластер не работает).  
6. Перезапустите узлы и убедитесь, что все в порядке.
7. Служба кластеров снова задайте **автоматического** на каждом узле.
8. Запустите кластер. Запустите **Start-Cluster** командлета или воспользоваться диспетчером отказоустойчивости кластеров. 

   Подождите несколько минут.  Убедитесь, что пул носителей находится в работоспособном состоянии.
9. Подключите виртуальные диски обратно в оперативный режим.
10. Отслеживать состояние виртуальных дисков, выполнив **Get-Volume** и **Get-VirtualDisk** командлетов.


## <a name="see-also"></a>См. также

- [Общие сведения о дисковых хранилища](storage-spaces-direct-overview.md)
- [Кластер кластерного обновления (CAU)](https://technet.microsoft.com/library/hh831694.aspx)
