---
title: Развертывание локальных дисковых пространств
ms.prod: windows-server
manager: eldenc
ms.author: stevenek
ms.technology: storage-spaces
ms.topic: get-started-article
ms.assetid: 20fee213-8ba5-4cd3-87a6-e77359e82bc0
author: stevenek
ms.date: 06/07/2019
description: Пошаговые инструкции по развертыванию программного хранилища с Локальные дисковые пространства в Windows Server в качестве инфраструктуры с технологией Hyper-in или конвергенции (также известной как агрегированная).
ms.localizationpriority: medium
ms.openlocfilehash: 60b29cbebb19cd8f1ce364d1eb7e920759375285
ms.sourcegitcommit: 06ae7c34c648538e15c4d9fe330668e7df32fbba
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2020
ms.locfileid: "78371776"
---
# <a name="deploy-storage-spaces-direct"></a>Развертывание локальных дисковых пространств

> Область применения: Windows Server 2019, Windows Server 2016

В этом разделе приводятся пошаговые инструкции по развертыванию [Локальные дисковые пространства](storage-spaces-direct-overview.md).

> [!Tip]
> Хотите приобрести инфраструктуру с технологией Hyper-in? Корпорация Майкрософт рекомендует приобрести проверенное оборудование и программное обеспечение от наших партнеров, включая средства и процедуры развертывания. Эти решения разработаны, собраны и проверены в соответствии с эталонной архитектурой для обеспечения совместимости и надежности, что позволяет быстро приступить к работе. Решения для Windows Server 2019 см. на [веб-сайте Azure Stack хЦи Solutions](https://azure.microsoft.com/overview/azure-stack/hci). Для решений Windows Server 2016 ознакомьтесь с дополнительными сведениями по [Windows Server Software-Defined](https://microsoft.com/wssd).

> [!Tip]
> Виртуальные машины Hyper-V, в том числе Microsoft Azure, можно использовать для [вычисления Локальные дисковые пространства без оборудования](storage-spaces-direct-in-vm.md). Вам также может потребоваться ознакомиться с удобными [сценариями развертывания Windows Server Rapid Lab](https://aka.ms/wslab), которые мы используем в целях обучения.

## <a name="before-you-start"></a>Прежде чем начать

Ознакомьтесь с [Локальные дисковые пространства требованиями к оборудованию](Storage-Spaces-Direct-Hardware-Requirements.md) и считывает этот документ, чтобы ознакомиться с общим подходом и важными примечаниями, связанными с некоторыми шагами.

Соберите следующие сведения:

- **Вариант развертывания.** Локальные дисковые пространства поддерживает [два варианта развертывания: с согласованием и](storage-spaces-direct-overview.md#deployment-options)с объединением, также известное как агрегированное. Ознакомьтесь с преимуществами каждого из них, чтобы решить, что вам подходит. Шаги 1-3 ниже применимы к обоим вариантам развертывания. Шаг 4 необходим только для согласованного развертывания.

- **Имена серверов.** Ознакомьтесь с политиками именования в Организации для компьютеров, файлов, путей и других ресурсов. Необходимо подготавливать несколько серверов, каждый из которых имеет уникальные имена.

- **Доменное имя.** Ознакомьтесь с политиками организации по именованию доменов и присоединению к домену.  Вы присоедините серверы к домену, и вам потребуется указать имя домена. 

- **Сеть RDMA.** Существует два типа протоколов RDMA: iWarp и Роце. Обратите внимание, какой из них использует сетевые адаптеры, и если Роце, также обратите внимание на версию (v1 или v2). Для Роце также обратите внимание на модель коммутатора верхнего уровня.

- **ИД ВИРТУАЛЬНОЙ ЛС.** Запишите идентификатор виртуальной ЛС, который будет использоваться для сетевых адаптеров ОС управления на серверах, если таковые имеются. Его можно получить у администратора сети.

## <a name="step-1-deploy-windows-server"></a>Шаг 1. Развертывание Windows Server

### <a name="step-11-install-the-operating-system"></a>Шаг 1,1. Установка операционной системы

Первым шагом является установка Windows Server на каждом сервере, который будет находиться в кластере. Для Локальные дисковые пространства требуется Windows Server 2016 Datacenter Edition. Можно использовать вариант установки Server Core или сервер с возможностями рабочего стола.

При установке Windows Server с помощью мастера установки можно выбрать вариант между *Windows Server* (ссылка на ядро сервера) и *Windows Server (сервер с возможностями рабочего стола)* , который является эквивалентом *полной* установки, доступной в Windows Server 2012 R2. Если вы не выбираете, вы получите вариант установки Server Core. Дополнительные сведения см. в разделе [Параметры установки для Windows Server 2016](../../get-started/Windows-Server-2016.md).

### <a name="step-12-connect-to-the-servers"></a>Шаг 1,2. подключение к серверам

В этом руководство основное внимание уделяется варианту установки Server Core и удаленному развертыванию и управлению из отдельной системы управления, которая должна иметь:

- Windows Server 2016 с теми же обновлениями, что и серверы, которыми он управляет;
- Сетевое подключение к управляемым им серверам
- Присоединение к тому же домену или полностью доверенному домену
- На нем должны быть установлены средства удаленного администрирования сервера (RSAT) и модули PowerShell для Hyper-V и отказоустойчивой кластеризации. Средства RSAT и модули PowerShell доступны в Windows Server и могут быть установлены без установки других компонентов. Вы также можете установить [средства удаленного администрирования сервера](https://www.microsoft.com/download/details.aspx?id=45520) на ПК управления Windows 10.

В системе управления установите отказоустойчивый кластер и средства управления Hyper-V. Это можно сделать в диспетчере сервера с помощью мастера **добавления ролей и компонентов**. На странице **Компоненты** щелкните **Средства удаленного администрирования сервера** и выберите средства, которые требуется установить.

Войдите в сеанс PowerShell и используйте имя сервера или IP-адрес узла, к которому хотите подключиться. После выполнения этой команды появится запрос на ввод пароля. Введите пароль администратора, указанный при настройке Windows.

   ```PowerShell
   Enter-PSSession -ComputerName <myComputerName> -Credential LocalHost\Administrator
   ```

   Ниже приведен пример того, как сделать то же самое, что более полезно в сценариях, если это необходимо сделать более одного раза:

   ```PowerShell
   $myServer1 = "myServer-1"
   $user = "$myServer1\Administrator"

   Enter-PSSession -ComputerName $myServer1 -Credential $user
   ```

> [!TIP]
> Если развертывание выполняется удаленно из системы управления, может возникнуть ошибка, например *WinRM не может обработать запрос.* Чтобы устранить эту проблему, добавьте каждый сервер в список надежных узлов на компьютере управления с помощью Windows PowerShell:  
>   
> `Set-Item WSMAN:\Localhost\Client\TrustedHosts -Value Server01 -Force`
>  
> Примечание. список надежных узлов поддерживает подстановочные знаки, например `Server*`.
>
> Чтобы просмотреть список надежных узлов, введите `Get-Item WSMAN:\Localhost\Client\TrustedHosts`.  
>   
> Чтобы очистить список, введите `Clear-Item WSMAN:\Localhost\Client\TrustedHost`.  

### <a name="step-13-join-the-domain-and-add-domain-accounts"></a>Шаг 1,3. присоединение к домену и добавление учетных записей домена

Пока вы настроили отдельные серверы с учетной записью локального администратора, `<ComputerName>\Administrator`.

Для управления Локальные дисковые пространства необходимо присоединить серверы к домену и использовать учетную запись домена домен Active Directory Services, которая входит в группу администраторов на каждом сервере.

В системе управления откройте консоль PowerShell с правами администратора. Используйте `Enter-PSSession` для подключения к каждому серверу и выполните следующий командлет, заменив свое имя компьютера, доменное имя и учетные данные домена:

```PowerShell  
Add-Computer -NewName "Server01" -DomainName "contoso.com" -Credential "CONTOSO\User" -Restart -Force  
```

Если ваша учетная запись администратора хранилища не является членом группы "Администраторы домена", добавьте учетную запись администратора хранилища в локальную группу администраторов на каждом узле или еще лучше, добавьте группу, используемую для администраторов хранилища. Для этого можно использовать следующую команду (или написать функцию Windows PowerShell. Дополнительные сведения см. в статье [Использование PowerShell для добавления пользователей домена в локальную группу](https://blogs.technet.com/b/heyscriptingguy/archive/2010/08/19/use-powershell-to-add-domain-users-to-a-local-group.aspx) ):

```
Net localgroup Administrators <Domain\Account> /add
```

### <a name="step-14-install-roles-and-features"></a>Шаг 1,4. Установка ролей и компонентов

Следующим шагом является установка ролей сервера на каждом сервере. Это можно сделать с помощью [центра администрирования Windows](../../manage/windows-admin-center/use/manage-servers.md), [Диспетчер сервера](../../administration/server-manager/install-or-uninstall-roles-role-services-or-features.md)) или PowerShell. Ниже перечислены устанавливаемые роли.

- Отказоустойчивая кластеризация
- Hyper-V
- Файловый сервер (если требуется разместить любые общие файловые ресурсы, например для согласованного развертывания);
- Мост для центра обработки данных (если вы используете RoCEv2 вместо сетевых адаптеров iWARP)
- PowerShell для кластеризации RSAT
- PowerShell для Hyper-V

Чтобы установить с помощью PowerShell, используйте командлет [Install-WindowsFeature](https://docs.microsoft.com/powershell/module/microsoft.windows.servermanager.migration/install-windowsfeature) . Его можно использовать на одном сервере следующим образом:

```PowerShell
Install-WindowsFeature -Name "Hyper-V", "Failover-Clustering", "Data-Center-Bridging", "RSAT-Clustering-PowerShell", "Hyper-V-PowerShell", "FS-FileServer"
```

Чтобы выполнить команду на всех серверах в кластере как одно и то же время, используйте небольшой сценарий, изменив список переменных в начале скрипта в соответствии с вашей средой.

```PowerShell
# Fill in these variables with your values
$ServerList = "Server01", "Server02", "Server03", "Server04"
$FeatureList = "Hyper-V", "Failover-Clustering", "Data-Center-Bridging", "RSAT-Clustering-PowerShell", "Hyper-V-PowerShell", "FS-FileServer"

# This part runs the Install-WindowsFeature cmdlet on all servers in $ServerList, passing the list of features into the scriptblock with the "Using" scope modifier so you don't have to hard-code them here.
Invoke-Command ($ServerList) {
    Install-WindowsFeature -Name $Using:Featurelist
}
```

## <a name="step-2-configure-the-network"></a>Шаг 2. Настройка сети

Если вы развертываете Локальные дисковые пространства в виртуальных машинах, пропустите этот раздел.

Для Локальные дисковые пространства требуется сеть с высокой пропускной способностью и низкой задержкой между серверами в кластере. Требуется по крайней мере 10 сетей GbE, и рекомендуется использовать удаленный доступ к памяти (RDMA). Вы можете использовать либо iWARP, либо Роце, если у него есть логотип Windows Server 2016, но iWARP, как правило, проще в настройке.

> [!Important]
> В зависимости от сетевого оборудования и, особенно с Роце версии 2, может потребоваться настройка коммутатора верхнего уровня. Правильная конфигурация коммутатора важна для обеспечения надежности и производительности Локальные дисковые пространства.

В Windows Server 2016 введено объединение встроенных коммутаторов (SET) в виртуальном коммутаторе Hyper-V. Это позволяет использовать одни и те же физические порты сетевого адаптера для всего сетевого трафика при использовании RDMA, уменьшая число необходимых портов физического сетевого адаптера. Для Локальные дисковые пространства рекомендуется объединение внедренных коммутаторов.

Взаимосвязи узлов с переключением и с переключением
- Переключение: Сетевые коммутаторы должны быть правильно настроены для работы с пропускной способностью и типом сети. Если используется RDMA, который реализует протокол Роце, сетевое устройство и Конфигурация коммутатора еще более важны.
- Без переключения: узлы могут быть взаимосоединены с помощью прямых подключений, избегая использования коммутатора. Необходимо, чтобы каждый узел имел прямое соединение со всеми остальными узлами кластера.

Инструкции по настройке сети для Локальные дисковые пространства см. в статье [Windows Server 2016, посвященной Объединенному сетевому адаптеру и средству развертывания RDMA в гостевой системе](https://github.com/Microsoft/SDN/blob/master/Diagnostics/S2D%20WS2016_ConvergedNIC_Configuration.docx).

## <a name="step-3-configure-storage-spaces-direct"></a>Шаг 3. Настройка локальных дисковых пространств

Следующие действия выполняются в системе управления, версия которой совпадает с версией настраиваемых серверов. Следующие шаги не должны запускаться удаленно с помощью сеанса PowerShell, а запускаются в локальном сеансе PowerShell в системе управления с разрешениями администратора.

### <a name="step-31-clean-drives"></a>Шаг 3,1. Очистка дисков

Перед включением Локальные дисковые пространства убедитесь, что диски пусты: нет старых разделов или других данных. Выполните следующий сценарий, заменив имена компьютеров, чтобы удалить все старые разделы или другие данные.

> [!Warning]
> Этот сценарий окончательно удаляет все данные на любых дисках, кроме загрузочного диска операционной системы.

```PowerShell
# Fill in these variables with your values
$ServerList = "Server01", "Server02", "Server03", "Server04"

Invoke-Command ($ServerList) {
    Update-StorageProviderCache
    Get-StoragePool | ? IsPrimordial -eq $false | Set-StoragePool -IsReadOnly:$false -ErrorAction SilentlyContinue
    Get-StoragePool | ? IsPrimordial -eq $false | Get-VirtualDisk | Remove-VirtualDisk -Confirm:$false -ErrorAction SilentlyContinue
    Get-StoragePool | ? IsPrimordial -eq $false | Remove-StoragePool -Confirm:$false -ErrorAction SilentlyContinue
    Get-PhysicalDisk | Reset-PhysicalDisk -ErrorAction SilentlyContinue
    Get-Disk | ? Number -ne $null | ? IsBoot -ne $true | ? IsSystem -ne $true | ? PartitionStyle -ne RAW | % {
        $_ | Set-Disk -isoffline:$false
        $_ | Set-Disk -isreadonly:$false
        $_ | Clear-Disk -RemoveData -RemoveOEM -Confirm:$false
        $_ | Set-Disk -isreadonly:$true
        $_ | Set-Disk -isoffline:$true
    }
    Get-Disk | Where Number -Ne $Null | Where IsBoot -Ne $True | Where IsSystem -Ne $True | Where PartitionStyle -Eq RAW | Group -NoElement -Property FriendlyName
} | Sort -Property PsComputerName, Count
```

Результат будет выглядеть следующим образом, где **Count** — это число дисков каждой модели на каждом сервере:

```
Count Name                          PSComputerName
----- ----                          --------------
4     ATA SSDSC2BA800G4n            Server01
10    ATA ST4000NM0033              Server01
4     ATA SSDSC2BA800G4n            Server02
10    ATA ST4000NM0033              Server02
4     ATA SSDSC2BA800G4n            Server03
10    ATA ST4000NM0033              Server03
4     ATA SSDSC2BA800G4n            Server04
10    ATA ST4000NM0033              Server04
```

### <a name="step-32-validate-the-cluster"></a>Шаг 3,2. Проверка кластера

На этом шаге вы запустите средство проверки кластера, чтобы убедиться, что узлы сервера правильно настроены для создания кластера с помощью Локальные дисковые пространства. При выполнении проверки кластера (`Test-Cluster`) перед созданием кластера выполняются тесты, которые проверяют, подходит ли конфигурация для успешной работы в качестве отказоустойчивого кластера. В приведенном ниже примере используется параметр `-Include`, а затем указываются конкретные категории тестов. Таким образом, в проверку будут включены тесты локальных дисковых пространств.

Используйте следующую команду PowerShell, чтобы проверить набор серверов для использования в качестве кластера локальных дисковых пространств.

```PowerShell
Test-Cluster –Node <MachineName1, MachineName2, MachineName3, MachineName4> –Include "Storage Spaces Direct", "Inventory", "Network", "System Configuration"
```

### <a name="step-33-create-the-cluster"></a>Шаг 3,3. Создание кластера

На этом шаге вы создадите кластер с узлами, которые были проверены для создания кластера на предыдущем шаге, с помощью следующего командлета PowerShell.

При создании кластера вы получите предупреждение о том, что возникли проблемы при создании кластерной роли, которая может препятствовать запуску. Для получения подробной информации просмотрите файл отчета ниже". Это предупреждение можно игнорировать. Оно появляется из-за того, что нет доступных дисков для кворума кластера. Рекомендуется настраивать файловый ресурс-свидетель или облако-свидетель после создания кластера.

> [!Note]
> Если для серверов используются статические IP-адреса, измените приведенную ниже команду, чтобы отразить статический IP-адрес. Для этого добавьте следующий параметр и укажите IP-адрес: –StaticAddress &lt;X.X.X.X&gt;.
> В следующей команде заполнитель ClusterName необходимо заменить на уникальное имя NetBIOS длиной до 15 символов.
> ```PowerShell
> New-Cluster –Name <ClusterName> –Node <MachineName1,MachineName2,MachineName3,MachineName4> –NoStorage
> ```

После создания кластера репликация записи DNS для имени кластера может занять некоторое время. Продолжительность времени зависит от среды и конфигурации репликации DNS. Если разрешение кластера не удалось выполнить, в большинстве случаев вместо имени кластера можно использовать имя компьютера узла, который является активным участником кластера.

### <a name="step-34-configure-a-cluster-witness"></a>Шаг 3,4. Настройка следящего сервера кластера

Рекомендуется настроить следящий сервер для кластера, поэтому кластеры с тремя или более серверами могут выдерживать сбои или автономные работы двух серверов. Для развертывания с двумя серверами требуется следящий сервер кластера. в противном случае сервер переходит в автономный режим и становится недоступным. В этих системах в качестве свидетеля можно использовать файловый ресурс или облако-свидетель. 

См. также следующие разделы:

- [Настройка кворума и управление им](../../failover-clustering/manage-cluster-quorum.md)
- [Развертывание облачного следящего сервера для отказоустойчивого кластера](../../failover-clustering/deploy-cloud-witness.md)

### <a name="step-35-enable-storage-spaces-direct"></a>Шаг 3.5. Включение локальных дисковых пространств

После создания кластера используйте командлет `Enable-ClusterStorageSpacesDirect` PowerShell, который переводит систему хранения в режим Локальные дисковые пространства и выполняет следующие действия автоматически:

-   **Создаст пул:** создаст один большой пул с именем, похожим на "S2D на Cluster1".

-   **Настроит кэши локальных дисковых пространств:** если для использования локальными дисковыми пространствами доступно более одного типа носителя (диска), он задает самые быстрые из них в качестве устройств кэша (в большинстве случаев для чтения и записи).

-   **Уровни:** Создает два уровня в качестве уровней по умолчанию. Один из них называется "Емкость", а другой — "Производительность". Командлет анализирует устройства и настраивает каждый уровень на основе типов устройств и устойчивости.

Из системы управления откройте командное окно PowerShell с правами администратора и запустите следующую команду. Нужно указать имя кластера, созданного при выполнении предыдущих действий. Если эта команда выполняется локально на одном из узлов, параметр -CimSession не требуется.

```PowerShell
Enable-ClusterStorageSpacesDirect –CimSession <ClusterName>
```

Чтобы включить локальные дисковые пространства с помощью указанной выше команды, вместо имени кластера можно использовать имя узла. Это может быть более надежным, так как при использовании имени только что созданного кластера могут возникнуть задержки репликации DNS.

После выполнения этой команды, которое может занять несколько минут, система будет готова для создания томов.

### <a name="step-36-create-volumes"></a>Шаг 3.6. Создание томов

Рекомендуется использовать командлет `New-Volume`, так как он обеспечивает самую быструю и простую работу. Этот командлет автоматически создает виртуальный диск, разбивает и форматирует его, создает том с соответствующим именем и добавляет его в общие тома кластера — и все это за один шаг.

Подробнее см. в разделе [Создание томов в локальных дисковых пространствах](create-volumes.md).

### <a name="step-37-optionally-enable-the-csv-cache"></a>Шаг 3,7. при необходимости включите кэш CSV

При необходимости можно включить кэш общего тома кластера (CSV) для использования системной памяти (ОЗУ) в качестве кэша на уровне блоков для операций чтения, которые еще не кэшированы диспетчером кэша Windows. Это может повысить производительность таких приложений, как Hyper-V. Кэш CSV может повысить производительность запросов на чтение и также полезен для масштабируемый файловый сервер сценариев.

Включение кэша CSV сокращает объем памяти, доступной для запуска виртуальных машин в кластере с поддержкой Hyper-in, поэтому необходимо сбалансировать производительность хранилища с использованием памяти, доступной для виртуальных жестких дисков.

Чтобы задать размер кэша CSV, откройте сеанс PowerShell в системе управления с учетной записью, обладающей разрешениями администратора в кластере хранения, а затем используйте этот сценарий, изменив `$ClusterName` и `$CSVCacheSize` переменные соответствующим образом (в этом примере задается кэш CSV размером 2 ГБ на сервер):

```PowerShell
$ClusterName = "StorageSpacesDirect1"
$CSVCacheSize = 2048 #Size in MB

Write-Output "Setting the CSV cache..."
(Get-Cluster $ClusterName).BlockCacheSize = $CSVCacheSize

$CSVCurrentCacheSize = (Get-Cluster $ClusterName).BlockCacheSize
Write-Output "$ClusterName CSV cache size: $CSVCurrentCacheSize MB"
```

Дополнительные сведения см. в разделе [использование кэша чтения в памяти CSV](csv-cache.md).

### <a name="step-38-deploy-virtual-machines-for-hyper-converged-deployments"></a>Шаг 3,8. Развертывание виртуальных машин для развертываний с поддержкой Hyper-in

Если вы развертываете кластер с поддержкой технологии Hyper-in, последний шаг состоит в подготовке виртуальных машин в кластере Локальные дисковые пространства.

Файлы виртуальной машины должны храниться в системном пространстве имен CSV (например, c:\\ClusterStorage\\Volume1) так же, как кластеризованные виртуальные машины в отказоустойчивых кластерах.

Для управления хранилищем и виртуальными машинами, такими как System Center Virtual Machine Manager, можно использовать встроенные средства или другие средства.

## <a name="step-4-deploy-scale-out-file-server-for-converged-solutions"></a>Шаг 4. Развертывание масштабируемый файловый сервер для Объединенных решений

Если вы развертываете решение для конвергенции, то следующим шагом является создание масштабируемый файловый сервер экземпляра и настройка некоторых файловых ресурсов. Если вы развертываете кластер с разделением Hyper-in, то все готово и не требуется этот раздел.

### <a name="step-41-create-the-scale-out-file-server-role"></a>Шаг 4,1. Создание роли масштабируемый файловый сервер

Следующим шагом при настройке служб кластеров для файлового сервера является создание роли кластеризованного файлового сервера, которая происходит при создании экземпляра масштабируемый файловый сервер, на котором размещаются постоянно доступные общие папки.

#### <a name="to-create-a-scale-out-file-server-role-by-using-server-manager"></a>Создание роли масштабируемый файловый сервер с помощью диспетчер сервера

1. В диспетчер отказоустойчивости кластеров выберите кластер, перейдите к **роли**и нажмите кнопку **настроить роль...** .<br>Откроется мастер высокой доступности.
2. На странице **Выбор роли** щелкните **файловый сервер**.
3. На странице **тип файлового сервера** щелкните **Масштабируемый файловый сервер для данных приложения**.
4. На странице **точка доступа клиента** введите имя Масштабируемый файловый сервер.
5. Убедитесь, что роль успешно настроена, выбрав **роли** и убедившись в том, что в столбце **состояние** отображается значение **работает** рядом с созданной ролью кластеризованного файлового сервера, как показано на рис. 1.

   ![Снимок экрана диспетчер отказоустойчивости кластеров отображения масштабируемый файловый сервер](media/Hyper-converged-solution-using-Storage-Spaces-Direct-in-Windows-Server-2016/SOFS_in_FCM.png "диспетчер отказоустойчивости кластеров отображения масштабируемый файловый сервер")

    **Рис. 1** диспетчер отказоустойчивости кластеров отображения масштабируемый файловый сервер с состоянием выполнения

> [!NOTE]
>  После создания кластерной роли могут возникать некоторые задержки при распространении сети, которые могут помешать созданию общих файловых ресурсов в течение нескольких минут или даже более длительных.  
  
#### <a name="to-create-a-scale-out-file-server-role-by-using-windows-powershell"></a>Создание роли масштабируемый файловый сервер с помощью Windows PowerShell

 В сеансе Windows PowerShell, подключенном к кластеру файлового сервера, введите следующие команды для создания роли масштабируемый файловый сервер, изменения *фсклустер* в соответствии с именем кластера и *SOFS* в соответствии с именем, которое нужно присвоить роли Масштабируемый файловый сервер:

```PowerShell
Add-ClusterScaleOutFileServerRole -Name SOFS -Cluster FSCLUSTER
```

> [!NOTE]
>  После создания кластерной роли могут возникать некоторые задержки при распространении сети, которые могут помешать созданию общих файловых ресурсов в течение нескольких минут или даже более длительных. Если роль SOFS сразу же завершается сбоем и не запускается, это может быть вызвано тем, что объект компьютера кластера не имеет разрешения на создание учетной записи компьютера для роли SOFS. Дополнительные сведения см. в этой записи блога: [не удается запустить роль Масштабируемый файловый сервер с идентификаторами событий 1205, 1069 и 1194](http://www.aidanfinn.com/?p=14142).

### <a name="step-42-create-file-shares"></a>Шаг 4,2. Создание файловых ресурсов

Создав виртуальные диски и добавив их в CSV, вы намерены создавать общие папки на одном общем файловом ресурсе на каждый виртуальный диск. System Center Virtual Machine Manager (VMM), вероятно, является хандиест способом, так как он обрабатывает разрешения для вас, но если у вас его нет в своей среде, можно использовать Windows PowerShell для частичной автоматизации развертывания.

Используйте скрипты, входящие в [конфигурацию общего ресурса SMB для сценария рабочих нагрузок Hyper-V](https://gallery.technet.microsoft.com/SMB-Share-Configuration-4a36272a) , который частично автоматизирует процесс создания групп и общих папок. Он написан для рабочих нагрузок Hyper-V, поэтому при развертывании других рабочих нагрузок может потребоваться изменить параметры или выполнить дополнительные действия после создания общих ресурсов. Например, если вы используете Microsoft SQL Server, учетной записи службы SQL Server необходимо предоставить полный доступ к общей папке и файловой системе.

> [!NOTE]
>  При добавлении узлов кластера необходимо обновить членство в группе, если вы не используете System Center Virtual Machine Manager для создания общих папок.

Чтобы создать файловые ресурсы с помощью скриптов PowerShell, выполните следующие действия.

1. Скачайте скрипты, входящие в [конфигурацию общего ресурса SMB для рабочих нагрузок Hyper-V](https://gallery.technet.microsoft.com/SMB-Share-Configuration-4a36272a) , на один из узлов кластера файлового сервера.
2. Откройте сеанс Windows PowerShell с учетными данными администратора домена в системе управления, а затем используйте следующий скрипт, чтобы создать группу Active Directory для объектов компьютеров Hyper-V, изменив значения переменных соответствующим образом для PXE

    ```PowerShell
    # Replace the values of these variables
    $HyperVClusterName = "Compute01"
    $HyperVObjectADGroupSamName = "Hyper-VServerComputerAccounts" <#No spaces#>
    $ScriptFolder = "C:\Scripts\SetupSMBSharesWithHyperV"

    # Start of script itself
    CD $ScriptFolder
    .\ADGroupSetup.ps1 -HyperVObjectADGroupSamName $HyperVObjectADGroupSamName -HyperVClusterName $HyperVClusterName
    ```
3. Откройте сеанс Windows PowerShell с учетными данными администратора на одном из узлов хранилища, а затем используйте следующий скрипт для создания общих ресурсов для каждого CSV-файла и предоставьте административные разрешения для общих ресурсов группе администраторов домена и кластеру вычислений.

    ```PowerShell
    # Replace the values of these variables
    $StorageClusterName = "StorageSpacesDirect1"
    $HyperVObjectADGroupSamName = "Hyper-VServerComputerAccounts" <#No spaces#>
    $SOFSName = "SOFS"
    $SharePrefix = "Share"
    $ScriptFolder = "C:\Scripts\SetupSMBSharesWithHyperV"

    # Start of the script itself
    CD $ScriptFolder
    Get-ClusterSharedVolume -Cluster $StorageClusterName | ForEach-Object
    {
        $ShareName = $SharePrefix + $_.SharedVolumeInfo.friendlyvolumename.trimstart("C:\ClusterStorage\Volume")
        Write-host "Creating share $ShareName on "$_.name "on Volume: " $_.SharedVolumeInfo.friendlyvolumename
        .\FileShareSetup.ps1 -HyperVClusterName $StorageClusterName -CSVVolumeNumber $_.SharedVolumeInfo.friendlyvolumename.trimstart("C:\ClusterStorage\Volume") -ScaleOutFSName $SOFSName -ShareName $ShareName -HyperVObjectADGroupSamName $HyperVObjectADGroupSamName
    }
    ```

### <a name="step-43-enable-kerberos-constrained-delegation"></a>Шаг 4,3. Включение ограниченного делегирования Kerberos

Чтобы настроить ограниченное делегирование Kerberos для удаленного управления сценариями и повысить уровень безопасности динамическая миграция, на одном из узлов кластера хранения используйте сценарий Ккдсетуп. ps1, входящий в [конфигурацию общего ресурса SMB для рабочих нагрузок Hyper-V](https://gallery.technet.microsoft.com/SMB-Share-Configuration-4a36272a). Вот небольшая оболочка для сценария:

```PowerShell
$HyperVClusterName = "Compute01"
$ScaleOutFSName = "SOFS"
$ScriptFolder = "C:\Scripts\SetupSMBSharesWithHyperV"

CD $ScriptFolder
.\KCDSetup.ps1 -HyperVClusterName $HyperVClusterName -ScaleOutFSName $ScaleOutFSName -EnableLM
```

## <a name="next-steps"></a>Следующие шаги

После развертывания кластеризованного файлового сервера рекомендуется протестировать производительность решения с помощью искусственных рабочих нагрузок, прежде чем приступать к реальным рабочим нагрузкам. Это позволяет убедиться, что решение работает правильно, и устранить все возможные проблемы, прежде чем добавлять сложность рабочих нагрузок. Дополнительные сведения см. в статье [Проверка производительности дисковых пространств с помощью искусственных рабочих нагрузок](https://technet.microsoft.com/library/dn894707.aspx).

## <a name="see-also"></a>См. также:

-   [Локальные дисковые пространства в Windows Server 2016](storage-spaces-direct-overview.md)
-   [Общие сведения о кэше в Локальные дисковые пространства](understand-the-cache.md)
-   [Планирование томов в Локальные дисковые пространства](plan-volumes.md)
-   [Отказоустойчивость дисковых пространств](storage-spaces-fault-tolerance.md)
-   [Требования к оборудованию Локальные дисковые пространства](Storage-Spaces-Direct-Hardware-Requirements.md)
-   [В RDMA или не в RDMA — вот в чем вопрос](https://blogs.technet.microsoft.com/filecab/2017/03/27/to-rdma-or-not-to-rdma-that-is-the-question/) (блог TechNet)
