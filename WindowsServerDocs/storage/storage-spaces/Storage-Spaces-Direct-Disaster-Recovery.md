---
title: Сценарии аварийного восстановления для инфраструктуры с технологией Hyper-in
ms.prod: windows-server
ms.manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: johnmarlin-msft
ms.date: 03/29/2018
description: В этой статье описываются сценарии, доступные сегодня для аварийного восстановления Microsoft ХЦИ (Локальные дисковые пространства).
ms.localizationpriority: medium
ms.openlocfilehash: 8e6372ec7b4759f672c13f4bd822172afaf3faf3
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71393750"
---
# <a name="disaster-recovery-with-storage-spaces-direct"></a>Аварийное восстановление с помощью Локальные дисковые пространства

> Относится к: Windows Server 2019, Windows Server 2016

В этом разделе приводятся сценарии, в которых можно настроить инфраструктуру Hyper-ХЦИ для аварийного восстановления.

Многие компании используют решения с технологией Hyper-in, и планирование аварийного восстановления позволяет быстро остаться в рабочей среде или вернуться к ней в случае аварии. Существует несколько способов настройки ХЦИ для аварийного восстановления, и в этом документе объясняются доступные в настоящее время параметры.

При возникновении проблем с восстановлением доступности в случае сбоя, известного как целевое время восстановления (RTO). Это длительность времени, в течение которого следует восстанавливать службы, чтобы избежать неприемлемых последствий для бизнеса. В некоторых случаях этот процесс может выполняться автоматически при восстановлении рабочей среды. В других случаях для восстановления служб необходимо ручное вмешательство администратора.

Ниже приведены варианты аварийного восстановления с поддержкой Hyper-in.

1. Несколько кластеров, использующих реплику хранилища
2. Реплика Hyper-V между кластерами
3. Резервное копирование и восстановление

## <a name="multiple-clusters-utilizing-storage-replica"></a>Несколько кластеров, использующих реплику хранилища

[Реплика хранилища](../storage-replica/storage-replica-overview.md) позволяет выполнять репликацию томов и поддерживает как синхронную, так и асинхронную репликацию. При выборе между использованием синхронной или асинхронной репликации следует учитывать целевую точку восстановления (RPO). Цель точки восстановления — это объем возможной потери данных, прежде чем она будет считаться крупной потерей. Если вы перейдете в синхронную репликацию, она будет последовательно записываться в обе конечные точки. При использовании асинхронной операции записи будут реплицироваться очень быстро, но все равно могут быть потеряны. Следует рассмотреть возможность использования приложения или файла, чтобы узнать, какая из них подходит вам.

Реплика хранилища — это механизм копирования на уровне блоков и файлов; Это значит, что не имеет значения, какие типы данных реплицируются. Это делает ее популярным вариантом для инфраструктуры с технологией Hyper-in. Реплика хранилища также может использовать различные типы дисков между партнерами репликации, так что все хранилища типов на одном ХЦИ, а другое хранилище типов — вполне хорошо. 

Одна из важных возможностей реплики хранилища заключается в том, что ее можно запускать в Azure, а также локально. Локальную среду можно настроить в локальной среде, Azure — в Azure или даже локально в Azure (или наоборот).

В этом сценарии существует два отдельных независимых кластера. Чтобы настроить реплику хранилища между ХЦИ, выполните действия, описанные в разделе [репликация кластера в кластер](../storage-replica/cluster-to-cluster-storage-replication.md).

![Диаграмма репликации хранилища](media/storage-spaces-direct-disaster-recovery/Disaster-Recovery-Figure1.png)

При развертывании реплики хранилища необходимо учитывать следующие моменты. 

1.  Настройка репликации выполняется за пределами отказоустойчивой кластеризации. 
2.  Выбор способа репликации будет зависеть от требований к сети и RPO. Синхронная репликация данных в сетях с низкой задержкой с согласованностью сбоев для обеспечения потери данных во время сбоя. Асинхронная репликация данных по сетям с большими задержками, но на каждом сайте могут быть не одинаковые копии в момент сбоя. 
3.  В случае аварии отработка отказа между кластерами не выполняется автоматически и их необходимо вручную организовать с помощью командлетов PowerShell реплики хранилища. На приведенной выше схеме Cluster a является основным, а Клустерб — дополнительным. Если кластер a выходит из строя, необходимо вручную задать Клустерб в качестве основного, прежде чем можно будет перенести ресурсы. После резервного копирования кластера необходимо сделать его дополнительным. После синхронизации всех данных внесите изменения и переключайте роли в исходное значение.
4.  Так как реплика хранилища реплицирует только данные, необходимо создать новую виртуальную машину или Scale Out файловый сервер (SOFS), использующий эти данные, в диспетчер отказоустойчивости кластеров на партнере реплики.

Реплику хранилища можно использовать при наличии виртуальных машин или SOFS, работающих в кластере. Перевод ресурсов в оперативный режим в реплике ХЦИ можно выполнять вручную или автоматически с помощью сценариев PowerShell.

## <a name="hyper-v-replica"></a>реплика Hyper-V;

[Реплика Hyper-V](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/set-up-hyper-v-replica) обеспечивает репликацию на уровне виртуальных машин для аварийного восстановления в инфраструктурах с согласованием. Что может сделать реплика Hyper-V — взять виртуальную машину и реплицировать ее на дополнительный сайт или Azure (реплика). Затем с вторичного сайта реплика Hyper-V может реплицировать виртуальную машину на третью (расширенную реплику).

![Схема репликации Hyper-V](media/storage-spaces-direct-disaster-recovery/Disaster-Recovery-Figure2.png)

При использовании реплики Hyper-V репликация осуществляется с помощью Hyper-V. При первом включении виртуальной машины для репликации существует три варианта отправки начальной копии в соответствующие кластеры реплики.

1.  Отправить начальную копию по сети
2.  Отправить начальную копию на внешний носитель, чтобы ее можно было скопировать на сервер вручную
3.  Использовать существующую виртуальную машину, уже созданную на узлах реплик

Другой вариант — для, если вы хотите, чтобы начальная репликация была выполнена.

1.  Немедленно запустить репликацию
2.  Запланируйте время, когда будет выполнена начальная репликация. 

Другие соображения, которые вам понадобятся:

- Какие VHD или VHDX вы хотите реплицировать. Можно выбрать репликацию всех или только одного из них.
- Число точек восстановления, которые вы хотите сохранить. Если вы хотите получить несколько параметров о том, какой момент времени вы хотите восстановить, укажите нужное количество. Если требуется только одна точка восстановления, можно также выбрать ее.
- Как часто требуется, чтобы служба теневого копирования томов (VSS) реплицирует добавочную теневую копию.
- Частота репликации изменений (30 секунд, 5 минут, 15 минут).

Когда ХЦИ участвует в реплике Hyper-V, необходимо создать ресурс [брокера реплики Hyper-v](https://blogs.technet.microsoft.com/virtualization/2012/03/27/why-is-the-hyper-v-replica-broker-required/) в каждом кластере. Этот ресурс выполняет несколько задач:

1.  Предоставляет одно пространство имен для каждого кластера, к которому будет подключаться реплика Hyper-V.
2.  Определяет, на каком узле в кластере будет размещаться реплика (или Расширенная реплика) при первой получении копии.
3.  Отслеживает, какой узел владеет репликой (или расширенной репликой) на случай, если виртуальная машина перемещается на другой узел. Он должен отслеживанию этого, чтобы при репликации можно было отправить сведения на соответствующий узел.

## <a name="backup-and-restore"></a>Резервное копирование и восстановление

Одним традиционным вариантом аварийного восстановления, который не говорил о очень многом, является сбой всего кластера или узла в кластере. Любой из вариантов использования этого сценария использует резервное копирование Windows NT. 

Всегда рекомендуется создавать периодические резервные копии инфраструктуры с технологией Hyper-in. Если служба кластеров запущена, то при создании резервной копии состояния системы база данных реестра кластера будет частью этой резервной копии. Восстановление кластера или базы данных имеет два разных метода (неполномочный и Полномочный).

### <a name="non-authoritative"></a>Не заслуживающий доверия

Неполномочное восстановление можно выполнить с помощью резервного копирования Windows NT и соответствует полному восстановлению только самого узла кластера. Если требуется восстановить только узел кластера (и базу данных реестра кластера), а все текущие сведения о кластере хорошо, вы восстановитесь с помощью неполномочного. Неполномочное восстановление можно выполнить с помощью интерфейса Windows NT Backup или командной строки WBADMIN. Программы.

После восстановления узла разрешите его присоединение к кластеру. Что произойдет, это приведет к выполнению работы с существующим кластером и обновлению всех его данных с учетом того, что в данный момент есть.

### <a name="authoritative"></a>Заслуживающего

При полномочном восстановлении конфигурации кластера, с другой стороны, выполняется обратное восстановление конфигурации кластера. Такой тип восстановления следует выполнять только в том случае, если сведения о кластере потеряны и необходимо восстановить. Например, кто-то случайно удалил файловый сервер, содержащий более 1000 общих ресурсов, и вам потребуется его восстановить. Для выполнения полномочного восстановления кластера необходимо запустить резервное копирование из командной строки.

При запуске полномочного восстановления на узле кластера служба кластеров останавливается на всех остальных узлах в представлении кластера, а конфигурация кластера замораживается. Поэтому важно сначала запустить службу кластеров на узле, на котором выполнялось восстановление, чтобы создать кластер с использованием новой копии конфигурации кластера.

Для выполнения принудительного восстановления можно выполнить следующие действия.

1.  Запустите WBADMIN. EXE из командной строки администратора, чтобы получить последнюю версию резервных копий, которую необходимо установить, и убедиться, что состояние системы является одним из компонентов, которые можно восстановить.

    ```powershell
    Wbadmin get versions
    ```

2.  Определите, есть ли в качестве компонента резервная копия версии, в которой находятся данные реестра кластера. В этой команде потребуется несколько элементов, а также версию и приложение/компонент для использования на шаге 3. Например, предположим, что резервная копия была выполнена 3 января 2018 по адресу 2:04am. Это означает, что вы хотите восстановить.

    ```powershell
    wbadmin get items -backuptarget:\\backupserver\location
    ```

3.  Запустите полномочное восстановление, чтобы восстановить только необходимую версию реестра кластера. 

    ```powershell
    wbadmin start recovery -version:01/03/2018-02:04 -itemtype:app -items:cluster
    ```

После восстановления этот узел должен быть первым, чтобы сначала запустить службу кластеров, а затем сформировать кластер. Затем все остальные узлы должны быть запущены и присоединены к кластеру.

## <a name="summary"></a>Сводка 

Чтобы просуммировать это, следует тщательно выработать аварийное восстановление с технологией Hyper-in. Существует несколько сценариев, которые лучше всего подходят для удовлетворения ваших потребностей и должны быть тщательно протестированы. Обратите внимание, что если вы знакомы с отказоустойчивыми кластерами в прошлом, растянутые кластеры были очень популярными в течение многих лет. Было внесено несколько изменений в проект с помощью решения с поддержкой технологии Hyper-baseding, и он основан на устойчивости. Если вы потеряли два узла в кластере с разделением Hyper-in, весь кластер будет отключен. В таком случае в среде с технологией переноса не поддерживается сценарий растяжения.


