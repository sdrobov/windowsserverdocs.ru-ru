---
title: Настройка параметров производительности контейнеров Windows Server
description: Рекомендации по настройке параметров производительности для контейнеров в Windows Server 16
ms.prod: windows-server-threshold
ms.technology: performance-tuning-guide
ms.topic: landing-page
ms.author: DavSo; Ericam; YaShi
author: akino
ms.date: 10/16/2017
ms.openlocfilehash: 072d71a7825907ada7d4bc02eb5390722692e81d
ms.sourcegitcommit: 02f1e11ba37a83e12d8ffa3372e3b64b20d90d00
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/09/2019
ms.locfileid: "68863422"
---
# <a name="performance-tuning-windows-server-containers"></a>Настройка параметров производительности контейнеров Windows Server

## <a name="introduction"></a>Введение
Windows Server 2016 — это первая версия ОС Windows со встроенной поддержкой технологии контейнеров. В Windows Server 2016 доступны два типа контейнеров: контейнеры Windows Server и контейнеры Hyper-V. Каждый тип поддерживает номера SKU Server Core и или Nano Server Windows Server 2016. 

Эти конфигурации по-разному влияют на производительность. Мы подробно рассмотрим их, чтобы вы могли выбрать подходящий вариант для своих сценариев. Кроме того, мы подробно опишем конфигурации, влияющие на производительность, и компромиссные решения с использованием каждого из этих вариантов.

### <a name="windows-server-container-and-hyper-v-containers"></a>Контейнеры Windows Server и контейнеры Hyper-V

Контейнер Windows Server и контейнеры Hyper-V предоставляют сходные возможности, предоставляющие сходные возможности переносимости и согласованности. Но они отличаются в контексте гарантий изоляции и показателей производительности.

**Контейнеры Windows Server** обеспечивают изоляцию приложений используя соответствующую технологию в отношении процессов и пространств имен. Контейнер Windows Server использует ядро совместно с узлом контейнера и всеми остальными контейнерами на этом узле.

**Контейнеры Hyper-V** расширяют возможности изоляции, предоставляемые контейнерами Windows Server, ведь каждый контейнер запускается в высокооптимизированной виртуальной машине. В этой конфигурации ядро узла контейнера не используется совместно с контейнерами Hyper-V.

Дополнительная изоляция, предоставляемая контейнерами Hyper-V, во многом достигается благодаря предоставляемому гипервизором уровню изоляции между контейнером и узлом контейнера. Это влияет на плотность контейнеров (в отличие от контейнеров Windows Server системные и двоичные файлы используются совместно в меньшей степени), увеличивая общий объем хранилища и памяти. Кроме того, использование некоторых режимов использования сети, операций ввода-вывода для хранилища и ЦП может быть сопряжено с дополнительными издержками.

### <a name="nano-server-and-server-core"></a>Server Core и Nano Server

Контейнеры Windows Server и контейнеры Hyper-V поддерживают Server Core, а для нового режима установки, доступного в Windows Server 2016, еще и [Nano Server](https://technet.microsoft.com/windows-server-docs/compute/nano-server/getting-started-with-nano-server). 

Nano Server: это удаленно управляемая серверная ОС, оптимизированная для частных облаков и центров обработки данных. Этот вариант аналогичен Windows Server в режиме основных серверных компонентов, однако значительно меньше по размеру, не имеет функций локального входа и поддерживает только 64-разрядные приложения, средства и агенты. Он занимает гораздо меньше места на диске и запускается быстрее.

## <a name="container-start-up-time"></a>Время запуска контейнера
Время запуска контейнера является важнейшей метрикой во многих ситуациях, когда использование контейнеров является неоспоримым преимуществом. Крайне важно понимать, как можно ускорить запуск контейнера, поэтому ниже описаны некоторые компромиссные решения.

### <a name="first-logon"></a>Первый вход в систему

Корпорация Майкрософт предоставляет базовый образ для Nano Server и Server Core. Базовый образ для Server Core оптимизирован путем устранения издержек при запуске, связанных с первым входом в систему (запуск при первом включении компьютера). Для базового образа Nano Server такая оптимизация не применялась. Но эти издержки можно устранить и в образах на основе Nano Server, зафиксировав хотя бы один слой в образе контейнера. В этом случае при последующих запусках контейнера из образа не будет использоваться столько ресурсов, как при первом запуске.
### <a name="scratch-space-location"></a>Расположение области для временных файлов

По умолчанию контейнеры используют область на системном диске узла контейнера для хранения временных файлов во время существования запущенного контейнера. Эта область выполняет роль системного диска контейнера, потому к ней обращаются очень многие операции записи и чтения в контейнере. Если система узла использует системный диск на вращающемся магнитом носителе (HDD), но располагает и более быстрым носителем для хранения данных (быстрый HDD или любой SSD), вы можете переместить область для временных файлов на другой диск. Для этого примените команду dockerd –g. Эта команда имеет глобальный охват, влияя на все запущенные в системе контейнеры.

### <a name="nested-hyper-v-containers"></a>Вложенные контейнеры Hyper-V
В Hyper-V для Windows Server 2016 добавлена поддержка вложенных гипервизоров. Теперь вы можете запустить виртуальную машину внутри другой виртуальной машины. Это позволяет реализовать множество полезных сценариев, но одновременно и усиливает влияние гипервизоров на производительность, ведь на физическом узле работает сразу два уровня гипервизоров.

Для контейнеров это важно, когда контейнер Hyper-V работает внутри виртуальной машины. Контейнер Hyper-V обеспечивает изоляцию на уровне гипервизора между собой и узлом контейнера, а узел контейнера представляет собой виртуальную машину на основе Hyper-V. Поэтому наблюдается снижение производительности, связанное с временем запуска контейнера, операциями ввода-вывода хранилища и сети, пропускной способностью сети и производительностью ЦП.

## <a name="storage"></a>Хранилище
### <a name="mounted-data-volumes"></a>Подключенные тома данных

Контейнеры позволяют использовать системный диск узла контейнера для размещения области временных файлов контейнера. Но срок жизни файлов в этой области совпадает со сроком жизни контейнера. Это означает, что область временных файлов и все данные в ней очищаются при остановке контейнера.

Но во многих сценариях требуется сохранять данные независимо от времени существования контейнера. Для таких ситуаций мы реализовали возможность подключения к контейнеру томов данных из узла контейнера. Для контейнеров Windows Server использование подключенных томов данных незначительно влияет на операции ввода-вывода (производительность соответствует внутренним показателям). Но при подключении томов данных к контейнерам Hyper-V в этом режиме наблюдается некоторое снижение производительности. Более того, это влияние усиливается при работе контейнеров Hyper-V внутри виртуальных машин.

### <a name="scratch-space"></a>Область временных файлов

Контейнеры Windows Server и контейнеры Hyper-V предоставляют динамический виртуальный жесткий диск объемом 20 ГБ в качестве области временных файлов контейнера по умолчанию. В контейнерах обоих типов часть этой области занимает ОС контейнера, и это справедливо для каждого запущенного контейнера. Поэтому важно помнить, что каждый запущенный контейнер занимает часть физического хранилища и в зависимости от рабочей нагрузки может использовать для записи до 20 ГБ. Это следует учитывать при планировании конфигураций хранилища для сервера.
(Можно ли настроить размер области временных файлов?)

## <a name="networking"></a>Сеть
Контейнеры Windows Server и контейнеры Hyper-V предоставляют несколько разных сетевых режимов, позволяя выбрать наиболее подходящий для разных сетевых конфигураций. Каждый из этих режимов оказывает определенное влияние на производительность.

### <a name="windows-network-address-translation-winnat"></a>Преобразование сетевых адресов Windows (WinNAT)

Каждый контейнер получает IP-адрес из внутреннего частного пространства IP-адресов (например, 172.16.0.0/12). Перенаправление и сопоставление портов из узла контейнера в конечные точки контейнера поддерживается. При первом запуске dockerd подсистема Docker создает сеть NAT.

Из этих трех режимов конфигурация NAT больше других влияет на операции сетевого ввода-вывода, но требует меньшего объема настроек. 

Для подключения к виртуальному коммутатору контейнеры Windows Server используют виртуальный сетевой адаптер узла. Для подключения к виртуальному коммутатору контейнеры Hyper-V используют сетевой адаптер синтетической виртуальной машины (не предоставляется служебной виртуальной машине). Когда контейнеры обмениваются данными с внешней сетью, пакеты направляются через WinNAT с применением преобразования адресов, что влечет за собой дополнительные издержки.

### <a name="transparent"></a>Прозрачный режим

Каждая конечная точка контейнера подключена напрямую к физической сети. IP-адреса из физической сети могут назначаться статически или динамически с помощью внешнего DHCP-сервера.

Прозрачный режим наиболее экономичен с точки зрения сетевого ввода-вывода, так как внешние пакеты передаются напрямую на виртуальный сетевой адаптер контейнера, предоставляя прямой доступ к внешней сети.

### <a name="l2-bridge"></a>Мост второго уровня
Каждая конечная точка контейнера будет находиться в той же IP-подсети, что и узел контейнера. IP-адреса должны назначаться статически из того же префикса, что и узел контейнера. Все конечные точки контейнера на узле будут иметь одинаковый MAC-адрес из-за преобразования адресов второго уровня.

Режим моста второго уровня обеспечивает более высокую производительность, чем режим WinNAT, так как он предоставляет прямой доступ к внешней сети. При этом его производительность ниже по сравнению с прозрачным режимом, так как выполняется преобразование MAC-адресов.




